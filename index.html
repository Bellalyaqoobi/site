<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>اسنپ افغانستان - تاکسی اینترنتی کابل</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        :root {
            --primary: #00D474;
            --primary-dark: #00B562;
            --primary-light: #80EAB9;
            --secondary: #6C63FF;
            --accent: #FF6584;
            --light: #F8F9FA;
            --dark: #1A1A2E;
            --gray: #6c757d;
            --border: #E8EAF6;
            --shadow: 0 10px 30px rgba(0, 0, 0, 0.08);
            --radius: 16px;
            --afghan-red: #D32011;
            --afghan-black: #000000;
            --afghan-green: #00D474;
            --gradient-primary: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
            --gradient-dark: linear-gradient(135deg, var(--dark) 0%, #16213E 100%);
            --gradient-accent: linear-gradient(135deg, var(--accent) 0%, #FF9A9E 100%);
        }

        body {
            background-color: #F5F7FF;
            color: var(--dark);
            line-height: 1.6;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 0 20px;
            width: 100%;
        }

        /* صفحه خوشآمدگویی */
        .welcome-page {
            background: var(--gradient-dark);
            color: white;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            text-align: center;
            padding: 20px;
            position: relative;
            overflow: hidden;
        }

        .welcome-page::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: 
                radial-gradient(circle at 20% 80%, rgba(108, 99, 255, 0.1) 0%, transparent 50%),
                radial-gradient(circle at 80% 20%, rgba(0, 212, 116, 0.1) 0%, transparent 50%),
                radial-gradient(circle at 40% 40%, rgba(255, 101, 132, 0.05) 0%, transparent 50%);
            z-index: 0;
        }

        .welcome-content {
            max-width: 900px;
            margin: 0 auto;
            position: relative;
            z-index: 1;
        }

        .welcome-logo {
            font-size: 52px;
            margin-bottom: 25px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 20px;
            animation: float 3s ease-in-out infinite;
        }

        @keyframes float {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }

        .welcome-logo i {
            color: var(--primary);
            font-size: 64px;
            filter: drop-shadow(0 4px 12px rgba(0, 212, 116, 0.3));
        }

        .welcome-title {
            font-size: 48px;
            margin-bottom: 20px;
            font-weight: 800;
            background: var(--gradient-primary);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            text-shadow: 0 2px 10px rgba(0, 212, 116, 0.1);
        }

        .welcome-subtitle {
            font-size: 24px;
            margin-bottom: 40px;
            opacity: 0.9;
            font-weight: 300;
            letter-spacing: 0.5px;
        }

        .welcome-features {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 25px;
            margin: 50px 0;
        }

        .feature-card {
            background: rgba(255, 255, 255, 0.08);
            padding: 30px;
            border-radius: 20px;
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
        }

        .feature-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: var(--gradient-primary);
            transform: translateX(-100%);
            transition: transform 0.6s ease;
        }

        .feature-card:hover {
            transform: translateY(-8px) scale(1.02);
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.2);
            background: rgba(255, 255, 255, 0.12);
        }

        .feature-card:hover::before {
            transform: translateX(0);
        }

        .feature-icon {
            font-size: 42px;
            margin-bottom: 20px;
            color: var(--primary);
            background: rgba(0, 212, 116, 0.1);
            width: 70px;
            height: 70px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: all 0.3s;
        }

        .feature-card:hover .feature-icon {
            transform: scale(1.1) rotate(5deg);
            background: rgba(0, 212, 116, 0.2);
        }

        .feature-title {
            font-size: 22px;
            margin-bottom: 12px;
            font-weight: 600;
        }

        .feature-desc {
            font-size: 16px;
            opacity: 0.8;
            line-height: 1.8;
        }

        .welcome-actions {
            margin-top: 50px;
            display: flex;
            gap: 20px;
            justify-content: center;
            flex-wrap: wrap;
        }

        .btn-welcome {
            padding: 18px 40px;
            font-size: 18px;
            border-radius: 50px;
            font-weight: 600;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            min-width: 200px;
            position: relative;
            overflow: hidden;
        }

        .btn-welcome::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 5px;
            height: 5px;
            background: rgba(255, 255, 255, 0.5);
            opacity: 0;
            border-radius: 100%;
            transform: scale(1, 1) translate(-50%);
            transform-origin: 50% 50%;
        }

        .btn-welcome:hover::after {
            animation: ripple 1s ease-out;
        }

        @keyframes ripple {
            0% {
                transform: scale(0, 0);
                opacity: 0.5;
            }
            100% {
                transform: scale(40, 40);
                opacity: 0;
            }
        }

        .btn-welcome-primary {
            background: var(--gradient-primary);
            color: white;
            box-shadow: 0 10px 30px rgba(0, 212, 116, 0.3);
        }

        .btn-welcome-primary:hover {
            transform: translateY(-3px) scale(1.05);
            box-shadow: 0 15px 40px rgba(0, 212, 116, 0.4);
        }

        .btn-welcome-outline {
            background: transparent;
            border: 2px solid white;
            color: white;
        }

        .btn-welcome-outline:hover {
            background: white;
            color: var(--dark);
            transform: translateY(-3px) scale(1.05);
        }

        /* هدر */
        header {
            background: var(--gradient-dark);
            box-shadow: 0 4px 30px rgba(0, 0, 0, 0.1);
            position: sticky;
            top: 0;
            z-index: 1000;
            backdrop-filter: blur(10px);
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .nav-container {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 0;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 12px;
            font-size: 22px;
            font-weight: 700;
            color: white;
            text-decoration: none;
            transition: all 0.3s;
        }

        .logo:hover {
            transform: translateY(-2px);
        }

        .logo i {
            font-size: 28px;
            color: var(--primary);
            background: rgba(0, 212, 116, 0.1);
            width: 44px;
            height: 44px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 12px;
        }

        .nav-links {
            display: flex;
            list-style: none;
            gap: 30px;
        }

        .nav-links a {
            text-decoration: none;
            color: white;
            font-weight: 500;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 15px;
            padding: 8px 16px;
            border-radius: 12px;
            position: relative;
            overflow: hidden;
        }

        .nav-links a::before {
            content: '';
            position: absolute;
            bottom: 0;
            left: 50%;
            width: 0;
            height: 2px;
            background: var(--primary);
            transition: all 0.3s;
            transform: translateX(-50%);
        }

        .nav-links a:hover {
            background: rgba(255, 255, 255, 0.05);
        }

        .nav-links a:hover::before {
            width: 80%;
        }

        .nav-links a.active {
            background: rgba(0, 212, 116, 0.1);
            color: var(--primary);
        }

        .nav-links a.active::before {
            width: 80%;
        }

        .user-actions {
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .user-profile {
            display: flex;
            align-items: center;
            gap: 12px;
            color: white;
            cursor: pointer;
            padding: 8px 16px;
            border-radius: 12px;
            transition: all 0.3s;
        }

        .user-profile:hover {
            background: rgba(255, 255, 255, 0.05);
        }

        .user-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: var(--gradient-primary);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
            font-size: 16px;
            box-shadow: 0 4px 12px rgba(0, 212, 116, 0.3);
        }

        .user-name {
            font-weight: 500;
            font-size: 15px;
        }

        .btn {
            padding: 10px 24px;
            border-radius: 12px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s;
            border: none;
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 15px;
        }

        .btn-primary {
            background: var(--gradient-primary);
            color: white;
            box-shadow: 0 4px 15px rgba(0, 212, 116, 0.2);
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0, 212, 116, 0.3);
        }

        .btn-outline {
            background: transparent;
            border: 1px solid rgba(255, 255, 255, 0.3);
            color: white;
        }

        .btn-outline:hover {
            background: rgba(255, 255, 255, 0.05);
            border-color: rgba(255, 255, 255, 0.5);
        }

        /* منوی همبرگر */
        .hamburger {
            display: none;
            flex-direction: column;
            cursor: pointer;
            gap: 5px;
            z-index: 1001;
            padding: 10px;
        }

        .hamburger span {
            width: 28px;
            height: 3px;
            background: white;
            border-radius: 2px;
            transition: all 0.3s;
        }

        .hamburger.active span:nth-child(1) {
            transform: rotate(45deg) translate(6px, 6px);
        }

        .hamburger.active span:nth-child(2) {
            opacity: 0;
        }

        .hamburger.active span:nth-child(3) {
            transform: rotate(-45deg) translate(6px, -6px);
        }

        /* منوی موبایل */
        .mobile-menu {
            position: fixed;
            top: 0;
            right: -320px;
            width: 300px;
            height: 100%;
            background: var(--gradient-dark);
            box-shadow: -5px 0 30px rgba(0, 0, 0, 0.2);
            z-index: 1000;
            transition: right 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            padding: 20px;
            overflow-y: auto;
        }

        .mobile-menu.active {
            right: 0;
        }

        .mobile-menu-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 40px;
            padding-bottom: 20px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .mobile-menu-logo {
            display: flex;
            align-items: center;
            gap: 12px;
            font-size: 20px;
            font-weight: 700;
            color: white;
        }

        .mobile-menu-logo i {
            color: var(--primary);
            font-size: 24px;
        }

        .close-menu {
            background: none;
            border: none;
            font-size: 28px;
            cursor: pointer;
            color: white;
            opacity: 0.7;
            transition: opacity 0.3s;
        }

        .close-menu:hover {
            opacity: 1;
        }

        .mobile-nav-links {
            list-style: none;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .mobile-nav-links a {
            text-decoration: none;
            color: white;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 15px 20px;
            border-radius: 12px;
            transition: all 0.3s;
            font-size: 16px;
        }

        .mobile-nav-links a:hover,
        .mobile-nav-links a.active {
            background: rgba(0, 212, 116, 0.1);
            color: var(--primary);
        }

        .mobile-nav-links a i {
            width: 24px;
            text-align: center;
            font-size: 18px;
        }

        .mobile-user-actions {
            margin-top: 40px;
            display: flex;
            flex-direction: column;
            gap: 15px;
            padding: 20px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 16px;
        }

        .overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(5px);
            z-index: 999;
            display: none;
            opacity: 0;
            transition: opacity 0.3s;
        }

        .overlay.active {
            display: block;
            opacity: 1;
        }

        /* نقشه اصلی */
        .map-container {
            background: white;
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            overflow: hidden;
            height: 600px;
            position: relative;
            border: 1px solid var(--border);
        }

        #map {
            width: 100%;
            height: 100%;
            z-index: 1;
        }

        /* پنل درخواست سفر */
        .ride-panel {
            background: white;
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            padding: 25px;
            height: fit-content;
            border: 1px solid var(--border);
            position: sticky;
            top: 100px;
        }

        .panel-title {
            font-size: 20px;
            margin-bottom: 25px;
            color: var(--dark);
            display: flex;
            align-items: center;
            gap: 12px;
            padding-bottom: 15px;
            border-bottom: 2px solid var(--border);
        }

        .panel-title i {
            color: var(--primary);
            background: rgba(0, 212, 116, 0.1);
            width: 44px;
            height: 44px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 12px;
        }

        /* فرم درخواست تاکسی */
        .ride-form {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .form-group label {
            font-weight: 600;
            color: var(--dark);
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .input-with-icon {
            position: relative;
        }

        .form-input {
            padding: 15px 20px 15px 50px;
            border: 2px solid var(--border);
            border-radius: 12px;
            font-size: 16px;
            transition: all 0.3s;
            width: 100%;
            background: white;
        }

        .form-input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(0, 212, 116, 0.1);
        }

        .input-icon {
            position: absolute;
            left: 20px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--gray);
            font-size: 18px;
            transition: color 0.3s;
        }

        .form-input:focus + .input-icon {
            color: var(--primary);
        }

        .location-swap {
            display: flex;
            justify-content: center;
            margin: 10px 0;
        }

        .swap-btn {
            background: var(--light);
            border: none;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            color: var(--gray);
            transition: all 0.3s;
            font-size: 16px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .swap-btn:hover {
            background: var(--primary);
            color: white;
            transform: rotate(180deg);
        }

        /* انتخاب نوع سفر */
        .ride-type-selector {
            display: flex;
            flex-direction: column;
            gap: 12px;
            margin: 20px 0;
        }

        .ride-type {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 18px;
            border: 2px solid var(--border);
            border-radius: 16px;
            cursor: pointer;
            transition: all 0.3s;
            position: relative;
            overflow: hidden;
        }

        .ride-type::before {
            content: '';
            position: absolute;
            top: 0;
            right: 0;
            width: 4px;
            height: 0;
            background: var(--primary);
            transition: height 0.3s;
        }

        .ride-type:hover {
            border-color: var(--primary);
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0, 212, 116, 0.1);
        }

        .ride-type.selected {
            border-color: var(--primary);
            background: linear-gradient(135deg, rgba(0, 212, 116, 0.05) 0%, rgba(108, 99, 255, 0.05) 100%);
        }

        .ride-type.selected::before {
            height: 100%;
        }

        .ride-type-info {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .ride-icon {
            width: 44px;
            height: 44px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 18px;
            flex-shrink: 0;
            transition: all 0.3s;
        }

        .economy .ride-icon {
            background: var(--gradient-primary);
        }

        .comfort .ride-icon {
            background: var(--gradient-dark);
        }

        .bike .ride-icon {
            background: var(--gradient-accent);
        }

        .ride-details h3 {
            font-size: 16px;
            margin-bottom: 5px;
            font-weight: 600;
        }

        .ride-details p {
            font-size: 13px;
            color: var(--gray);
        }

        .ride-price {
            font-weight: 700;
            color: var(--dark);
            text-align: left;
            font-size: 16px;
            min-width: 100px;
        }

        .price-estimate {
            font-size: 12px;
            color: var(--gray);
            margin-top: 4px;
            font-weight: normal;
        }

        /* معلومات مسافت و قیمت */
        .trip-calculator {
            background: linear-gradient(135deg, rgba(0, 212, 116, 0.05) 0%, rgba(108, 99, 255, 0.05) 100%);
            padding: 20px;
            border-radius: 16px;
            margin: 20px 0;
            display: none;
            border: 1px solid var(--border);
        }

        .trip-calculator.active {
            display: block;
            animation: slideDown 0.3s ease;
        }

        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .calculator-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
            font-size: 15px;
        }

        .calculator-row:last-child {
            margin-bottom: 0;
            font-weight: 700;
            border-top: 1px solid var(--border);
            padding-top: 10px;
            font-size: 18px;
            color: var(--primary);
        }

        /* دکمه درخواست */
        .submit-btn {
            background: var(--gradient-primary);
            color: white;
            border: none;
            padding: 18px;
            border-radius: 16px;
            font-size: 18px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
            margin-top: 10px;
            box-shadow: 0 8px 25px rgba(0, 212, 116, 0.2);
        }

        .submit-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 15px 35px rgba(0, 212, 116, 0.3);
        }

        .submit-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        /* روش پرداخت */
        .payment-methods {
            display: flex;
            gap: 12px;
            margin-top: 15px;
        }

        .payment-method {
            flex: 1;
            padding: 15px;
            border: 2px solid var(--border);
            border-radius: 12px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
        }

        .payment-method i {
            font-size: 24px;
            transition: all 0.3s;
        }

        .payment-method.selected {
            border-color: var(--primary);
            background: rgba(0, 212, 116, 0.05);
        }

        .payment-method.selected i {
            color: var(--primary);
        }

        /* وضعیت جستجو */
        .searching-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            display: none;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .searching-animation {
            width: 80px;
            height: 80px;
            border: 4px solid var(--border);
            border-top: 4px solid var(--primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .searching-text {
            font-size: 18px;
            color: var(--dark);
            margin-bottom: 10px;
            text-align: center;
            font-weight: 600;
        }

        .cancel-search {
            background: transparent;
            border: 1px solid var(--gray);
            color: var(--gray);
            padding: 10px 24px;
            border-radius: 50px;
            cursor: pointer;
            margin-top: 15px;
            font-size: 14px;
            transition: all 0.3s;
        }

        .cancel-search:hover {
            background: var(--accent);
            border-color: var(--accent);
            color: white;
        }

        /* ردیابی زنده */
        .live-tracking {
            position: absolute;
            bottom: 25px;
            right: 25px;
            background: white;
            border-radius: 20px;
            box-shadow: 0 15px 40px rgba(0, 0, 0, 0.15);
            padding: 20px;
            z-index: 2000;
            max-width: 320px;
            border: 1px solid var(--border);
            animation: slideUp 0.3s ease;
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .tracking-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 15px;
            border-bottom: 1px solid var(--border);
        }

        .tracking-header h3 {
            color: var(--primary);
            font-size: 16px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .tracking-info {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .tracking-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .tracking-label {
            color: var(--gray);
            font-size: 14px;
        }

        .tracking-value {
            font-weight: 600;
            font-size: 15px;
            color: var(--dark);
        }

        .progress-container {
            margin: 15px 0;
        }

        .progress-bar {
            height: 6px;
            background: var(--border);
            border-radius: 3px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: var(--gradient-primary);
            border-radius: 3px;
            width: 0%;
            transition: width 0.5s ease;
        }

        .progress-text {
            display: flex;
            justify-content: space-between;
            font-size: 12px;
            color: var(--gray);
            margin-top: 5px;
        }

        /* مدالها */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(10px);
            justify-content: center;
            align-items: center;
            z-index: 2000;
            padding: 20px;
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
            }
            to {
                opacity: 1;
            }
        }

        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 24px;
            max-width: 500px;
            width: 100%;
            box-shadow: 0 25px 50px rgba(0, 0, 0, 0.25);
            max-height: 90vh;
            overflow-y: auto;
            animation: modalSlideUp 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            border: 1px solid var(--border);
        }

        @keyframes modalSlideUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
            padding-bottom: 20px;
            border-bottom: 1px solid var(--border);
        }

        .modal-title {
            font-size: 24px;
            color: var(--dark);
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .modal-title i {
            color: var(--primary);
            background: rgba(0, 212, 116, 0.1);
            width: 44px;
            height: 44px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 12px;
        }

        .close-modal {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: var(--gray);
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 12px;
            transition: all 0.3s;
        }

        .close-modal:hover {
            background: var(--light);
            color: var(--dark);
        }

        /* مدال راننده */
        .driver-info {
            background: linear-gradient(135deg, rgba(0, 212, 116, 0.05) 0%, rgba(108, 99, 255, 0.05) 100%);
            padding: 25px;
            border-radius: 20px;
            margin: 25px 0;
            border: 1px solid var(--border);
        }

        .driver-details {
            display: flex;
            align-items: center;
            gap: 20px;
            margin-bottom: 20px;
        }

        .driver-avatar {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: var(--gradient-primary);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 24px;
            font-weight: 600;
            flex-shrink: 0;
            box-shadow: 0 8px 25px rgba(0, 212, 116, 0.3);
        }

        .driver-name-rating h3 {
            font-size: 18px;
            margin-bottom: 8px;
            color: var(--dark);
        }

        .driver-rating {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .driver-rating .stars {
            color: #FFC107;
            font-size: 16px;
        }

        .driver-rating span {
            font-size: 14px;
            color: var(--gray);
        }

        .car-details {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding-top: 20px;
            border-top: 1px solid var(--border);
        }

        .car-info {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .car-model {
            font-weight: 700;
            font-size: 16px;
            color: var(--dark);
        }

        .car-color {
            color: var(--gray);
            font-size: 14px;
        }

        .car-plate {
            background: var(--gradient-dark);
            color: white;
            padding: 8px 16px;
            border-radius: 12px;
            font-family: monospace;
            font-weight: 600;
            font-size: 16px;
            box-shadow: 0 4px 15px rgba(26, 26, 46, 0.2);
        }

        .trip-info {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
            margin: 25px 0;
            padding: 20px;
            background: white;
            border-radius: 16px;
            border: 1px solid var(--border);
        }

        .trip-detail {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
            text-align: center;
        }

        .trip-detail i {
            font-size: 22px;
            color: var(--primary);
            background: rgba(0, 212, 116, 0.1);
            width: 44px;
            height: 44px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 12px;
        }

        .trip-detail span {
            font-size: 13px;
            color: var(--gray);
        }

        .trip-detail .value {
            font-weight: 700;
            color: var(--dark);
            font-size: 18px;
        }

        .modal-actions {
            display: flex;
            gap: 15px;
        }

        .modal-actions .btn {
            flex: 1;
            justify-content: center;
            padding: 15px;
            font-size: 16px;
            font-weight: 600;
        }

        /* مدال امتیازدهی */
        .rating-stars {
            display: flex;
            gap: 8px;
            direction: ltr;
            margin: 20px 0;
            justify-content: center;
        }

        .rating-star {
            color: #E0E0E0;
            cursor: pointer;
            font-size: 36px;
            transition: all 0.3s;
            position: relative;
        }

        .rating-star:hover,
        .rating-star.active {
            color: #FFC107;
            transform: scale(1.1);
        }

        .rating-star:hover ~ .rating-star {
            color: #E0E0E0;
        }

        /* مناطق کابل */
        .kabul-districts {
            margin-top: 30px;
            background: white;
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            padding: 25px;
            border: 1px solid var(--border);
        }

        .districts-title {
            font-size: 18px;
            margin-bottom: 20px;
            color: var(--dark);
            display: flex;
            align-items: center;
            gap: 12px;
            padding-bottom: 15px;
            border-bottom: 1px solid var(--border);
        }

        .districts-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 12px;
        }

        .district-item {
            padding: 12px;
            background: var(--light);
            border-radius: 12px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 14px;
            font-weight: 500;
            border: 1px solid transparent;
        }

        .district-item:hover {
            background: var(--primary);
            color: white;
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0, 212, 116, 0.2);
            border-color: var(--primary);
        }

        /* نوتیفیکیشن */
        .notification {
            position: fixed;
            top: 30px;
            right: 30px;
            padding: 18px 24px;
            background: var(--gradient-dark);
            color: white;
            border-radius: 16px;
            box-shadow: 0 15px 40px rgba(0, 0, 0, 0.2);
            display: none;
            z-index: 3000;
            max-width: 350px;
            font-size: 15px;
            animation: slideInRight 0.3s ease;
            border: 1px solid rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
        }

        @keyframes slideInRight {
            from {
                opacity: 0;
                transform: translateX(100%);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        .notification.success {
            background: var(--gradient-primary);
        }

        .notification.error {
            background: var(--gradient-accent);
        }

        .notification.warning {
            background: linear-gradient(135deg, #FFB74D 0%, #FF9800 100%);
        }

        .notification.info {
            background: linear-gradient(135deg, #4FC3F7 0%, #0288D1 100%);
        }

        /* صفحات */
        .main-content {
            display: grid;
            grid-template-columns: 1fr 400px;
            gap: 30px;
            margin: 30px 0;
            flex: 1;
        }

        @media (max-width: 1200px) {
            .main-content {
                grid-template-columns: 1fr;
            }
            
            .ride-panel {
                position: static;
                margin-top: 20px;
            }
        }

        /* استایلهای عمومی صفحات */
        .page {
            display: none;
            background: white;
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            padding: 30px;
            margin: 30px 0;
            min-height: 500px;
            border: 1px solid var(--border);
        }

        .page.active {
            display: block;
            animation: fadeIn 0.5s ease;
        }

        .page-title {
            font-size: 28px;
            margin-bottom: 30px;
            color: var(--dark);
            display: flex;
            align-items: center;
            gap: 15px;
            padding-bottom: 20px;
            border-bottom: 2px solid var(--border);
        }

        .page-title i {
            color: var(--primary);
            background: rgba(0, 212, 116, 0.1);
            width: 52px;
            height: 52px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 16px;
            font-size: 22px;
        }

        /* جدولها */
        .table-container {
            overflow-x: auto;
            margin-top: 25px;
            border-radius: 16px;
            border: 1px solid var(--border);
            box-shadow: 0 4px 15px rgba(0,0,0,0.05);
        }

        .data-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 15px;
            min-width: 800px;
        }

        .data-table th {
            background: linear-gradient(135deg, rgba(0, 212, 116, 0.05) 0%, rgba(108, 99, 255, 0.05) 100%);
            padding: 18px 20px;
            text-align: right;
            font-weight: 600;
            color: var(--dark);
            border-bottom: 1px solid var(--border);
        }

        .data-table td {
            padding: 16px 20px;
            text-align: right;
            border-bottom: 1px solid var(--border);
            transition: background 0.3s;
        }

        .data-table tbody tr:hover {
            background: rgba(0, 212, 116, 0.03);
        }

        .data-table tbody tr:last-child td {
            border-bottom: none;
        }

        .status-badge {
            padding: 6px 14px;
            border-radius: 50px;
            font-size: 13px;
            font-weight: 600;
            display: inline-block;
        }

        .status-requested { background: #FFF3E0; color: #EF6C00; }
        .status-confirmed { background: #E3F2FD; color: #1976D2; }
        .status-completed { background: #E8F5E9; color: #388E3C; }
        .status-cancelled { background: #FFEBEE; color: #D32F2F; }
        .status-approved { background: #E8F5E9; color: #388E3C; }
        .status-pending { background: #FFF3E0; color: #EF6C00; }
        .status-rejected { background: #FFEBEE; color: #D32F2F; }
        .status-active { background: #E8F5E9; color: #388E3C; }
        .status-inactive { background: #F5F5F5; color: #757575; }

        .action-buttons {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        .action-btn {
            padding: 6px 14px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 13px;
            font-weight: 500;
            transition: all 0.3s;
        }

        .btn-approve {
            background: var(--gradient-primary);
            color: white;
        }

        .btn-reject {
            background: var(--gradient-accent);
            color: white;
        }

        .btn-edit {
            background: var(--gradient-dark);
            color: white;
        }

        .action-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }

        /* پنل مدیریت */
        .admin-panel {
            display: none;
        }

        .admin-panel.active {
            display: block;
        }

        .admin-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 25px;
            margin-bottom: 40px;
        }

        .stat-card {
            background: white;
            padding: 25px;
            border-radius: 20px;
            box-shadow: var(--shadow);
            border: 1px solid var(--border);
            transition: all 0.3s;
            position: relative;
            overflow: hidden;
        }

        .stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            right: 0;
            width: 100%;
            height: 4px;
            background: var(--gradient-primary);
            transform: translateX(-100%);
            transition: transform 0.6s ease;
        }

        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
        }

        .stat-card:hover::before {
            transform: translateX(0);
        }

        .stat-card h3 {
            font-size: 15px;
            margin-bottom: 15px;
            color: var(--gray);
            font-weight: 500;
        }

        .stat-card .value {
            font-size: 32px;
            font-weight: 700;
            color: var(--primary);
            margin-bottom: 10px;
        }

        .stat-card .change {
            font-size: 14px;
            color: var(--gray);
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .stat-card .change.positive {
            color: var(--primary);
        }

        .stat-card .change.negative {
            color: var(--accent);
        }

        .admin-tabs {
            display: flex;
            border-bottom: 2px solid var(--border);
            margin-bottom: 30px;
            overflow-x: auto;
            padding-bottom: 2px;
        }

        .admin-tab {
            padding: 15px 25px;
            cursor: pointer;
            border-bottom: 2px solid transparent;
            transition: all 0.3s;
            font-weight: 500;
            white-space: nowrap;
            position: relative;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .admin-tab:hover {
            color: var(--primary);
        }

        .admin-tab.active {
            color: var(--primary);
            border-bottom-color: var(--primary);
        }

        .admin-tab i {
            font-size: 16px;
        }

        .admin-tab-content {
            display: none;
            animation: fadeIn 0.5s ease;
        }

        .admin-tab-content.active {
            display: block;
        }

        .tab-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
            flex-wrap: wrap;
            gap: 15px;
        }

        /* کارت تخفیف */
        .discount-card {
            background: white;
            border-radius: 20px;
            box-shadow: var(--shadow);
            padding: 25px;
            margin-bottom: 25px;
            border: 1px solid var(--border);
            transition: all 0.3s;
            position: relative;
            overflow: hidden;
        }

        .discount-card::before {
            content: '';
            position: absolute;
            top: 0;
            right: 0;
            width: 4px;
            height: 100%;
            background: var(--gradient-primary);
        }

        .discount-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.1);
        }

        .discount-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .discount-code {
            font-size: 20px;
            font-weight: 700;
            color: var(--primary);
            font-family: monospace;
        }

        .discount-percent {
            background: var(--gradient-primary);
            color: white;
            padding: 6px 16px;
            border-radius: 50px;
            font-size: 15px;
            font-weight: 600;
        }

        .discount-details {
            display: flex;
            justify-content: space-between;
            color: var(--gray);
            font-size: 14px;
            margin-bottom: 15px;
        }

        .discount-progress {
            margin-top: 15px;
        }

        .progress-text {
            display: flex;
            justify-content: space-between;
            font-size: 13px;
            color: var(--gray);
            margin-bottom: 8px;
        }

        .progress-bar {
            height: 6px;
            background: var(--border);
            border-radius: 3px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: var(--gradient-primary);
            border-radius: 3px;
        }

        /* پیشنهادات */
        .suggestions {
            background: white;
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            margin-top: 25px;
            padding: 25px;
            border: 1px solid var(--border);
        }

        .suggestions-title {
            font-size: 18px;
            margin-bottom: 20px;
            color: var(--dark);
            display: flex;
            align-items: center;
            gap: 12px;
            padding-bottom: 15px;
            border-bottom: 1px solid var(--border);
        }

        .suggestion-list {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
        }

        .suggestion-item {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 18px;
            border: 1px solid var(--border);
            border-radius: 16px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .suggestion-item:hover {
            border-color: var(--primary);
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(0, 212, 116, 0.1);
        }

        .suggestion-icon {
            width: 44px;
            height: 44px;
            border-radius: 12px;
            background: rgba(0, 212, 116, 0.1);
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--primary);
            font-size: 18px;
            flex-shrink: 0;
        }

        .suggestion-text {
            font-weight: 500;
            font-size: 15px;
            color: var(--dark);
        }

        /* بنر تبلیغاتی */
        .promo-banner {
            background: var(--gradient-primary);
            color: white;
            padding: 25px;
            border-radius: 20px;
            margin: 30px 0;
            text-align: center;
            position: relative;
            overflow: hidden;
            box-shadow: 0 15px 40px rgba(0, 212, 116, 0.3);
        }

        .promo-banner::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(255,255,255,0.1) 1px, transparent 1px);
            background-size: 20px 20px;
            opacity: 0.3;
            animation: moveBackground 20s linear infinite;
        }

        @keyframes moveBackground {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        .promo-title {
            font-size: 24px;
            margin-bottom: 10px;
            font-weight: 700;
            position: relative;
            z-index: 1;
        }

        .promo-desc {
            font-size: 16px;
            opacity: 0.9;
            position: relative;
            z-index: 1;
        }

        /* چت پشتیبانی */
        .chat-container {
            height: 500px;
            border: 1px solid var(--border);
            border-radius: 20px;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            background: white;
        }

        .chat-messages {
            flex: 1;
            padding: 25px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 15px;
            background: linear-gradient(135deg, #F8F9FA 0%, #FFFFFF 100%);
        }

        .message {
            max-width: 80%;
            padding: 15px 20px;
            border-radius: 20px;
            font-size: 15px;
            line-height: 1.6;
            position: relative;
            animation: messageAppear 0.3s ease;
        }

        @keyframes messageAppear {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .message.received {
            align-self: flex-start;
            background: white;
            border-bottom-right-radius: 5px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.05);
            border: 1px solid var(--border);
        }

        .message.sent {
            align-self: flex-end;
            background: var(--gradient-primary);
            color: white;
            border-bottom-left-radius: 5px;
            box-shadow: 0 4px 15px rgba(0, 212, 116, 0.2);
        }

        .message-time {
            font-size: 11px;
            opacity: 0.7;
            margin-top: 5px;
            text-align: left;
        }

        .chat-input {
            display: flex;
            padding: 20px;
            border-top: 1px solid var(--border);
            background: white;
            gap: 12px;
        }

        .chat-input input {
            flex: 1;
            padding: 14px 20px;
            border: 1px solid var(--border);
            border-radius: 50px;
            outline: none;
            font-size: 15px;
            transition: all 0.3s;
        }

        .chat-input input:focus {
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(0, 212, 116, 0.1);
        }

        .chat-input button {
            background: var(--gradient-primary);
            color: white;
            border: none;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 18px;
            transition: all 0.3s;
            flex-shrink: 0;
        }

        .chat-input button:hover {
            transform: scale(1.05);
            box-shadow: 0 8px 25px rgba(0, 212, 116, 0.3);
        }

        /* پروفایل */
        .profile-section {
            display: flex;
            flex-direction: column;
            gap: 30px;
        }

        .profile-header {
            display: flex;
            align-items: center;
            gap: 25px;
            padding-bottom: 25px;
            border-bottom: 1px solid var(--border);
        }

        .profile-avatar {
            width: 100px;
            height: 100px;
            border-radius: 50%;
            background: var(--gradient-primary);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 36px;
            font-weight: 700;
            box-shadow: 0 15px 40px rgba(0, 212, 116, 0.3);
            flex-shrink: 0;
        }

        .profile-info h3 {
            font-size: 24px;
            margin-bottom: 8px;
            color: var(--dark);
        }

        .profile-info p {
            color: var(--gray);
            font-size: 16px;
            margin-bottom: 5px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .profile-info p i {
            width: 20px;
            color: var(--primary);
        }

        .profile-stats {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 20px;
            margin: 20px 0;
        }

        .profile-stat {
            text-align: center;
            padding: 25px;
            background: linear-gradient(135deg, rgba(0, 212, 116, 0.05) 0%, rgba(108, 99, 255, 0.05) 100%);
            border-radius: 16px;
            border: 1px solid var(--border);
            transition: all 0.3s;
        }

        .profile-stat:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 35px rgba(0, 212, 116, 0.1);
        }

        .profile-stat .value {
            font-size: 32px;
            font-weight: 700;
            color: var(--primary);
            margin-bottom: 8px;
        }

        .profile-stat .label {
            font-size: 14px;
            color: var(--gray);
        }

        /* مراحل سفر */
        .trip-progress {
            margin: 30px 0;
        }

        .progress-steps {
            display: flex;
            justify-content: space-between;
            position: relative;
            margin-bottom: 40px;
        }

        .progress-steps::before {
            content: '';
            position: absolute;
            top: 20px;
            right: 50px;
            left: 50px;
            height: 3px;
            background: var(--border);
            z-index: 1;
        }

        .progress-step {
            display: flex;
            flex-direction: column;
            align-items: center;
            position: relative;
            z-index: 2;
            flex: 1;
        }

        .step-icon {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: white;
            border: 3px solid var(--border);
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 10px;
            transition: all 0.3s;
            font-size: 16px;
            color: var(--gray);
        }

        .step-icon.active {
            background: var(--primary);
            border-color: var(--primary);
            color: white;
            box-shadow: 0 8px 25px rgba(0, 212, 116, 0.3);
        }

        .step-label {
            font-size: 13px;
            color: var(--gray);
            text-align: center;
            font-weight: 500;
        }

        .step-label.active {
            color: var(--primary);
            font-weight: 600;
        }

        /* فرمهای احراز هویت */
        .auth-form {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .form-tabs {
            display: flex;
            border-bottom: 2px solid var(--border);
            margin-bottom: 25px;
        }

        .form-tab {
            padding: 12px 25px;
            cursor: pointer;
            border-bottom: 2px solid transparent;
            transition: all 0.3s;
            font-size: 16px;
            font-weight: 500;
        }

        .form-tab.active {
            border-bottom: 2px solid var(--primary);
            color: var(--primary);
        }

        .form-tab-content {
            display: none;
        }

        .form-tab-content.active {
            display: block;
        }

        .password-toggle {
            position: absolute;
            left: 20px;
            top: 50%;
            transform: translateY(-50%);
            background: none;
            border: none;
            cursor: pointer;
            color: var(--gray);
            font-size: 16px;
        }

        .form-footer {
            text-align: center;
            margin-top: 20px;
            font-size: 14px;
            color: var(--gray);
        }

        .form-footer a {
            color: var(--primary);
            text-decoration: none;
            font-weight: 500;
            transition: color 0.3s;
        }

        .form-footer a:hover {
            text-decoration: underline;
        }

        .error-message {
            color: var(--accent);
            font-size: 13px;
            margin-top: 5px;
            display: none;
            font-weight: 500;
        }

        /* فوتر */
        footer {
            background: var(--gradient-dark);
            color: white;
            padding: 50px 0 25px;
            margin-top: auto;
        }

        .footer-content {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 30px;
            margin-bottom: 30px;
        }

        .footer-column h3 {
            font-size: 18px;
            margin-bottom: 20px;
            color: var(--primary);
            font-weight: 600;
        }

        .footer-links {
            list-style: none;
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .footer-links a {
            color: rgba(255, 255, 255, 0.8);
            text-decoration: none;
            transition: all 0.3s;
            font-size: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .footer-links a:hover {
            color: var(--primary);
            transform: translateX(-5px);
        }

        .social-links {
            display: flex;
            gap: 15px;
            margin-top: 20px;
        }

        .social-links a {
            color: white;
            font-size: 20px;
            transition: all 0.3s;
            width: 44px;
            height: 44px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 12px;
        }

        .social-links a:hover {
            background: var(--primary);
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(0, 212, 116, 0.3);
        }

        .footer-bottom {
            text-align: center;
            padding-top: 25px;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            color: rgba(255, 255, 255, 0.6);
            font-size: 14px;
        }

        /* ریسپانسیو */
        @media (max-width: 1200px) {
            .container {
                max-width: 100%;
            }
            
            .footer-content {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        @media (max-width: 992px) {
            .nav-links {
                display: none;
            }

            .hamburger {
                display: flex;
            }

            .user-actions .btn {
                display: none;
            }

            .main-content {
                grid-template-columns: 1fr;
                gap: 25px;
            }

            .map-container {
                height: 450px;
            }

            .suggestion-list {
                grid-template-columns: 1fr;
            }

            .districts-grid {
                grid-template-columns: repeat(2, 1fr);
            }

            .profile-header {
                flex-direction: column;
                text-align: center;
                gap: 20px;
            }

            .profile-stats {
                grid-template-columns: 1fr;
            }
        }

        @media (max-width: 768px) {
            .container {
                padding: 0 15px;
            }

            .logo {
                font-size: 20px;
            }

            .logo i {
                font-size: 24px;
                width: 40px;
                height: 40px;
            }

            .welcome-title {
                font-size: 36px;
            }

            .welcome-subtitle {
                font-size: 20px;
            }

            .welcome-features {
                grid-template-columns: 1fr;
            }

            .welcome-actions {
                flex-direction: column;
            }

            .btn-welcome {
                min-width: 100%;
            }

            .page-title {
                font-size: 24px;
            }

            .page-title i {
                width: 44px;
                height: 44px;
                font-size: 20px;
            }

            .modal-content {
                padding: 25px;
            }

            .modal-title {
                font-size: 20px;
            }

            .trip-info {
                grid-template-columns: 1fr;
                gap: 20px;
            }

            .admin-stats {
                grid-template-columns: 1fr;
            }

            .admin-tabs {
                flex-direction: column;
                border-bottom: none;
                gap: 10px;
            }

            .admin-tab {
                border: 1px solid var(--border);
                border-radius: 12px;
                padding: 15px;
            }

            .admin-tab.active {
                border-color: var(--primary);
                background: rgba(0, 212, 116, 0.05);
            }

            .footer-content {
                grid-template-columns: 1fr;
                gap: 25px;
            }

            .chat-container {
                height: 400px;
            }
        }

        @media (max-width: 576px) {
            .container {
                padding: 0 10px;
            }

            .map-container {
                height: 400px;
            }

            .ride-panel {
                padding: 20px;
            }

            .districts-grid {
                grid-template-columns: 1fr;
            }

            .modal-content {
                padding: 20px;
            }

            .notification {
                right: 10px;
                left: 10px;
                max-width: none;
            }

            .mobile-menu {
                width: 280px;
            }

            .profile-stat {
                padding: 20px;
            }

            .profile-stat .value {
                font-size: 28px;
            }
        }

        @media (max-width: 400px) {
            .modal-content {
                padding: 15px;
            }

            .page {
                padding: 20px;
            }

            .suggestion-item {
                flex-direction: column;
                text-align: center;
                gap: 10px;
            }
        }

        /* استایل‌های نقشه */
        .leaflet-control-container .leaflet-top {
            top: 80px;
        }

        .leaflet-marker-icon {
            filter: drop-shadow(0 2px 4px rgba(0,0,0,0.3));
        }

        .driver-marker {
            background: var(--primary);
            border: 3px solid white;
            border-radius: 50%;
            box-shadow: 0 4px 12px rgba(0, 212, 116, 0.4);
            animation: pulse 2s infinite;
        }

        .passenger-marker {
            background: var(--accent);
            border: 3px solid white;
            border-radius: 50%;
            box-shadow: 0 4px 12px rgba(255, 101, 132, 0.4);
        }

        .car-icon {
            background: var(--primary);
            border-radius: 50%;
            padding: 5px;
            color: white;
            font-size: 16px;
        }

        .bike-icon {
            background: var(--secondary);
            border-radius: 50%;
            padding: 5px;
            color: white;
            font-size: 16px;
        }

        @keyframes pulse {
            0%, 100% { box-shadow: 0 0 0 0 rgba(0, 212, 116, 0.4); }
            50% { box-shadow: 0 0 0 10px rgba(0, 212, 116, 0); }
        }

        /* کنترل‌های نقشه سفارشی */
        .map-controls {
            position: absolute;
            top: 20px;
            right: 20px;
            z-index: 1000;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .map-control-btn {
            background: white;
            border: 1px solid var(--border);
            border-radius: 12px;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            color: var(--dark);
            transition: all 0.3s;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }

        .map-control-btn:hover {
            background: var(--primary);
            color: white;
            transform: scale(1.1);
        }
    </style>
</head>
<body>
    <!-- صفحه خوشآمدگویی -->
    <div class="welcome-page" id="welcome-page">
        <div class="welcome-content">
            <div class="welcome-logo">
                <i class="fas fa-car-side"></i>
                <span>اسنپ افغانستان</span>
            </div>
            <h1 class="welcome-title">سرویس تاکسی اینترنتی در سراسر کابل</h1>
            <p class="welcome-subtitle">سریع، مطمئن و مقرون به صرفه</p>
            
            <div class="welcome-features">
                <div class="feature-card">
                    <div class="feature-icon">
                        <i class="fas fa-bolt"></i>
                    </div>
                    <h3 class="feature-title">سریع و آسان</h3>
                    <p class="feature-desc">در کمتر از ۵ دقیقه یک خودرو در نزدیکی شما خواهد بود</p>
                </div>
                <div class="feature-card">
                    <div class="feature-icon">
                        <i class="fas fa-shield-alt"></i>
                    </div>
                    <h3 class="feature-title">مطمئن و امن</h3>
                    <p class="feature-desc">تمام رانندگان ما تایید شده و دارای بیمه هستند</p>
                </div>
                <div class="feature-card">
                    <div class="feature-icon">
                        <i class="fas fa-money-bill-wave"></i>
                    </div>
                    <h3 class="feature-title">قیمت مناسب</h3>
                    <p class="feature-desc">قیمتهای شفاف و رقابتی با امکان پرداخت نقدی</p>
                </div>
            </div>
            
            <div class="welcome-actions">
                <button class="btn-welcome btn-welcome-primary" id="start-using-btn">
                    <i class="fas fa-play-circle"></i>
                    شروع استفاده از اسنپ
                </button>
                <button class="btn-welcome btn-welcome-outline" id="learn-more-btn">
                    <i class="fas fa-info-circle"></i>
                    اطلاعات بیشتر
                </button>
            </div>
        </div>
    </div>

    <!-- هدر -->
    <header style="display: none;" id="main-header">
        <div class="container nav-container">
            <a href="#" class="logo" data-page="home">
                <i class="fas fa-car-side"></i>
                <span>اسنپ افغانستان</span>
            </a>
            <ul class="nav-links">
                <li><a href="#" class="nav-link active" data-page="home"><i class="fas fa-home"></i> خانه</a></li>
                <li><a href="#" class="nav-link" data-page="my-trips"><i class="fas fa-history"></i> سفرهای من</a></li>
                <li><a href="#" class="nav-link" data-page="discounts"><i class="fas fa-gift"></i> تخفیفها</a></li>
                <li><a href="#" class="nav-link" data-page="support"><i class="fas fa-question-circle"></i> پشتیبانی</a></li>
                <li><a href="#" class="nav-link" data-page="profile"><i class="fas fa-user"></i> پروفایل</a></li>
                <li><a href="#" class="nav-link" data-page="admin" id="adminLink" style="display: none;"><i class="fas fa-cog"></i> پنل مدیریت</a></li>
            </ul>
            <div class="user-actions">
                <div class="user-profile" id="userProfile" style="display: none;">
                    <div class="user-avatar" id="userAvatar">ا</div>
                    <div class="user-name" id="userName">احمد محمدی</div>
                </div>
                <button class="btn btn-outline" id="loginBtn"><i class="fas fa-user"></i> ورود / ثبتنام</button>
                <button class="btn btn-outline" id="logoutBtn" style="display: none;"><i class="fas fa-sign-out-alt"></i> خروج</button>
            </div>
            <div class="hamburger" id="hamburger">
                <span></span>
                <span></span>
                <span></span>
            </div>
        </div>
    </header>

    <!-- منوی موبایل -->
    <div class="mobile-menu" id="mobileMenu">
        <div class="mobile-menu-header">
            <div class="mobile-menu-logo">
                <i class="fas fa-car-side"></i>
                <span>اسنپ افغانستان</span>
            </div>
            <button class="close-menu" id="closeMenu">&times;</button>
        </div>
        <ul class="mobile-nav-links">
            <li><a href="#" class="nav-link active" data-page="home"><i class="fas fa-home"></i> خانه</a></li>
            <li><a href="#" class="nav-link" data-page="my-trips"><i class="fas fa-history"></i> سفرهای من</a></li>
            <li><a href="#" class="nav-link" data-page="discounts"><i class="fas fa-gift"></i> تخفیفها</a></li>
            <li><a href="#" class="nav-link" data-page="support"><i class="fas fa-question-circle"></i> پشتیبانی</a></li>
            <li><a href="#" class="nav-link" data-page="profile"><i class="fas fa-user"></i> پروفایل</a></li>
            <li><a href="#" class="nav-link" data-page="admin" id="mobileAdminLink" style="display: none;"><i class="fas fa-cog"></i> پنل مدیریت</a></li>
        </ul>
        <div class="mobile-user-actions">
            <button class="btn btn-primary" id="mobileLoginBtn" style="width: 100%;">ورود / ثبتنام</button>
            <button class="btn btn-outline" id="mobileLogoutBtn" style="width: 100%; display: none;">خروج</button>
        </div>
    </div>
    <div class="overlay" id="overlay"></div>

    <!-- محتوای اصلی -->
    <div class="container" style="display: none;" id="main-container">
        <div class="page active" id="home-page">
            <div class="main-content">
                <!-- نقشه کابل -->
                <div class="map-container">
                    <div id="map"></div>
                    <div class="map-controls">
                        <button class="map-control-btn" id="locateMe" title="موقعیت من">
                            <i class="fas fa-location-arrow"></i>
                        </button>
                        <button class="map-control-btn" id="zoomIn" title="بزرگنمایی">
                            <i class="fas fa-plus"></i>
                        </button>
                        <button class="map-control-btn" id="zoomOut" title="کوچکنمایی">
                            <i class="fas fa-minus"></i>
                        </button>
                    </div>
                    
                    <!-- ردیابی زنده -->
                    <div class="live-tracking" id="liveTracking" style="display: none;">
                        <div class="tracking-header">
                            <h3><i class="fas fa-map-marker-alt"></i> ردیابی زنده</h3>
                            <button class="close-modal" id="closeTracking">&times;</button>
                        </div>
                        <div class="tracking-info">
                            <div class="tracking-row">
                                <span class="tracking-label">راننده:</span>
                                <span class="tracking-value" id="trackingDriverName">احمد ظاهر</span>
                            </div>
                            <div class="tracking-row">
                                <span class="tracking-label">زمان رسیدن:</span>
                                <span class="tracking-value" id="trackingETA">۴ دقیقه</span>
                            </div>
                            <div class="tracking-row">
                                <span class="tracking-label">مسافت باقیمانده:</span>
                                <span class="tracking-value" id="trackingDistance">۲.۸ کیلومتر</span>
                            </div>
                            <div class="progress-container">
                                <div class="progress-bar">
                                    <div class="progress-fill" id="trackingProgress"></div>
                                </div>
                                <div class="progress-text">
                                    <span>مبدا</span>
                                    <span>مقصد</span>
                                </div>
                            </div>
                            <button class="btn btn-outline" id="cancelTracking" style="width: 100%; margin-top: 10px;">
                                <i class="fas fa-times"></i>
                                لغو سفر
                            </button>
                        </div>
                    </div>
                    
                    <!-- وضعیت جستجو -->
                    <div class="searching-overlay" id="searchingOverlay">
                        <div class="searching-animation"></div>
                        <div class="searching-text" id="searchingText">در حال یافتن نزدیکترین راننده...</div>
                        <button class="cancel-search" id="cancelSearch">لغو درخواست</button>
                    </div>
                </div>

                <!-- پنل درخواست سفر -->
                <div class="ride-panel">
                    <h2 class="panel-title"><i class="fas fa-map-marker-alt"></i> درخواست سفر</h2>
                    
                    <form class="ride-form" id="rideForm">
                        <div class="form-group">
                            <label for="pickup"><i class="fas fa-circle"></i> مبدا</label>
                            <div class="input-with-icon">
                                <i class="fas fa-map-marker-alt input-icon"></i>
                                <input type="text" id="pickup" class="form-input" placeholder="آدرس فعلی شما" required>
                            </div>
                        </div>
                        
                        <div class="location-swap">
                            <button type="button" class="swap-btn" id="swapLocations">
                                <i class="fas fa-exchange-alt"></i>
                            </button>
                        </div>
                        
                        <div class="form-group">
                            <label for="destination"><i class="fas fa-flag-checkered"></i> مقصد</label>
                            <div class="input-with-icon">
                                <i class="fas fa-flag-checkered input-icon"></i>
                                <input type="text" id="destination" class="form-input" placeholder="محل مورد نظر شما" required>
                            </div>
                        </div>

                        <!-- محاسبه قیمت -->
                        <div class="trip-calculator" id="tripCalculator">
                            <div class="calculator-row">
                                <span>مسافت تخمینی:</span>
                                <span id="distanceValue">0 کیلومتر</span>
                            </div>
                            <div class="calculator-row">
                                <span>کرایه پایه:</span>
                                <span id="baseFareValue">0 افغانی</span>
                            </div>
                            <div class="calculator-row">
                                <span>کرایه مسافت:</span>
                                <span id="distanceFareValue">0 افغانی</span>
                            </div>
                            <div class="calculator-row">
                                <span>هزینه نهایی:</span>
                                <span id="totalFareValue">0 افغانی</span>
                            </div>
                        </div>

                        <div class="form-group">
                            <label><i class="fas fa-car"></i> نوع سفر</label>
                            <div class="ride-type-selector" id="rideTypeSelector">
                                <div class="ride-type economy" data-type="economy" data-base-fare="50">
                                    <div class="ride-type-info">
                                        <div class="ride-icon">
                                            <i class="fas fa-car"></i>
                                        </div>
                                        <div class="ride-details">
                                            <h3>اقتصادی</h3>
                                            <p>مناسب برای سفرهای روزمره</p>
                                        </div>
                                    </div>
                                    <div class="ride-price">
                                        <div id="economyPrice">-- افغانی</div>
                                        <div class="price-estimate">برآورد قیمت</div>
                                    </div>
                                </div>
                                <div class="ride-type comfort" data-type="comfort" data-base-fare="80">
                                    <div class="ride-type-info">
                                        <div class="ride-icon">
                                            <i class="fas fa-car-side"></i>
                                        </div>
                                        <div class="ride-details">
                                            <h3>کلاسیک</h3>
                                            <p>خودروی مناسب و راحت</p>
                                        </div>
                                    </div>
                                    <div class="ride-price">
                                        <div id="comfortPrice">-- افغانی</div>
                                        <div class="price-estimate">برآورد قیمت</div>
                                    </div>
                                </div>
                                <div class="ride-type bike" data-type="bike" data-base-fare="30">
                                    <div class="ride-type-info">
                                        <div class="ride-icon">
                                            <i class="fas fa-motorcycle"></i>
                                        </div>
                                        <div class="ride-details">
                                            <h3>موتور</h3>
                                            <p>سریع و مقرون به صرفه</p>
                                        </div>
                                    </div>
                                    <div class="ride-price">
                                        <div id="bikePrice">-- افغانی</div>
                                        <div class="price-estimate">برآورد قیمت</div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- روش پرداخت -->
                        <div class="form-group">
                            <label><i class="fas fa-credit-card"></i> روش پرداخت</label>
                            <div class="payment-methods">
                                <div class="payment-method selected" data-method="cash">
                                    <i class="fas fa-money-bill-wave"></i>
                                    <span>نقدی</span>
                                </div>
                                <div class="payment-method" data-method="wallet">
                                    <i class="fas fa-wallet"></i>
                                    <span>کیف پول</span>
                                </div>
                            </div>
                        </div>

                        <button type="submit" class="submit-btn" id="submitBtn">
                            <i class="fas fa-search"></i>
                            درخواست خودرو
                        </button>
                    </form>

                    <!-- مناطق کابل -->
                    <div class="kabul-districts">
                        <h3 class="districts-title"><i class="fas fa-map"></i> مناطق کابل</h3>
                        <div class="districts-grid" id="districtsGrid">
                            <!-- مناطق به صورت داینامیک اضافه میشوند -->
                        </div>
                    </div>
                </div>
            </div>

            <!-- پیشنهادات مقصد -->
            <div class="suggestions">
                <h3 class="suggestions-title"><i class="fas fa-fire"></i> مقاصد پرطرفدار در کابل</h3>
                <div class="suggestion-list">
                    <div class="suggestion-item" data-destination="میدان هوایی بین المللی کابل">
                        <div class="suggestion-icon">
                            <i class="fas fa-plane"></i>
                        </div>
                        <div class="suggestion-text">میدان هوایی بین المللی کابل</div>
                    </div>
                    <div class="suggestion-item" data-destination="سفارت امریکا">
                        <div class="suggestion-icon">
                            <i class="fas fa-landmark"></i>
                        </div>
                        <div class="suggestion-text">سفارت امریکا</div>
                    </div>
                    <div class="suggestion-item" data-destination="سفارت ایران">
                        <div class="suggestion-icon">
                            <i class="fas fa-landmark"></i>
                        </div>
                        <div class="suggestion-text">سفارت ایران</div>
                    </div>
                    <div class="suggestion-item" data-destination="سفارت پاکستان">
                        <div class="suggestion-icon">
                            <i class="fas fa-landmark"></i>
                        </div>
                        <div class="suggestion-text">سفارت پاکستان</div>
                    </div>
                    <div class="suggestion-item" data-destination="وزارت امور خارجه">
                        <div class="suggestion-icon">
                            <i class="fas fa-building"></i>
                        </div>
                        <div class="suggestion-text">وزارت امور خارجه</div>
                    </div>
                    <div class="suggestion-item" data-destination="ارگ ریاست جمهوری">
                        <div class="suggestion-icon">
                            <i class="fas fa-monument"></i>
                        </div>
                        <div class="suggestion-text">ارگ ریاست جمهوری</div>
                    </div>
                </div>
            </div>

            <!-- بنر تبلیغاتی -->
            <div class="promo-banner">
                <div class="promo-title">اولین سفر رایگان!</div>
                <div class="promo-desc">با کد WELCOME100 از ۱۰۰ افغانی تخفیف در اولین سفر خود استفاده کنید</div>
            </div>
        </div>

        <!-- صفحه سفرهای من -->
        <div class="page" id="my-trips-page">
            <h2 class="page-title"><i class="fas fa-history"></i> سفرهای من</h2>
            <div class="table-container">
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>تاریخ</th>
                            <th>مبدا</th>
                            <th>مقصد</th>
                            <th>نوع سفر</th>
                            <th>مسافت</th>
                            <th>هزینه</th>
                            <th>وضعیت</th>
                            <th>عملیات</th>
                        </tr>
                    </thead>
                    <tbody id="myTripsTable">
                        <!-- سفرهای کاربر به صورت داینامیک اضافه میشوند -->
                    </tbody>
                </table>
            </div>
        </div>

        <!-- صفحه تخفیفها -->
        <div class="page" id="discounts-page">
            <h2 class="page-title"><i class="fas fa-gift"></i> تخفیفها</h2>
            <div id="discountsList">
                <!-- تخفیفها به صورت داینامیک اضافه میشوند -->
            </div>
        </div>

        <!-- صفحه پشتیبانی -->
        <div class="page" id="support-page">
            <h2 class="page-title"><i class="fas fa-question-circle"></i> پشتیبانی</h2>
            
            <div class="chat-container">
                <div class="chat-messages" id="chatMessages">
                    <div class="message received">
                        سلام! به پشتیبانی اسنپ افغانستان خوش آمدید. چگونه میتوانم کمکتان کنم؟
                        <div class="message-time">امروز ۱۲:۳۰</div>
                    </div>
                </div>
                <div class="chat-input">
                    <input type="text" id="chatInput" placeholder="پیام خود را بنویسید...">
                    <button id="sendMessage"><i class="fas fa-paper-plane"></i></button>
                </div>
            </div>
            
            <div class="support-info" style="margin-top: 30px;">
                <h3>راههای ارتباطی</h3>
                <p><i class="fas fa-phone"></i> شماره تماس: ۰۷۰۰۱۲۳۴۵۶</p>
                <p><i class="fas fa-envelope"></i> ایمیل: support@snapp.af</p>
                <p><i class="fas fa-clock"></i> ساعات پاسخگویی: ۲۴ ساعته</p>
            </div>
        </div>

        <!-- صفحه پروفایل -->
        <div class="page" id="profile-page">
            <h2 class="page-title"><i class="fas fa-user"></i> پروفایل</h2>
            
            <div class="profile-section">
                <div class="profile-header">
                    <div class="profile-avatar" id="profileAvatar">ا</div>
                    <div class="profile-info">
                        <h3 id="profileName">احمد محمدی</h3>
                        <p><i class="fas fa-envelope"></i> <span id="profileEmail">ahmad@example.com</span></p>
                        <p><i class="fas fa-phone"></i> <span id="profilePhone">۰۷۰۰۱۱۱۲۲۲</span></p>
                        <p><i class="fas fa-user-tag"></i> <span id="profileRole">مسافر</span></p>
                    </div>
                </div>
                
                <div class="profile-stats">
                    <div class="profile-stat">
                        <div class="value" id="totalTripsCount">۱۲</div>
                        <div class="label">تعداد سفرها</div>
                    </div>
                    <div class="profile-stat">
                        <div class="value" id="totalSpent">۱,۳۴۰</div>
                        <div class="label">افغانی هزینه شده</div>
                    </div>
                    <div class="profile-stat">
                        <div class="value" id="userRating">۴.۷</div>
                        <div class="label">امتیاز شما</div>
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="editName"><i class="fas fa-user"></i> نام کامل</label>
                    <input type="text" id="editName" class="form-input" value="احمد محمدی">
                </div>
                
                <div class="form-group">
                    <label for="editEmail"><i class="fas fa-envelope"></i> ایمیل</label>
                    <input type="email" id="editEmail" class="form-input" value="ahmad@example.com">
                </div>
                
                <div class="form-group">
                    <label for="editPhone"><i class="fas fa-phone"></i> شماره تماس</label>
                    <input type="tel" id="editPhone" class="form-input" value="0700111222">
                </div>
                
                <button class="btn btn-primary" id="saveProfile">
                    <i class="fas fa-save"></i>
                    ذخیره تغییرات
                </button>
            </div>
        </div>

        <!-- صفحه پنل مدیریت -->
        <div class="page admin-panel" id="admin-page">
            <h2 class="page-title"><i class="fas fa-cog"></i> پنل مدیریت</h2>
            
            <div class="admin-stats">
                <div class="stat-card">
                    <h3>تعداد سفرها</h3>
                    <div class="value" id="totalTrips">0</div>
                    <div class="change positive"><i class="fas fa-arrow-up"></i> ۱۲% نسبت به ماه گذشته</div>
                </div>
                <div class="stat-card">
                    <h3>کاربران فعال</h3>
                    <div class="value" id="activeUsers">0</div>
                    <div class="change positive"><i class="fas fa-arrow-up"></i> ۸% نسبت به ماه گذشته</div>
                </div>
                <div class="stat-card">
                    <h3>رانندگان</h3>
                    <div class="value" id="totalDrivers">0</div>
                    <div class="change positive"><i class="fas fa-arrow-up"></i> ۵% نسبت به ماه گذشته</div>
                </div>
                <div class="stat-card">
                    <h3>درآمد کل</h3>
                    <div class="value" id="totalRevenue">0 افغانی</div>
                    <div class="change positive"><i class="fas fa-arrow-up"></i> ۱۵% نسبت به ماه گذشته</div>
                </div>
            </div>
            
            <div class="admin-tabs">
                <div class="admin-tab active" data-tab="users">
                    <i class="fas fa-users"></i>
                    مدیریت کاربران
                </div>
                <div class="admin-tab" data-tab="drivers">
                    <i class="fas fa-car"></i>
                    مدیریت رانندگان
                </div>
                <div class="admin-tab" data-tab="trips">
                    <i class="fas fa-road"></i>
                    مدیریت سفرها
                </div>
                <div class="admin-tab" data-tab="discounts">
                    <i class="fas fa-tag"></i>
                    مدیریت تخفیفها
                </div>
                <div class="admin-tab" data-tab="support">
                    <i class="fas fa-headset"></i>
                    مدیریت پشتیبانی
                </div>
                <div class="admin-tab" data-tab="realtime">
                    <i class="fas fa-sync"></i>
                    بروزرسانی Real-time
                </div>
            </div>
            
            <div class="admin-tab-content active" id="users-tab">
                <div class="tab-header">
                    <h3>کاربران در انتظار تایید</h3>
                    <div class="action-buttons">
                        <button class="btn btn-primary" id="refreshUsersBtn">
                            <i class="fas fa-sync-alt"></i>
                            بروزرسانی
                        </button>
                        <button class="btn btn-approve" id="exportUsersBtn">
                            <i class="fas fa-download"></i>
                            خروجی Excel
                        </button>
                    </div>
                </div>
                <div class="table-container">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>نام</th>
                                <th>ایمیل</th>
                                <th>شماره تماس</th>
                                <th>نوع کاربر</th>
                                <th>تاریخ ثبتنام</th>
                                <th>عملیات</th>
                            </tr>
                        </thead>
                        <tbody id="pendingUsersTable">
                            <!-- کاربران در انتظار تایید -->
                        </tbody>
                    </table>
                </div>
                
                <div class="tab-header" style="margin-top: 40px;">
                    <h3>همه کاربران</h3>
                    <button class="btn btn-primary" id="exportAllUsersBtn">
                        <i class="fas fa-download"></i>
                        خروجی Excel
                    </button>
                </div>
                <div class="table-container">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>نام</th>
                                <th>ایمیل</th>
                                <th>شماره تماس</th>
                                <th>نوع کاربر</th>
                                <th>وضعیت</th>
                                <th>تاریخ ثبتنام</th>
                                <th>عملیات</th>
                            </tr>
                        </thead>
                        <tbody id="allUsersTable">
                            <!-- همه کاربران -->
                        </tbody>
                    </table>
                </div>
            </div>
            
            <div class="admin-tab-content" id="drivers-tab">
                <div class="tab-header">
                    <h3>مدیریت رانندگان</h3>
                    <div class="action-buttons">
                        <button class="btn btn-primary" id="addDriverBtn">
                            <i class="fas fa-user-plus"></i>
                            افزودن راننده جدید
                        </button>
                        <button class="btn btn-approve" id="exportDriversBtn">
                            <i class="fas fa-download"></i>
                            خروجی Excel
                        </button>
                        <button class="btn btn-edit" id="refreshDriversBtn">
                            <i class="fas fa-sync-alt"></i>
                        </button>
                    </div>
                </div>
                <div class="table-container">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>نام</th>
                                <th>شماره تماس</th>
                                <th>نوع وسیله</th>
                                <th>مدل خودرو</th>
                                <th>پلاک</th>
                                <th>وضعیت</th>
                                <th>امتیاز</th>
                                <th>عملیات</th>
                            </tr>
                        </thead>
                        <tbody id="driversTable">
                            <!-- رانندگان -->
                        </tbody>
                    </table>
                </div>
            </div>
            
            <div class="admin-tab-content" id="trips-tab">
                <div class="tab-header">
                    <h3>مدیریت سفرها</h3>
                    <div class="action-buttons">
                        <div class="form-group" style="display: flex; gap: 10px; align-items: center;">
                            <input type="date" id="tripFilterDate" class="form-input" style="padding: 10px; width: 200px;">
                            <select id="tripFilterStatus" class="form-input" style="padding: 10px; width: 150px;">
                                <option value="">همه وضعیت‌ها</option>
                                <option value="requested">درخواست شده</option>
                                <option value="confirmed">تأیید شده</option>
                                <option value="in_progress">در حال انجام</option>
                                <option value="completed">تکمیل شده</option>
                                <option value="cancelled">لغو شده</option>
                            </select>
                            <button class="btn btn-primary" id="filterTripsBtn">
                                <i class="fas fa-filter"></i>
                                فیلتر
                            </button>
                        </div>
                        <button class="btn btn-approve" id="exportTripsBtn">
                            <i class="fas fa-download"></i>
                            خروجی Excel
                        </button>
                        <button class="btn btn-edit" id="refreshTripsBtn">
                            <i class="fas fa-sync-alt"></i>
                        </button>
                    </div>
                </div>
                <div class="table-container">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>تاریخ</th>
                                <th>مسافر</th>
                                <th>راننده</th>
                                <th>مبدا</th>
                                <th>مقصد</th>
                                <th>مسافت</th>
                                <th>هزینه</th>
                                <th>وضعیت</th>
                                <th>عملیات</th>
                            </tr>
                        </thead>
                        <tbody id="adminTripsTable">
                            <!-- سفرها -->
                        </tbody>
                    </table>
                </div>
            </div>
            
            <div class="admin-tab-content" id="discounts-tab">
                <div class="tab-header">
                    <h3>مدیریت تخفیفها</h3>
                    <div class="action-buttons">
                        <button class="btn btn-primary" id="addDiscountBtn">
                            <i class="fas fa-plus-circle"></i>
                            افزودن تخفیف جدید
                        </button>
                        <button class="btn btn-approve" id="exportDiscountsBtn">
                            <i class="fas fa-download"></i>
                            خروجی Excel
                        </button>
                        <button class="btn btn-edit" id="refreshDiscountsBtn">
                            <i class="fas fa-sync-alt"></i>
                        </button>
                    </div>
                </div>
                <div class="table-container">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>کد تخفیف</th>
                                <th>درصد تخفیف</th>
                                <th>تاریخ انقضا</th>
                                <th>کاربران استفادهکننده</th>
                                <th>وضعیت</th>
                                <th>عملیات</th>
                            </tr>
                        </thead>
                        <tbody id="discountsTable">
                            <!-- تخفیفها -->
                        </tbody>
                    </table>
                </div>
            </div>
            
            <div class="admin-tab-content" id="support-tab">
                <div class="tab-header">
                    <h3>مدیریت درخواستهای پشتیبانی</h3>
                    <div class="action-buttons">
                        <button class="btn btn-primary" id="markAllReadBtn">
                            <i class="fas fa-check-double"></i>
                            علامتگذاری همه
                        </button>
                        <button class="btn btn-approve" id="exportSupportBtn">
                            <i class="fas fa-download"></i>
                            خروجی Excel
                        </button>
                        <button class="btn btn-edit" id="refreshSupportBtn">
                            <i class="fas fa-sync-alt"></i>
                        </button>
                    </div>
                </div>
                <div class="table-container">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>کاربر</th>
                                <th>موضوع</th>
                                <th>پیام</th>
                                <th>تاریخ</th>
                                <th>وضعیت</th>
                                <th>عملیات</th>
                            </tr>
                        </thead>
                        <tbody id="adminSupportTable">
                            <!-- درخواستهای پشتیبانی -->
                        </tbody>
                    </table>
                </div>
            </div>

            <div class="admin-tab-content" id="realtime-tab">
                <div class="tab-header">
                    <h3>بروزرسانی Real-time</h3>
                    <div class="action-buttons">
                        <button class="btn btn-primary" id="startRealtimeBtn">
                            <i class="fas fa-play"></i>
                            شروع بروزرسانی
                        </button>
                        <button class="btn btn-reject" id="stopRealtimeBtn">
                            <i class="fas fa-stop"></i>
                            توقف بروزرسانی
                        </button>
                    </div>
                </div>
                
                <div class="realtime-stats" style="margin-top: 30px;">
                    <div class="admin-stats">
                        <div class="stat-card">
                            <h3>رانندگان آنلاین</h3>
                            <div class="value" id="onlineDrivers">0</div>
                            <div class="change positive"><i class="fas fa-circle"></i> آنلاین</div>
                        </div>
                        <div class="stat-card">
                            <h3>سفرهای فعال</h3>
                            <div class="value" id="activeTrips">0</div>
                            <div class="change positive"><i class="fas fa-road"></i> در حال انجام</div>
                        </div>
                        <div class="stat-card">
                            <h3>درخواست‌های جدید</h3>
                            <div class="value" id="newRequests">0</div>
                            <div class="change positive"><i class="fas fa-clock"></i> در ۵ دقیقه گذشته</div>
                        </div>
                        <div class="stat-card">
                            <h3>کاربران فعال</h3>
                            <div class="value" id="activeUsersRealtime">0</div>
                            <div class="change positive"><i class="fas fa-users"></i> در حال حاضر</div>
                        </div>
                    </div>
                    
                    <div class="realtime-updates" style="margin-top: 40px;">
                        <h3>آخرین بروزرسانی‌ها</h3>
                        <div class="table-container">
                            <table class="data-table">
                                <thead>
                                    <tr>
                                        <th>زمان</th>
                                        <th>نوع</th>
                                        <th>توضیحات</th>
                                        <th>وضعیت</th>
                                    </tr>
                                </thead>
                                <tbody id="realtimeUpdatesTable">
                                    <!-- بروزرسانی‌های real-time -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- مدال راننده -->
    <div class="modal" id="driverModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title"><i class="fas fa-check-circle"></i> راننده پیدا شد!</h2>
                <button class="close-modal" id="closeModal">&times;</button>
            </div>
            
            <div class="driver-info">
                <div class="driver-details">
                    <div class="driver-avatar" id="driverAvatar">ا</div>
                    <div class="driver-name-rating">
                        <h3 id="driverName">احمد ظاهر</h3>
                        <div class="driver-rating">
                            <span class="stars">
                                <i class="fas fa-star"></i>
                                <i class="fas fa-star"></i>
                                <i class="fas fa-star"></i>
                                <i class="fas fa-star"></i>
                                <i class="fas fa-star-half-alt"></i>
                            </span>
                            <span id="driverRating">۴.۷</span>
                            <span id="driverTrips">(۱۲۵ سفر)</span>
                        </div>
                    </div>
                </div>
                
                <div class="car-details">
                    <div class="car-info">
                        <div class="car-model" id="carModel">تویوتا کورولا</div>
                        <div class="car-color" id="carColor">سفید</div>
                    </div>
                    <div class="car-plate" id="plateNumber">کابل ۱۲۳۴</div>
                </div>
            </div>
            
            <div class="trip-info">
                <div class="trip-detail">
                    <i class="fas fa-clock"></i>
                    <span>زمان رسیدن</span>
                    <div class="value" id="eta">۴ دقیقه</div>
                </div>
                <div class="trip-detail">
                    <i class="fas fa-road"></i>
                    <span>مسافت</span>
                    <div class="value" id="distance">۲.۸ کیلومتر</div>
                </div>
                <div class="trip-detail">
                    <i class="fas fa-money-bill-wave"></i>
                    <span>هزینه</span>
                    <div class="value" id="price">۱۵۰ افغانی</div>
                </div>
            </div>
            
            <div class="modal-actions">
                <button class="btn btn-outline" id="cancelRide">
                    <i class="fas fa-times"></i>
                    لغو سفر
                </button>
                <button class="btn btn-primary" id="confirmRide">
                    <i class="fas fa-check"></i>
                    تأیید سفر
                </button>
            </div>
        </div>
    </div>

    <!-- مدال امتیازدهی -->
    <div class="modal" id="ratingModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title"><i class="fas fa-star"></i> امتیازدهی به راننده</h2>
                <button class="close-modal" id="closeRatingModal">&times;</button>
            </div>
            
            <div style="text-align: center; padding: 20px 0;">
                <div class="driver-details" style="justify-content: center; margin-bottom: 25px;">
                    <div class="driver-avatar" id="ratingDriverAvatar">ا</div>
                    <div class="driver-name-rating">
                        <h3 id="ratingDriverName">احمد ظاهر</h3>
                    </div>
                </div>
                
                <p style="margin-bottom: 20px; font-size: 16px; color: var(--gray);">لطفاً به راننده امتیاز دهید</p>
                
                <div class="rating-stars" id="ratingStars">
                    <i class="fas fa-star rating-star" data-rating="1"></i>
                    <i class="fas fa-star rating-star" data-rating="2"></i>
                    <i class="fas fa-star rating-star" data-rating="3"></i>
                    <i class="fas fa-star rating-star" data-rating="4"></i>
                    <i class="fas fa-star rating-star" data-rating="5"></i>
                </div>
                
                <textarea id="ratingComment" placeholder="نظر خود را بنویسید (اختیاری)" style="width: 100%; padding: 15px; border: 1px solid var(--border); border-radius: 12px; margin-top: 20px; resize: vertical; min-height: 100px; font-family: inherit; font-size: 14px;"></textarea>
            </div>
            
            <div class="modal-actions">
                <button class="btn btn-primary" id="submitRating">
                    <i class="fas fa-paper-plane"></i>
                    ثبت امتیاز
                </button>
            </div>
        </div>
    </div>

    <!-- مدال پرداخت -->
    <div class="modal" id="paymentModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title"><i class="fas fa-credit-card"></i> پرداخت</h2>
                <button class="close-modal" id="closePaymentModal">&times;</button>
            </div>
            
            <div style="padding: 20px 0;">
                <div class="trip-info">
                    <div class="trip-detail">
                        <i class="fas fa-road"></i>
                        <span>مسافت</span>
                        <div class="value" id="paymentDistance">۲.۸ کیلومتر</div>
                    </div>
                    <div class="trip-detail">
                        <i class="fas fa-money-bill-wave"></i>
                        <span>هزینه</span>
                        <div class="value" id="paymentPrice">۱۵۰ افغانی</div>
                    </div>
                </div>
                
                <div class="form-group" style="margin-top: 25px;">
                    <label><i class="fas fa-credit-card"></i> روش پرداخت</label>
                    <div class="payment-methods">
                        <div class="payment-method selected" data-method="cash">
                            <i class="fas fa-money-bill-wave"></i>
                            <span>نقدی</span>
                        </div>
                        <div class="payment-method" data-method="wallet">
                            <i class="fas fa-wallet"></i>
                            <span>کیف پول</span>
                        </div>
                    </div>
                </div>
                
                <div id="walletPayment" style="display: none; margin-top: 20px;">
                    <div class="form-group">
                        <label>موجودی کیف پول:</label>
                        <div style="font-size: 24px; font-weight: 700; color: var(--primary); text-align: center; margin: 10px 0;">
                            <span id="walletBalance">۵۰۰</span> افغانی
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="modal-actions">
                <button class="btn btn-outline" id="cancelPayment">
                    <i class="fas fa-times"></i>
                    انصراف
                </button>
                <button class="btn btn-primary" id="confirmPayment">
                    <i class="fas fa-check"></i>
                    پرداخت
                </button>
            </div>
        </div>
    </div>

    <!-- مدال ورود/ثبتنام -->
    <div class="modal" id="authModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title"><i class="fas fa-user"></i> ورود / ثبتنام</h2>
                <button class="close-modal" id="closeAuthModal">&times;</button>
            </div>
            
            <div class="form-tabs">
                <div class="form-tab active" data-tab="login">ورود</div>
                <div class="form-tab" data-tab="register">ثبتنام</div>
            </div>
            
            <div class="form-tab-content active" id="login-tab">
                <form class="auth-form" id="loginForm">
                    <div class="form-group">
                        <label for="loginEmail">ایمیل یا شماره تماس</label>
                        <div class="input-with-icon">
                            <i class="fas fa-envelope input-icon"></i>
                            <input type="text" id="loginEmail" class="form-input" placeholder="ایمیل یا شماره تماس خود را وارد کنید" required>
                        </div>
                        <div class="error-message" id="loginEmailError"></div>
                    </div>
                    <div class="form-group">
                        <label for="loginPassword">رمز عبور</label>
                        <div class="input-with-icon">
                            <i class="fas fa-lock input-icon"></i>
                            <input type="password" id="loginPassword" class="form-input" placeholder="رمز عبور خود را وارد کنید" required>
                            <button type="button" class="password-toggle" id="loginPasswordToggle">
                                <i class="fas fa-eye"></i>
                            </button>
                        </div>
                        <div class="error-message" id="loginPasswordError"></div>
                    </div>
                    <div class="form-footer">
                        <a href="#" id="forgotPassword">رمز عبور خود را فراموش کردهاید؟</a>
                    </div>
                    <button type="submit" class="btn btn-primary" id="loginSubmitBtn">
                        <i class="fas fa-sign-in-alt"></i>
                        ورود
                    </button>
                </form>
            </div>
            
            <div class="form-tab-content" id="register-tab">
                <form class="auth-form" id="registerForm">
                    <div class="form-group">
                        <label for="registerName">نام کامل</label>
                        <div class="input-with-icon">
                            <i class="fas fa-user input-icon"></i>
                            <input type="text" id="registerName" class="form-input" placeholder="نام کامل خود را وارد کنید" required>
                        </div>
                        <div class="error-message" id="registerNameError"></div>
                    </div>
                    <div class="form-group">
                        <label for="registerEmail">ایمیل</label>
                        <div class="input-with-icon">
                            <i class="fas fa-envelope input-icon"></i>
                            <input type="email" id="registerEmail" class="form-input" placeholder="ایمیل خود را وارد کنید" required>
                        </div>
                        <div class="error-message" id="registerEmailError"></div>
                    </div>
                    <div class="form-group">
                        <label for="registerPhone">شماره تماس</label>
                        <div class="input-with-icon">
                            <i class="fas fa-phone input-icon"></i>
                            <input type="tel" id="registerPhone" class="form-input" placeholder="شماره تماس خود را وارد کنید" required>
                        </div>
                        <div class="error-message" id="registerPhoneError"></div>
                    </div>
                    <div class="form-group">
                        <label for="registerPassword">رمز عبور</label>
                        <div class="input-with-icon">
                            <i class="fas fa-lock input-icon"></i>
                            <input type="password" id="registerPassword" class="form-input" placeholder="رمز عبور خود را وارد کنید" required>
                            <button type="button" class="password-toggle" id="registerPasswordToggle">
                                <i class="fas fa-eye"></i>
                            </button>
                        </div>
                        <div class="error-message" id="registerPasswordError"></div>
                    </div>
                    <div class="form-group">
                        <label for="registerConfirmPassword">تکرار رمز عبور</label>
                        <div class="input-with-icon">
                            <i class="fas fa-lock input-icon"></i>
                            <input type="password" id="registerConfirmPassword" class="form-input" placeholder="رمز عبور خود را مجدداً وارد کنید" required>
                            <button type="button" class="password-toggle" id="registerConfirmPasswordToggle">
                                <i class="fas fa-eye"></i>
                            </button>
                        </div>
                        <div class="error-message" id="registerConfirmPasswordError"></div>
                    </div>
                    <div class="form-group">
                        <label for="userType">نوع کاربر</label>
                        <select id="userType" class="form-input" required style="padding: 15px 20px;">
                            <option value="">انتخاب کنید</option>
                            <option value="passenger">مسافر</option>
                            <option value="driver">راننده</option>
                        </select>
                        <div class="error-message" id="userTypeError"></div>
                    </div>
                    <div class="form-footer">
                        با ثبتنام، <a href="#">قوانین و مقررات</a> اسنپ افغانستان را میپذیرید.
                    </div>
                    <button type="submit" class="btn btn-primary" id="registerSubmitBtn">
                        <i class="fas fa-user-plus"></i>
                        ثبتنام
                    </button>
                </form>
            </div>
        </div>
    </div>

    <!-- مدال بازیابی رمز عبور -->
    <div class="modal" id="forgotPasswordModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title"><i class="fas fa-key"></i> بازیابی رمز عبور</h2>
                <button class="close-modal" id="closeForgotPasswordModal">&times;</button>
            </div>
            
            <form class="auth-form" id="forgotPasswordForm">
                <div class="form-group">
                    <label for="forgotPasswordEmail">ایمیل یا شماره تماس</label>
                    <div class="input-with-icon">
                        <i class="fas fa-envelope input-icon"></i>
                        <input type="text" id="forgotPasswordEmail" class="form-input" placeholder="ایمیل یا شماره تماس خود را وارد کنید" required>
                    </div>
                    <div class="error-message" id="forgotPasswordEmailError"></div>
                </div>
                <div class="form-footer">
                    لینک بازیابی رمز عبور به ایمیل یا شماره تماس شما ارسال خواهد شد.
                </div>
                <button type="submit" class="btn btn-primary" id="forgotPasswordSubmitBtn">
                    <i class="fas fa-paper-plane"></i>
                    ارسال لینک بازیابی
                </button>
            </form>
        </div>
    </div>

    <!-- مدال افزودن راننده -->
    <div class="modal" id="addDriverModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title"><i class="fas fa-user-plus"></i> افزودن راننده جدید</h2>
                <button class="close-modal" id="closeAddDriverModal">&times;</button>
            </div>
            
            <form class="auth-form" id="addDriverForm">
                <div class="form-group">
                    <label for="driverNameInput">نام کامل</label>
                    <input type="text" id="driverNameInput" class="form-input" placeholder="نام کامل راننده" required>
                </div>
                <div class="form-group">
                    <label for="driverEmailInput">ایمیل</label>
                    <input type="email" id="driverEmailInput" class="form-input" placeholder="ایمیل راننده" required>
                </div>
                <div class="form-group">
                    <label for="driverPhoneInput">شماره تماس</label>
                    <input type="tel" id="driverPhoneInput" class="form-input" placeholder="شماره تماس راننده" required>
                </div>
                <div class="form-group">
                    <label for="vehicleTypeInput">نوع وسیله</label>
                    <select id="vehicleTypeInput" class="form-input" required style="padding: 15px 20px;">
                        <option value="car">خودرو</option>
                        <option value="bike">موتور</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="carModelInput">مدل خودرو</label>
                    <input type="text" id="carModelInput" class="form-input" placeholder="مدل خودرو" required>
                </div>
                <div class="form-group">
                    <label for="carColorInput">رنگ خودرو</label>
                    <input type="text" id="carColorInput" class="form-input" placeholder="رنگ خودرو" required>
                </div>
                <div class="form-group">
                    <label for="plateNumberInput">شماره پلاک</label>
                    <input type="text" id="plateNumberInput" class="form-input" placeholder="شماره پلاک" required>
                </div>
                <div class="form-group">
                    <label for="driverLicenseInput">شماره گواهینامه</label>
                    <input type="text" id="driverLicenseInput" class="form-input" placeholder="شماره گواهینامه" required>
                </div>
                <button type="submit" class="btn btn-primary">
                    <i class="fas fa-plus-circle"></i>
                    افزودن راننده
                </button>
            </form>
        </div>
    </div>

    <!-- مدال افزودن تخفیف -->
    <div class="modal" id="addDiscountModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title"><i class="fas fa-tag"></i> افزودن تخفیف جدید</h2>
                <button class="close-modal" id="closeAddDiscountModal">&times;</button>
            </div>
            
            <form class="auth-form" id="addDiscountForm">
                <div class="form-group">
                    <label for="discountCodeInput">کد تخفیف</label>
                    <input type="text" id="discountCodeInput" class="form-input" placeholder="کد تخفیف" required>
                </div>
                <div class="form-group">
                    <label for="discountPercentInput">درصد تخفیف</label>
                    <input type="number" id="discountPercentInput" class="form-input" placeholder="درصد تخفیف" min="1" max="100" required>
                </div>
                <div class="form-group">
                    <label for="discountExpiryInput">تاریخ انقضا</label>
                    <input type="date" id="discountExpiryInput" class="form-input" required>
                </div>
                <div class="form-group">
                    <label for="maxUsesInput">حداکثر استفاده</label>
                    <input type="number" id="maxUsesInput" class="form-input" placeholder="حداکثر تعداد استفاده" min="1" required>
                </div>
                <button type="submit" class="btn btn-primary">
                    <i class="fas fa-plus-circle"></i>
                    افزودن تخفیف
                </button>
            </form>
        </div>
    </div>

    <!-- نوتیفیکیشن -->
    <div class="notification" id="notification"></div>

    <!-- فوتر -->
    <footer style="display: none;" id="main-footer">
        <div class="container">
            <div class="footer-content">
                <div class="footer-column">
                    <h3>اسنپ افغانستان</h3>
                    <ul class="footer-links">
                        <li><a href="#"><i class="fas fa-info-circle"></i> درباره ما</a></li>
                        <li><a href="#"><i class="fas fa-briefcase"></i> فرصتهای کاری</a></li>
                        <li><a href="#"><i class="fas fa-phone"></i> تماس با ما</a></li>
                        <li><a href="#"><i class="fas fa-blog"></i> وبلاگ</a></li>
                    </ul>
                </div>
                <div class="footer-column">
                    <h3>خدمات</h3>
                    <ul class="footer-links">
                        <li><a href="#"><i class="fas fa-taxi"></i> تاکسی</a></li>
                        <li><a href="#"><i class="fas fa-shipping-fast"></i> پیک</a></li>
                        <li><a href="#"><i class="fas fa-motorcycle"></i> موتور</a></li>
                        <li><a href="#"><i class="fas fa-shopping-cart"></i> بازار</a></li>
                    </ul>
                </div>
                <div class="footer-column">
                    <h3>مسافران</h3>
                    <ul class="footer-links">
                        <li><a href="#"><i class="fas fa-mobile-alt"></i> دانلود اپلیکیشن</a></li>
                        <li><a href="#"><i class="fas fa-gavel"></i> قوانین و مقررات</a></li>
                        <li><a href="#"><i class="fas fa-question-circle"></i> سوالات متداول</a></li>
                        <li><a href="#"><i class="fas fa-shield-alt"></i> حریم خصوصی</a></li>
                    </ul>
                </div>
                <div class="footer-column">
                    <h3>ارتباط با ما</h3>
                    <p><i class="fas fa-headset"></i> پشتیبانی ۲۴ ساعته</p>
                    <p><i class="fas fa-phone"></i> شماره: ۰۷۰۰۱۲۳۴۵۶</p>
                    <div class="social-links">
                        <a href="#"><i class="fab fa-whatsapp"></i></a>
                        <a href="#"><i class="fab fa-telegram"></i></a>
                        <a href="#"><i class="fab fa-facebook"></i></a>
                        <a href="#"><i class="fab fa-twitter"></i></a>
                    </div>
                </div>
            </div>
            <div class="footer-bottom">
                <p>© ۱۴۰۳ اسنپ افغانستان. تمامی حقوق محفوظ است.</p>
            </div>
        </div>
    </footer>

    <script>
        // اتصال به Supabase
        const SUPABASE_URL = 'https://ewzgpfpllwhhrjupqyvy.supabase.co';
        const SUPABASE_KEY = 'sb_secret_muUrFpyuPZkgm2Nd8gbblA_ovzxgAbc';

        const supabase = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        // متغیرهای سیستم
        let currentUser = null;
        let isAdmin = false;
        let selectedRideType = 'economy';
        let selectedPaymentMethod = 'cash';
        let currentDistance = 0;
        let currentPrice = 0;
        let currentTripId = null;
        let currentDriver = null;
        let map = null;
        let userMarker = null;
        let driverMarker = null;
        let routeLayer = null;
        let trackingInterval = null;
        let realtimeSubscription = null;
        let driverMarkers = {};

        // مختصات نقاط مهم کابل
        const kabulLocations = {
            "میدان هوایی بین المللی کابل": [34.5658, 69.2122],
            "کارته سخی": [34.5333, 69.1667],
            "کارته چهار": [34.5167, 69.1833],
            "شهر نو": [34.5300, 69.1700],
            "دشت برچی": [34.4731, 69.1094],
            "قلعه نور": [34.5417, 69.1750],
            "پغمان": [34.5833, 68.9500],
            "خیرخانه": [34.5500, 69.1167],
            "قلعه فتح الله": [34.5167, 69.1667],
            "مکروریان": [34.4667, 69.0833],
            "سفارت امریکا": [34.5344, 69.1889],
            "سفارت ایران": [34.5311, 69.1728],
            "سفارت پاکستان": [34.5250, 69.1806],
            "سفارت ترکیه": [34.5283, 69.1917],
            "ارگ ریاست جمهوری": [34.5250, 69.1750],
            "وزارت امور خارجه": [34.5306, 69.1694],
            "وزارت داخله": [34.5283, 69.1739],
            "وزارت دفاع": [34.5258, 69.1778],
            "بازار کابل": [34.5167, 69.1833],
            "بازار کارته سخی": [34.5333, 69.1667],
            "بازار شورا": [34.5233, 69.1767],
            "پوهنتون کابل": [34.5167, 69.1333],
            "پوهنتون پولی تخنیک کابل": [34.4700, 69.1170],
            "پوهنتون ابن سینا": [34.5133, 69.1667],
            "شفاخانه علی آباد": [34.5317, 69.1844],
            "شفاخانه جمهوریت": [34.5200, 69.1750],
            "شفاخانه ایندیانا": [34.5150, 69.1800]
        };

        // مناطق کابل
        const kabulDistricts = [
            "کارته سخی", "کارته چهار", "شهر نو", "دشت برچی", "قلعه نور",
            "قلعه فتح الله", "پغمان", "مکروریان", "خیرخانه", "قلعه ذوالفقار",
            "چندول", "ده سبز", "افشار", "قره باغ", "بگرامی", "نادر پشته",
            "کارته پروان", "کارته منصور", "کارته خوشحال", "کارته سید"
        ];

        // توابع کمکی
        function showNotification(message, type = 'success') {
            const notification = document.getElementById('notification');
            notification.textContent = message;
            notification.className = `notification ${type}`;
            notification.style.display = 'block';
            
            setTimeout(() => {
                notification.style.display = 'none';
            }, 5000);
        }

        function clearErrors() {
            document.querySelectorAll('.error-message').forEach(el => {
                el.style.display = 'none';
            });
            document.querySelectorAll('.form-input').forEach(el => {
                el.style.borderColor = 'var(--border)';
            });
        }

        function showError(inputId, message) {
            const errorElement = document.getElementById(inputId + 'Error');
            const inputElement = document.getElementById(inputId);
            
            if (errorElement && inputElement) {
                errorElement.textContent = message;
                errorElement.style.display = 'block';
                inputElement.style.borderColor = 'var(--accent)';
            }
        }

        // محاسبه مسافت دقیق با استفاده از فرمول Haversine
        function calculateDistance(lat1, lon1, lat2, lon2) {
            const R = 6371; // شعاع زمین در کیلومتر
            const dLat = toRad(lat2 - lat1);
            const dLon = toRad(lon2 - lon1);
            const a = Math.sin(dLat / 2) * Math.sin(dLat / 2) +
                     Math.cos(toRad(lat1)) * Math.cos(toRad(lat2)) *
                     Math.sin(dLon / 2) * Math.sin(dLon / 2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
            return R * c; // فاصله در کیلومتر
        }

        function toRad(degrees) {
            return degrees * (Math.PI / 180);
        }

        // تبدیل درجه به رادیان برای محاسبات مثلثاتی
        function deg2rad(deg) {
            return deg * (Math.PI / 180);
        }

        // گرفتن مختصات از نام مکان
        async function getCoordinates(locationName) {
            if (kabulLocations[locationName]) {
                return kabulLocations[locationName];
            }
            
            // اگر مکان در لیست نبود، از Nominatim استفاده می‌کنیم
            try {
                const response = await fetch(
                    `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(locationName + ', Kabul, Afghanistan')}`
                );
                const data = await response.json();
                
                if (data && data.length > 0) {
                    return [parseFloat(data[0].lat), parseFloat(data[0].lon)];
                }
            } catch (error) {
                console.error('Error getting coordinates:', error);
            }
            
            // در صورت عدم موفقیت، مختصات مرکز کابل
            return [34.5553, 69.2075];
        }

        // محاسبه مسافت و قیمت
        async function calculateDistanceAndPrice() {
            const pickupInput = document.getElementById('pickup');
            const destinationInput = document.getElementById('destination');
            const tripCalculator = document.getElementById('tripCalculator');
            
            if (!pickupInput || !destinationInput || !tripCalculator) return;
            
            const pickup = pickupInput.value.trim();
            const destination = destinationInput.value.trim();

            if (!pickup || !destination) {
                tripCalculator.classList.remove('active');
                return;
            }

            try {
                const pickupCoords = await getCoordinates(pickup);
                const destinationCoords = await getCoordinates(destination);
                
                currentDistance = calculateDistance(
                    pickupCoords[0], pickupCoords[1],
                    destinationCoords[0], destinationCoords[1]
                );
                
                // رسم مسیر روی نقشه
                drawRouteOnMap(pickupCoords, destinationCoords);
                
                // نمایش معلومات مسافت
                const distanceValue = document.getElementById('distanceValue');
                if (distanceValue) distanceValue.textContent = `${currentDistance.toFixed(2)} کیلومتر`;
                
                tripCalculator.classList.add('active');
                updatePrice();
            } catch (error) {
                console.error('Error calculating distance:', error);
                showNotification('خطا در محاسبه مسافت. لطفاً آدرس‌ها را بررسی کنید.', 'error');
            }
        }

        function updatePrice() {
            if (currentDistance === 0) return;

            const selectedRide = document.querySelector('.ride-type.selected');
            if (!selectedRide) return;
            
            const baseFare = parseInt(selectedRide.dataset.baseFare);
            const distanceFare = Math.round(currentDistance * 15); // 15 افغانی به ازای هر کیلومتر
            const totalFare = baseFare + distanceFare;

            currentPrice = totalFare;

            // نمایش جزئیات قیمت
            const baseFareValue = document.getElementById('baseFareValue');
            const distanceFareValue = document.getElementById('distanceFareValue');
            const totalFareValue = document.getElementById('totalFareValue');
            
            if (baseFareValue) baseFareValue.textContent = `${baseFare} افغانی`;
            if (distanceFareValue) distanceFareValue.textContent = `${distanceFare} افغانی`;
            if (totalFareValue) totalFareValue.textContent = `${totalFare} افغانی`;

            // بهروزرسانی قیمت در کارتها
            const economyPrice = document.getElementById('economyPrice');
            const comfortPrice = document.getElementById('comfortPrice');
            const bikePrice = document.getElementById('bikePrice');
            
            if (economyPrice) economyPrice.textContent = `${calculateRidePrice('economy')} افغانی`;
            if (comfortPrice) comfortPrice.textContent = `${calculateRidePrice('comfort')} افغانی`;
            if (bikePrice) bikePrice.textContent = `${calculateRidePrice('bike')} افغانی`;
        }

        function calculateRidePrice(type) {
            const baseFares = {
                economy: 50,
                comfort: 80,
                bike: 30
            };
            return baseFares[type] + Math.round(currentDistance * 15);
        }

        // مدیریت نقشه
        function initMap() {
            if (map) return;
            
            // ایجاد نقشه با مرکزیت کابل
            map = L.map('map').setView([34.5553, 69.2075], 13);
            
            // اضافه کردن لایه OpenStreetMap
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; OpenStreetMap contributors',
                maxZoom: 19
            }).addTo(map);
            
            // اضافه کردن نقاط مهم
            addImportantLocations();
            addDistrictControls();
        }

        function addImportantLocations() {
            Object.entries(kabulLocations).forEach(([name, coords]) => {
                const marker = L.marker(coords).addTo(map);
                marker.bindPopup(`<b>${name}</b>`);
                
                marker.on('click', () => {
                    const pickupInput = document.getElementById('pickup');
                    const destinationInput = document.getElementById('destination');
                    
                    if (!pickupInput || !destinationInput) return;
                    
                    if (!pickupInput.value) {
                        pickupInput.value = name;
                        showNotification(`مبدا به "${name}" تنظیم شد`, 'info');
                    } else if (!destinationInput.value) {
                        destinationInput.value = name;
                        showNotification(`مقصد به "${name}" تنظیم شد`, 'info');
                    } else {
                        if (confirm(`آیا میخواهید "${name}" را به عنوان مقصد انتخاب کنید؟`)) {
                            destinationInput.value = name;
                            showNotification(`مقصد به "${name}" تنظیم شد`, 'info');
                        }
                    }
                    calculateDistanceAndPrice();
                });
            });
        }

        function addDistrictControls() {
            const districtsGrid = document.getElementById('districtsGrid');
            if (!districtsGrid) return;
            
            districtsGrid.innerHTML = '';
            
            kabulDistricts.forEach(district => {
                const districtItem = document.createElement('div');
                districtItem.className = 'district-item';
                districtItem.textContent = district;
                
                districtItem.addEventListener('click', () => {
                    const pickupInput = document.getElementById('pickup');
                    const destinationInput = document.getElementById('destination');
                    
                    if (!pickupInput || !destinationInput) return;
                    
                    if (!pickupInput.value) {
                        pickupInput.value = district;
                        showNotification(`مبدا به "${district}" تنظیم شد`, 'info');
                    } else if (!destinationInput.value) {
                        destinationInput.value = district;
                        showNotification(`مقصد به "${district}" تنظیم شد`, 'info');
                    } else {
                        if (confirm(`آیا میخواهید "${district}" را به عنوان مقصد انتخاب کنید؟`)) {
                            destinationInput.value = district;
                            showNotification(`مقصد به "${district}" تنظیم شد`, 'info');
                        }
                    }
                    calculateDistanceAndPrice();
                });
                
                districtsGrid.appendChild(districtItem);
            });
        }

        // رسم مسیر روی نقشه
        function drawRouteOnMap(startCoords, endCoords) {
            // پاک کردن مسیر قبلی
            if (routeLayer) {
                map.removeLayer(routeLayer);
            }
            
            // رسم خط مسیر
            routeLayer = L.polyline([startCoords, endCoords], {
                color: '#00D474',
                weight: 4,
                opacity: 0.8,
                dashArray: '10, 10'
            }).addTo(map);
            
            // اضافه کردن نشانگر مبدا
            if (userMarker) {
                map.removeLayer(userMarker);
            }
            
            userMarker = L.marker(startCoords, {
                icon: L.divIcon({
                    className: 'passenger-marker',
                    html: '<i class="fas fa-user"></i>',
                    iconSize: [30, 30]
                })
            }).addTo(map);
            userMarker.bindPopup('مبدا').openPopup();
            
            // اضافه کردن نشانگر مقصد
            const destinationMarker = L.marker(endCoords, {
                icon: L.divIcon({
                    className: 'location-marker',
                    html: '<i class="fas fa-flag-checkered"></i>',
                    iconSize: [30, 30]
                })
            }).addTo(map);
            destinationMarker.bindPopup('مقصد');
            
            // تنظیم دید نقشه برای نمایش کل مسیر
            const bounds = L.latLngBounds([startCoords, endCoords]);
            map.fitBounds(bounds, { padding: [50, 50] });
        }

        // مدیریت رانندگان روی نقشه
        async function updateDriversOnMap() {
            try {
                const { data: drivers, error } = await supabase
                    .from('drivers')
                    .select('*')
                    .eq('status', 'active')
                    .eq('is_online', true);
                
                if (error) throw error;
                
                // پاک کردن مارکرهای قبلی
                Object.values(driverMarkers).forEach(marker => {
                    if (marker) map.removeLayer(marker);
                });
                driverMarkers = {};
                
                // اضافه کردن رانندگان جدید
                drivers.forEach(driver => {
                    if (driver.current_location) {
                        const coords = [
                            driver.current_location.latitude,
                            driver.current_location.longitude
                        ];
                        
                        const iconClass = driver.vehicle_type === 'bike' ? 'bike-icon' : 'car-icon';
                        const iconHtml = driver.vehicle_type === 'bike' ? 
                            '<i class="fas fa-motorcycle"></i>' : 
                            '<i class="fas fa-car"></i>';
                        
                        const marker = L.marker(coords, {
                            icon: L.divIcon({
                                className: iconClass,
                                html: iconHtml,
                                iconSize: [30, 30]
                            })
                        }).addTo(map);
                        
                        marker.bindPopup(`
                            <b>${driver.name}</b><br>
                            ${driver.vehicle_type === 'car' ? 'خودرو' : 'موتور'}<br>
                            ${driver.car_model || ''}<br>
                            امتیاز: ${driver.rating || 'جدید'}
                        `);
                        
                        driverMarkers[driver.id] = marker;
                    }
                });
            } catch (error) {
                console.error('Error updating drivers on map:', error);
            }
        }

        // سیستم احراز هویت
        async function loginUser(email, password) {
            try {
                const { data, error } = await supabase
                    .from('users')
                    .select('*')
                    .or(`email.eq.${email},phone.eq.${email}`)
                    .single();
                
                if (error) throw error;
                
                // بررسی رمز عبور (در پروژه واقعی باید از رمزنگاری استفاده شود)
                if (data.password !== password) {
                    throw new Error('رمز عبور اشتباه است');
                }
                
                if (data.status !== 'approved') {
                    throw new Error('حساب کاربری شما هنوز تایید نشده است');
                }
                
                currentUser = data;
                isAdmin = currentUser.role === 'admin';
                localStorage.setItem('snapp_current_user', JSON.stringify(currentUser));
                
                showNotification(`خوش آمدید ${currentUser.name}`, 'success');
                updateUIAfterLogin();
                return true;
            } catch (error) {
                console.error('Login error:', error);
                showNotification(error.message, 'error');
                return false;
            }
        }

        async function registerUser(userData) {
            try {
                // بررسی تکراری نبودن ایمیل و شماره تماس
                const { data: existingUsers, error: checkError } = await supabase
                    .from('users')
                    .select('*')
                    .or(`email.eq.${userData.email},phone.eq.${userData.phone}`);
                
                if (checkError) throw checkError;
                
                if (existingUsers.length > 0) {
                    throw new Error('ایمیل یا شماره تماس قبلاً ثبت شده است');
                }
                
                // ثبت کاربر جدید
                const { data, error } = await supabase
                    .from('users')
                    .insert([{
                        ...userData,
                        status: 'pending',
                        wallet_balance: 0,
                        rating: 0,
                        created_at: new Date().toISOString()
                    }])
                    .select()
                    .single();
                
                if (error) throw error;
                
                showNotification('ثبتنام شما با موفقیت انجام شد. پس از تایید مدیر میتوانید وارد شوید.', 'success');
                return true;
            } catch (error) {
                console.error('Registration error:', error);
                showNotification(error.message, 'error');
                return false;
            }
        }

        function updateUIAfterLogin() {
            const loginBtn = document.getElementById('loginBtn');
            const logoutBtn = document.getElementById('logoutBtn');
            const mobileLoginBtn = document.getElementById('mobileLoginBtn');
            const mobileLogoutBtn = document.getElementById('mobileLogoutBtn');
            const userProfile = document.getElementById('userProfile');
            const userAvatar = document.getElementById('userAvatar');
            const userName = document.getElementById('userName');
            
            if (loginBtn) loginBtn.style.display = 'none';
            if (logoutBtn) logoutBtn.style.display = 'block';
            if (mobileLoginBtn) mobileLoginBtn.style.display = 'none';
            if (mobileLogoutBtn) mobileLogoutBtn.style.display = 'block';
            if (userProfile) userProfile.style.display = 'flex';
            
            if (userAvatar && currentUser) {
                userAvatar.textContent = currentUser.name.charAt(0);
            }
            if (userName && currentUser) {
                userName.textContent = currentUser.name;
            }
            
            if (isAdmin) {
                const adminLink = document.getElementById('adminLink');
                const mobileAdminLink = document.getElementById('mobileAdminLink');
                if (adminLink) adminLink.style.display = 'block';
                if (mobileAdminLink) mobileAdminLink.style.display = 'block';
            }
            
            updateProfilePage();
        }

        function updateUIAfterLogout() {
            const loginBtn = document.getElementById('loginBtn');
            const logoutBtn = document.getElementById('logoutBtn');
            const mobileLoginBtn = document.getElementById('mobileLoginBtn');
            const mobileLogoutBtn = document.getElementById('mobileLogoutBtn');
            const userProfile = document.getElementById('userProfile');
            
            if (loginBtn) loginBtn.style.display = 'block';
            if (logoutBtn) logoutBtn.style.display = 'none';
            if (mobileLoginBtn) mobileLoginBtn.style.display = 'block';
            if (mobileLogoutBtn) mobileLogoutBtn.style.display = 'none';
            if (userProfile) userProfile.style.display = 'none';
            
            const adminLink = document.getElementById('adminLink');
            const mobileAdminLink = document.getElementById('mobileAdminLink');
            if (adminLink) adminLink.style.display = 'none';
            if (mobileAdminLink) mobileAdminLink.style.display = 'none';
            
            document.querySelectorAll('.page').forEach(page => page.classList.remove('active'));
            const homePage = document.getElementById('home-page');
            if (homePage) homePage.classList.add('active');
        }

        async function logout() {
            if (currentUser) {
                // آفلاین کردن راننده در صورت نیاز
                if (currentUser.role === 'driver') {
                    await supabase
                        .from('drivers')
                        .update({ is_online: false })
                        .eq('user_id', currentUser.id);
                }
            }
            
            currentUser = null;
            isAdmin = false;
            localStorage.removeItem('snapp_current_user');
            showNotification('با موفقیت خارج شدید', 'success');
            updateUIAfterLogout();
        }

        // مدیریت سفر
        async function createTrip(tripData) {
            try {
                const { data, error } = await supabase
                    .from('trips')
                    .insert([{
                        ...tripData,
                        status: 'requested',
                        created_at: new Date().toISOString()
                    }])
                    .select()
                    .single();
                
                if (error) throw error;
                
                currentTripId = data.id;
                return data;
            } catch (error) {
                console.error('Error creating trip:', error);
                throw error;
            }
        }

        async function findNearestDriver(pickupCoords, rideType) {
            try {
                const { data: drivers, error } = await supabase
                    .from('drivers')
                    .select('*')
                    .eq('status', 'active')
                    .eq('is_online', true)
                    .eq('vehicle_type', rideType === 'bike' ? 'bike' : 'car');
                
                if (error) throw error;
                
                if (drivers.length === 0) {
                    return null;
                }
                
                // محاسبه فاصله هر راننده از مبدا
                const driversWithDistance = drivers.map(driver => {
                    if (!driver.current_location) {
                        driver.distance = Infinity;
                        return driver;
                    }
                    
                    const driverCoords = [
                        driver.current_location.latitude,
                        driver.current_location.longitude
                    ];
                    
                    const distance = calculateDistance(
                        pickupCoords[0], pickupCoords[1],
                        driverCoords[0], driverCoords[1]
                    );
                    
                    return {
                        ...driver,
                        distance,
                        eta: Math.max(2, Math.round(distance * 3)) // تخمین زمان بر اساس مسافت
                    };
                });
                
                // مرتب‌سازی بر اساس فاصله
                driversWithDistance.sort((a, b) => a.distance - b.distance);
                
                return driversWithDistance[0];
            } catch (error) {
                console.error('Error finding nearest driver:', error);
                return null;
            }
        }

        // سیستم Real-time با Supabase
        function setupRealtimeUpdates() {
            // لغو سابسکریپشن قبلی
            if (realtimeSubscription) {
                supabase.removeSubscription(realtimeSubscription);
            }
            
            // سابسکریپشن برای سفرها
            realtimeSubscription = supabase
                .channel('trips-channel')
                .on('postgres_changes', 
                    { event: '*', schema: 'public', table: 'trips' },
                    (payload) => {
                        console.log('Trip update:', payload);
                        handleTripUpdate(payload);
                    }
                )
                .on('postgres_changes',
                    { event: '*', schema: 'public', table: 'drivers' },
                    (payload) => {
                        console.log('Driver update:', payload);
                        handleDriverUpdate(payload);
                    }
                )
                .subscribe();
        }

        function handleTripUpdate(payload) {
            const { eventType, new: newData, old: oldData } = payload;
            
            if (eventType === 'INSERT') {
                // سفر جدید اضافه شده
                showNotification(`سفر جدید از ${newData.pickup} به ${newData.destination}`, 'info');
                
                if (isAdmin) {
                    loadAdminTrips();
                    updateRealtimeStats();
                }
            } else if (eventType === 'UPDATE') {
                // سفر آپدیت شده
                if (newData.status !== oldData.status) {
                    const statusText = {
                        'requested': 'درخواست شده',
                        'confirmed': 'تأیید شده',
                        'in_progress': 'در حال انجام',
                        'completed': 'تکمیل شده',
                        'cancelled': 'لغو شده'
                    }[newData.status] || newData.status;
                    
                    showNotification(`وضعیت سفر به "${statusText}" تغییر کرد`, 'info');
                    
                    if (currentTripId === newData.id && newData.status === 'in_progress') {
                        startTripTracking(newData);
                    }
                }
                
                if (isAdmin) {
                    loadAdminTrips();
                    updateRealtimeStats();
                }
            }
        }

        function handleDriverUpdate(payload) {
            const { eventType, new: newData } = payload;
            
            if (eventType === 'UPDATE' && newData.is_online !== undefined) {
                updateDriversOnMap();
                
                if (isAdmin) {
                    updateRealtimeStats();
                }
            }
        }

        async function updateRealtimeStats() {
            if (!isAdmin) return;
            
            try {
                // تعداد رانندگان آنلاین
                const { data: onlineDrivers, error: driversError } = await supabase
                    .from('drivers')
                    .select('id', { count: 'exact' })
                    .eq('is_online', true)
                    .eq('status', 'active');
                
                if (!driversError && onlineDrivers) {
                    document.getElementById('onlineDrivers').textContent = onlineDrivers.length;
                }
                
                // تعداد سفرهای فعال
                const { data: activeTrips, error: tripsError } = await supabase
                    .from('trips')
                    .select('id', { count: 'exact' })
                    .eq('status', 'in_progress');
                
                if (!tripsError && activeTrips) {
                    document.getElementById('activeTrips').textContent = activeTrips.length;
                }
                
                // تعداد درخواست‌های جدید در ۵ دقیقه گذشته
                const fiveMinutesAgo = new Date(Date.now() - 5 * 60 * 1000).toISOString();
                const { data: newRequests, error: requestsError } = await supabase
                    .from('trips')
                    .select('id', { count: 'exact' })
                    .gte('created_at', fiveMinutesAgo)
                    .eq('status', 'requested');
                
                if (!requestsError && newRequests) {
                    document.getElementById('newRequests').textContent = newRequests.length;
                }
                
                // اضافه کردن به جدول بروزرسانی‌ها
                const updatesTable = document.getElementById('realtimeUpdatesTable');
                if (updatesTable) {
                    const newRow = document.createElement('tr');
                    newRow.innerHTML = `
                        <td>${new Date().toLocaleTimeString('fa-IR')}</td>
                        <td>${onlineDrivers ? 'رانندگان آنلاین' : 'آمار سیستم'}</td>
                        <td>بروزرسانی آمار سیستم</td>
                        <td><span class="status-badge status-active">موفق</span></td>
                    `;
                    updatesTable.insertBefore(newRow, updatesTable.firstChild);
                    
                    // حفظ فقط ۱۰ رکورد آخر
                    while (updatesTable.children.length > 10) {
                        updatesTable.removeChild(updatesTable.lastChild);
                    }
                }
                
            } catch (error) {
                console.error('Error updating realtime stats:', error);
            }
        }

        // شروع ردیابی سفر
        function startTripTracking(tripData) {
            const liveTracking = document.getElementById('liveTracking');
            if (liveTracking) liveTracking.style.display = 'block';
            
            document.getElementById('trackingDriverName').textContent = tripData.driver_name || 'راننده';
            document.getElementById('trackingETA').textContent = `${tripData.eta || 5} دقیقه`;
            document.getElementById('trackingDistance').textContent = `${tripData.distance || 0} کیلومتر`;
            
            let progress = 0;
            trackingInterval = setInterval(() => {
                progress += 5;
                if (progress > 100) progress = 100;
                
                document.getElementById('trackingProgress').style.width = `${progress}%`;
                
                if (progress >= 100) {
                    clearInterval(trackingInterval);
                    showNotification('شما به مقصد رسیدید!', 'success');
                    openRatingModal();
                }
            }, 3000);
        }

        // مدیریت پنل ادمین
        async function loadAdminPanel() {
            if (!isAdmin) {
                showNotification('شما دسترسی به پنل مدیریت ندارید', 'error');
                document.getElementById('home-page').classList.add('active');
                document.getElementById('admin-page').classList.remove('active');
                return;
            }
            
            try {
                await Promise.all([
                    loadAdminStats(),
                    loadPendingUsers(),
                    loadAllUsers(),
                    loadDrivers(),
                    loadAdminTrips(),
                    loadAdminDiscounts(),
                    loadAdminSupport()
                ]);
                
                // راه‌اندازی بروزرسانی Real-time
                setupRealtimeUpdates();
                startRealtimeUpdates();
                
            } catch (error) {
                console.error('Error loading admin panel:', error);
                showNotification('خطا در بارگذاری پنل مدیریت', 'error');
            }
        }

        async function loadAdminStats() {
            try {
                // تعداد سفرها
                const { data: trips, error: tripsError } = await supabase
                    .from('trips')
                    .select('id', { count: 'exact' });
                
                if (!tripsError && trips) {
                    document.getElementById('totalTrips').textContent = trips.length;
                }
                
                // کاربران فعال
                const { data: users, error: usersError } = await supabase
                    .from('users')
                    .select('id', { count: 'exact' })
                    .eq('status', 'approved');
                
                if (!usersError && users) {
                    document.getElementById('activeUsers').textContent = users.length;
                }
                
                // رانندگان
                const { data: drivers, error: driversError } = await supabase
                    .from('drivers')
                    .select('id', { count: 'exact' })
                    .eq('status', 'active');
                
                if (!driversError && drivers) {
                    document.getElementById('totalDrivers').textContent = drivers.length;
                }
                
                // درآمد کل
                const { data: revenueData, error: revenueError } = await supabase
                    .from('trips')
                    .select('price')
                    .eq('status', 'completed');
                
                if (!revenueError && revenueData) {
                    const totalRevenue = revenueData.reduce((sum, trip) => sum + (trip.price || 0), 0);
                    document.getElementById('totalRevenue').textContent = `${totalRevenue} افغانی`;
                }
                
            } catch (error) {
                console.error('Error loading admin stats:', error);
            }
        }

        async function loadPendingUsers() {
            try {
                const { data: users, error } = await supabase
                    .from('users')
                    .select('*')
                    .eq('status', 'pending')
                    .order('created_at', { ascending: false });
                
                if (error) throw error;
                
                const pendingUsersTable = document.getElementById('pendingUsersTable');
                if (!pendingUsersTable) return;
                
                pendingUsersTable.innerHTML = '';
                
                if (users.length === 0) {
                    pendingUsersTable.innerHTML = `
                        <tr>
                            <td colspan="6" style="text-align: center; padding: 20px; color: var(--gray);">
                                هیچ کاربری در انتظار تایید نیست
                            </td>
                        </tr>
                    `;
                    return;
                }
                
                users.forEach(user => {
                    const row = document.createElement('tr');
                    const date = new Date(user.created_at).toLocaleDateString('fa-IR');
                    const roleText = user.role === 'passenger' ? 'مسافر' : 'راننده';
                    
                    row.innerHTML = `
                        <td>${user.name}</td>
                        <td>${user.email}</td>
                        <td>${user.phone}</td>
                        <td>${roleText}</td>
                        <td>${date}</td>
                        <td class="action-buttons">
                            <button class="action-btn btn-approve" onclick="approveUser('${user.id}')">تایید</button>
                            <button class="action-btn btn-reject" onclick="rejectUser('${user.id}')">رد</button>
                        </td>
                    `;
                    
                    pendingUsersTable.appendChild(row);
                });
                
            } catch (error) {
                console.error('Error loading pending users:', error);
            }
        }

        async function approveUser(userId) {
            try {
                const { error } = await supabase
                    .from('users')
                    .update({ status: 'approved' })
                    .eq('id', userId);
                
                if (error) throw error;
                
                showNotification('کاربر با موفقیت تایید شد', 'success');
                loadPendingUsers();
                loadAllUsers();
                
            } catch (error) {
                console.error('Error approving user:', error);
                showNotification('خطا در تایید کاربر', 'error');
            }
        }

        async function rejectUser(userId) {
            try {
                const { error } = await supabase
                    .from('users')
                    .update({ status: 'rejected' })
                    .eq('id', userId);
                
                if (error) throw error;
                
                showNotification('کاربر رد شد', 'success');
                loadPendingUsers();
                loadAllUsers();
                
            } catch (error) {
                console.error('Error rejecting user:', error);
                showNotification('خطا در رد کاربر', 'error');
            }
        }

        async function loadAllUsers() {
            try {
                const { data: users, error } = await supabase
                    .from('users')
                    .select('*')
                    .order('created_at', { ascending: false });
                
                if (error) throw error;
                
                const allUsersTable = document.getElementById('allUsersTable');
                if (!allUsersTable) return;
                
                allUsersTable.innerHTML = '';
                
                if (users.length === 0) {
                    allUsersTable.innerHTML = `
                        <tr>
                            <td colspan="7" style="text-align: center; padding: 20px; color: var(--gray);">
                                هیچ کاربری ثبت نشده است
                            </td>
                        </tr>
                    `;
                    return;
                }
                
                users.forEach(user => {
                    const row = document.createElement('tr');
                    const date = new Date(user.created_at).toLocaleDateString('fa-IR');
                    const roleText = user.role === 'passenger' ? 'مسافر' : 'راننده';
                    const statusClass = `status-${user.status}`;
                    const statusText = {
                        'pending': 'در انتظار تایید',
                        'approved': 'تایید شده',
                        'rejected': 'رد شده'
                    }[user.status] || user.status;
                    
                    row.innerHTML = `
                        <td>${user.name}</td>
                        <td>${user.email}</td>
                        <td>${user.phone}</td>
                        <td>${roleText}</td>
                        <td><span class="status-badge ${statusClass}">${statusText}</span></td>
                        <td>${date}</td>
                        <td class="action-buttons">
                            ${user.status === 'approved' ? 
                              `<button class="action-btn btn-reject" onclick="deactivateUser('${user.id}')">غیرفعال</button>` : 
                              user.status === 'rejected' ? 
                              `<button class="action-btn btn-approve" onclick="activateUser('${user.id}')">فعال</button>` : ''}
                            <button class="action-btn btn-reject" onclick="deleteUser('${user.id}')">حذف</button>
                        </td>
                    `;
                    
                    allUsersTable.appendChild(row);
                });
                
            } catch (error) {
                console.error('Error loading all users:', error);
            }
        }

        async function deactivateUser(userId) {
            try {
                const { error } = await supabase
                    .from('users')
                    .update({ status: 'rejected' })
                    .eq('id', userId);
                
                if (error) throw error;
                
                showNotification('کاربر غیرفعال شد', 'success');
                loadAllUsers();
                
            } catch (error) {
                console.error('Error deactivating user:', error);
                showNotification('خطا در غیرفعال کردن کاربر', 'error');
            }
        }

        async function activateUser(userId) {
            try {
                const { error } = await supabase
                    .from('users')
                    .update({ status: 'approved' })
                    .eq('id', userId);
                
                if (error) throw error;
                
                showNotification('کاربر فعال شد', 'success');
                loadAllUsers();
                
            } catch (error) {
                console.error('Error activating user:', error);
                showNotification('خطا در فعال کردن کاربر', 'error');
            }
        }

        async function deleteUser(userId) {
            if (!confirm('آیا از حذف این کاربر مطمئن هستید؟')) return;
            
            try {
                const { error } = await supabase
                    .from('users')
                    .delete()
                    .eq('id', userId);
                
                if (error) throw error;
                
                showNotification('کاربر حذف شد', 'success');
                loadAllUsers();
                
            } catch (error) {
                console.error('Error deleting user:', error);
                showNotification('خطا در حذف کاربر', 'error');
            }
        }

        async function loadDrivers() {
            try {
                const { data: drivers, error } = await supabase
                    .from('drivers')
                    .select('*')
                    .order('created_at', { ascending: false });
                
                if (error) throw error;
                
                const driversTable = document.getElementById('driversTable');
                if (!driversTable) return;
                
                driversTable.innerHTML = '';
                
                if (drivers.length === 0) {
                    driversTable.innerHTML = `
                        <tr>
                            <td colspan="8" style="text-align: center; padding: 20px; color: var(--gray);">
                                هیچ رانندهای ثبت نشده است
                            </td>
                        </tr>
                    `;
                    return;
                }
                
                drivers.forEach(driver => {
                    const row = document.createElement('tr');
                    const vehicleType = driver.vehicle_type || 'car';
                    const vehicleTypeText = vehicleType === 'car' ? 'خودرو' : 'موتور';
                    const statusClass = driver.status === 'active' ? 'status-active' : 'status-inactive';
                    const statusText = driver.status === 'active' ? 'فعال' : 'غیرفعال';
                    
                    row.innerHTML = `
                        <td>${driver.name}</td>
                        <td>${driver.phone}</td>
                        <td>${vehicleTypeText}</td>
                        <td>${driver.car_model || '---'}</td>
                        <td>${driver.plate_number || '---'}</td>
                        <td><span class="status-badge ${statusClass}">${statusText}</span></td>
                        <td>${driver.rating || 'جدید'}</td>
                        <td class="action-buttons">
                            <button class="action-btn ${driver.status === 'active' ? 'btn-reject' : 'btn-approve'}" onclick="toggleDriverStatus('${driver.id}', ${driver.status === 'active'})">
                                ${driver.status === 'active' ? 'غیرفعال' : 'فعال'}
                            </button>
                            <button class="action-btn btn-reject" onclick="deleteDriver('${driver.id}')">حذف</button>
                        </td>
                    `;
                    
                    driversTable.appendChild(row);
                });
                
            } catch (error) {
                console.error('Error loading drivers:', error);
            }
        }

        async function toggleDriverStatus(driverId, isActive) {
            try {
                const { error } = await supabase
                    .from('drivers')
                    .update({ status: isActive ? 'inactive' : 'active' })
                    .eq('id', driverId);
                
                if (error) throw error;
                
                showNotification(`راننده ${isActive ? 'غیرفعال' : 'فعال'} شد`, 'success');
                loadDrivers();
                
            } catch (error) {
                console.error('Error toggling driver status:', error);
                showNotification('خطا در تغییر وضعیت راننده', 'error');
            }
        }

        async function deleteDriver(driverId) {
            if (!confirm('آیا از حذف این راننده مطمئن هستید؟')) return;
            
            try {
                const { error } = await supabase
                    .from('drivers')
                    .delete()
                    .eq('id', driverId);
                
                if (error) throw error;
                
                showNotification('راننده حذف شد', 'success');
                loadDrivers();
                
            } catch (error) {
                console.error('Error deleting driver:', error);
                showNotification('خطا در حذف راننده', 'error');
            }
        }

        async function loadAdminTrips() {
            try {
                const { data: trips, error } = await supabase
                    .from('trips')
                    .select(`
                        *,
                        passenger:users!trips_user_id_fkey(name),
                        driver:drivers!trips_driver_id_fkey(name)
                    `)
                    .order('created_at', { ascending: false });
                
                if (error) throw error;
                
                const adminTripsTable = document.getElementById('adminTripsTable');
                if (!adminTripsTable) return;
                
                adminTripsTable.innerHTML = '';
                
                if (trips.length === 0) {
                    adminTripsTable.innerHTML = `
                        <tr>
                            <td colspan="9" style="text-align: center; padding: 20px; color: var(--gray);">
                                هیچ سفری ثبت نشده است
                            </td>
                        </tr>
                    `;
                    return;
                }
                
                trips.forEach(trip => {
                    const row = document.createElement('tr');
                    const date = new Date(trip.created_at).toLocaleDateString('fa-IR');
                    const statusClass = `status-${trip.status}`;
                    const statusText = {
                        'requested': 'درخواست شده',
                        'confirmed': 'تأیید شده',
                        'in_progress': 'در حال انجام',
                        'completed': 'تکمیل شده',
                        'cancelled': 'لغو شده'
                    }[trip.status] || trip.status;
                    
                    row.innerHTML = `
                        <td>${date}</td>
                        <td>${trip.passenger?.name || '---'}</td>
                        <td>${trip.driver?.name || '---'}</td>
                        <td>${trip.pickup}</td>
                        <td>${trip.destination}</td>
                        <td>${trip.distance ? trip.distance.toFixed(2) + ' کیلومتر' : '---'}</td>
                        <td>${trip.price ? trip.price + ' افغانی' : '---'}</td>
                        <td><span class="status-badge ${statusClass}">${statusText}</span></td>
                        <td class="action-buttons">
                            ${trip.status === 'requested' || trip.status === 'confirmed' ? 
                              `<button class="action-btn btn-reject" onclick="cancelTrip('${trip.id}')">لغو سفر</button>` : ''}
                            <button class="action-btn btn-reject" onclick="deleteTrip('${trip.id}')">حذف</button>
                        </td>
                    `;
                    
                    adminTripsTable.appendChild(row);
                });
                
            } catch (error) {
                console.error('Error loading admin trips:', error);
            }
        }

        async function cancelTrip(tripId) {
            if (!confirm('آیا از لغو این سفر مطمئن هستید؟')) return;
            
            try {
                const { error } = await supabase
                    .from('trips')
                    .update({ status: 'cancelled' })
                    .eq('id', tripId);
                
                if (error) throw error;
                
                showNotification('سفر لغو شد', 'success');
                loadAdminTrips();
                
            } catch (error) {
                console.error('Error cancelling trip:', error);
                showNotification('خطا در لغو سفر', 'error');
            }
        }

        async function deleteTrip(tripId) {
            if (!confirm('آیا از حذف این سفر مطمئن هستید؟')) return;
            
            try {
                const { error } = await supabase
                    .from('trips')
                    .delete()
                    .eq('id', tripId);
                
                if (error) throw error;
                
                showNotification('سفر حذف شد', 'success');
                loadAdminTrips();
                
            } catch (error) {
                console.error('Error deleting trip:', error);
                showNotification('خطا در حذف سفر', 'error');
            }
        }

        async function loadAdminDiscounts() {
            try {
                const { data: discounts, error } = await supabase
                    .from('discounts')
                    .select('*')
                    .order('created_at', { ascending: false });
                
                if (error) throw error;
                
                const discountsTable = document.getElementById('discountsTable');
                if (!discountsTable) return;
                
                discountsTable.innerHTML = '';
                
                if (discounts.length === 0) {
                    discountsTable.innerHTML = `
                        <tr>
                            <td colspan="6" style="text-align: center; padding: 20px; color: var(--gray);">
                                هیچ تخفیفی ثبت نشده است
                            </td>
                        </tr>
                    `;
                    return;
                }
                
                discounts.forEach(discount => {
                    const row = document.createElement('tr');
                    const expiryDate = new Date(discount.expiry_date).toLocaleDateString('fa-IR');
                    const statusClass = new Date(discount.expiry_date) > new Date() ? 'status-active' : 'status-inactive';
                    const statusText = new Date(discount.expiry_date) > new Date() ? 'فعال' : 'منقضی';
                    
                    row.innerHTML = `
                        <td>${discount.code}</td>
                        <td>${discount.percent}%</td>
                        <td>${expiryDate}</td>
                        <td>${discount.used_count || 0} / ${discount.max_uses}</td>
                        <td><span class="status-badge ${statusClass}">${statusText}</span></td>
                        <td class="action-buttons">
                            <button class="action-btn btn-reject" onclick="deleteDiscount('${discount.id}')">حذف</button>
                        </td>
                    `;
                    
                    discountsTable.appendChild(row);
                });
                
            } catch (error) {
                console.error('Error loading admin discounts:', error);
            }
        }

        async function deleteDiscount(discountId) {
            if (!confirm('آیا از حذف این تخفیف مطمئن هستید؟')) return;
            
            try {
                const { error } = await supabase
                    .from('discounts')
                    .delete()
                    .eq('id', discountId);
                
                if (error) throw error;
                
                showNotification('تخفیف حذف شد', 'success');
                loadAdminDiscounts();
                
            } catch (error) {
                console.error('Error deleting discount:', error);
                showNotification('خطا در حذف تخفیف', 'error');
            }
        }

        async function loadAdminSupport() {
            try {
                const { data: tickets, error } = await supabase
                    .from('support_tickets')
                    .select(`
                        *,
                        user:users!support_tickets_user_id_fkey(name)
                    `)
                    .order('created_at', { ascending: false });
                
                if (error) throw error;
                
                const adminSupportTable = document.getElementById('adminSupportTable');
                if (!adminSupportTable) return;
                
                adminSupportTable.innerHTML = '';
                
                if (tickets.length === 0) {
                    adminSupportTable.innerHTML = `
                        <tr>
                            <td colspan="6" style="text-align: center; padding: 20px; color: var(--gray);">
                                هیچ درخواست پشتیبانی ثبت نشده است
                            </td>
                        </tr>
                    `;
                    return;
                }
                
                tickets.forEach(ticket => {
                    const row = document.createElement('tr');
                    const date = new Date(ticket.created_at).toLocaleDateString('fa-IR');
                    const statusClass = `status-${ticket.status}`;
                    const statusText = {
                        'pending': 'در انتظار پاسخ',
                        'answered': 'پاسخ داده شده',
                        'closed': 'بسته شده'
                    }[ticket.status] || ticket.status;
                    
                    row.innerHTML = `
                        <td>${ticket.user?.name || '---'}</td>
                        <td>${ticket.subject}</td>
                        <td>${ticket.message.length > 50 ? ticket.message.substring(0, 50) + '...' : ticket.message}</td>
                        <td>${date}</td>
                        <td><span class="status-badge ${statusClass}">${statusText}</span></td>
                        <td class="action-buttons">
                            ${ticket.status !== 'closed' ? 
                              `<button class="action-btn btn-approve" onclick="answerTicket('${ticket.id}')">پاسخ</button>` : ''}
                            <button class="action-btn btn-reject" onclick="${ticket.status === 'closed' ? `deleteTicket('${ticket.id}')` : `closeTicket('${ticket.id}')`}">
                                ${ticket.status === 'closed' ? 'حذف' : 'بستن'}
                            </button>
                        </td>
                    `;
                    
                    adminSupportTable.appendChild(row);
                });
                
            } catch (error) {
                console.error('Error loading admin support:', error);
            }
        }

        async function answerTicket(ticketId) {
            const answer = prompt('پاسخ خود را وارد کنید:');
            if (!answer) return;
            
            try {
                const { error } = await supabase
                    .from('support_tickets')
                    .update({ 
                        reply: answer,
                        status: 'answered',
                        replied_at: new Date().toISOString()
                    })
                    .eq('id', ticketId);
                
                if (error) throw error;
                
                showNotification('پاسخ ارسال شد', 'success');
                loadAdminSupport();
                
            } catch (error) {
                console.error('Error answering ticket:', error);
                showNotification('خطا در ارسال پاسخ', 'error');
            }
        }

        async function closeTicket(ticketId) {
            try {
                const { error } = await supabase
                    .from('support_tickets')
                    .update({ status: 'closed' })
                    .eq('id', ticketId);
                
                if (error) throw error;
                
                showNotification('تیکت بسته شد', 'success');
                loadAdminSupport();
                
            } catch (error) {
                console.error('Error closing ticket:', error);
                showNotification('خطا در بستن تیکت', 'error');
            }
        }

        async function deleteTicket(ticketId) {
            if (!confirm('آیا از حذف این تیکت مطمئن هستید؟')) return;
            
            try {
                const { error } = await supabase
                    .from('support_tickets')
                    .delete()
                    .eq('id', ticketId);
                
                if (error) throw error;
                
                showNotification('تیکت حذف شد', 'success');
                loadAdminSupport();
                
            } catch (error) {
                console.error('Error deleting ticket:', error);
                showNotification('خطا در حذف تیکت', 'error');
            }
        }

        // خروجی Excel
        async function exportToExcel(tableId, filename) {
            const table = document.getElementById(tableId);
            if (!table) return;
            
            const ws = XLSX.utils.table_to_sheet(table);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "Sheet1");
            
            XLSX.writeFile(wb, `${filename}_${new Date().toISOString().split('T')[0]}.xlsx`);
            showNotification('فایل Excel با موفقیت دانلود شد', 'success');
        }

        function startRealtimeUpdates() {
            // آپدیت آمار هر 10 ثانیه
            if (isAdmin) {
                updateRealtimeStats();
                setInterval(updateRealtimeStats, 10000);
            }
            
            // آپدیت رانندگان روی نقشه هر 30 ثانیه
            updateDriversOnMap();
            setInterval(updateDriversOnMap, 30000);
        }

        // Event Listeners
        document.addEventListener('DOMContentLoaded', function() {
            // دکمه شروع استفاده
            document.getElementById('start-using-btn').addEventListener('click', () => {
                document.getElementById('welcome-page').style.display = 'none';
                document.getElementById('main-header').style.display = 'block';
                document.getElementById('main-container').style.display = 'block';
                document.getElementById('main-footer').style.display = 'block';
                
                // راه‌اندازی نقشه
                setTimeout(() => {
                    initMap();
                    updateDriversOnMap();
                }, 100);
                
                showNotification('به اسنپ افغانستان خوش آمدید!', 'success');
            });

            // انتخاب نوع سفر
            document.querySelectorAll('.ride-type').forEach(type => {
                type.addEventListener('click', () => {
                    document.querySelectorAll('.ride-type').forEach(t => t.classList.remove('selected'));
                    type.classList.add('selected');
                    selectedRideType = type.dataset.type;
                    updatePrice();
                });
            });

            // انتخاب روش پرداخت
            document.querySelectorAll('.payment-method').forEach(method => {
                method.addEventListener('click', () => {
                    document.querySelectorAll('.payment-method').forEach(m => m.classList.remove('selected'));
                    method.classList.add('selected');
                    selectedPaymentMethod = method.getAttribute('data-method');
                });
            });

            // تعویض مبدا و مقصد
            document.getElementById('swapLocations').addEventListener('click', () => {
                const pickupInput = document.getElementById('pickup');
                const destinationInput = document.getElementById('destination');
                
                if (!destinationInput.value) {
                    showNotification('لطفاً ابتدا مقصد را وارد کنید', 'error');
                    return;
                }
                
                const pickupValue = pickupInput.value;
                const destinationValue = destinationInput.value;
                
                pickupInput.value = destinationValue;
                destinationInput.value = pickupValue;
                calculateDistanceAndPrice();
                showNotification('مبدا و مقصد با موفقیت تعویض شدند', 'info');
            });

            // فرم درخواست سفر
            document.getElementById('rideForm').addEventListener('submit', async (e) => {
                e.preventDefault();
                
                if (!currentUser) {
                    showNotification('لطفاً ابتدا وارد حساب کاربری خود شوید', 'error');
                    openAuthModal();
                    return;
                }
                
                const pickupInput = document.getElementById('pickup');
                const destinationInput = document.getElementById('destination');
                const pickup = pickupInput?.value.trim();
                const destination = destinationInput?.value.trim();

                if (!pickup || !destination) {
                    showNotification('لطفاً مبدا و مقصد را وارد کنید', 'error');
                    return;
                }

                if (pickup === destination) {
                    showNotification('مبدا و مقصد نمیتوانند یکسان باشند', 'error');
                    return;
                }

                if (currentDistance === 0) {
                    showNotification('لطفاً منتظر بمانید تا مسافت محاسبه شود', 'error');
                    return;
                }

                try {
                    showNotification('در حال ایجاد سفر...', 'info');
                    
                    const tripData = {
                        user_id: currentUser.id,
                        pickup,
                        destination,
                        ride_type: selectedRideType,
                        distance: currentDistance,
                        price: currentPrice,
                        payment_method: selectedPaymentMethod,
                        status: 'requested'
                    };
                    
                    const trip = await createTrip(tripData);
                    currentTripId = trip.id;
                    
                    // یافتن نزدیکترین راننده
                    showNotification('در حال یافتن نزدیکترین راننده...', 'info');
                    const pickupCoords = await getCoordinates(pickup);
                    const nearestDriver = await findNearestDriver(pickupCoords, selectedRideType);
                    
                    if (!nearestDriver) {
                        showNotification('هیچ راننده‌ای در حال حاضر در دسترس نیست. لطفاً بعداً تلاش کنید.', 'error');
                        return;
                    }
                    
                    currentDriver = nearestDriver;
                    
                    // بروزرسانی سفر با اطلاعات راننده
                    await supabase
                        .from('trips')
                        .update({
                            driver_id: nearestDriver.id,
                            driver_name: nearestDriver.name,
                            status: 'confirmed',
                            eta: nearestDriver.eta,
                            distance: nearestDriver.distance
                        })
                        .eq('id', currentTripId);
                    
                    // نمایش اطلاعات راننده
                    document.getElementById('driverAvatar').textContent = nearestDriver.name.charAt(0);
                    document.getElementById('driverName').textContent = nearestDriver.name;
                    document.getElementById('carModel').textContent = nearestDriver.car_model || '---';
                    document.getElementById('carColor').textContent = nearestDriver.car_color || '---';
                    document.getElementById('plateNumber').textContent = nearestDriver.plate_number || '---';
                    document.getElementById('eta').textContent = `${nearestDriver.eta} دقیقه`;
                    document.getElementById('distance').textContent = `${nearestDriver.distance?.toFixed(2) || '0'} کیلومتر`;
                    document.getElementById('price').textContent = `${currentPrice} افغانی`;
                    
                    document.getElementById('driverModal').style.display = 'flex';
                    showNotification(`راننده ${nearestDriver.name} پیدا شد!`, 'success');
                    
                } catch (error) {
                    console.error('Error creating trip:', error);
                    showNotification('خطا در ایجاد سفر. لطفاً دوباره تلاش کنید.', 'error');
                }
            });

            // تأیید سفر
            document.getElementById('confirmRide').addEventListener('click', async () => {
                document.getElementById('driverModal').style.display = 'none';
                
                try {
                    // شروع سفر
                    await supabase
                        .from('trips')
                        .update({ status: 'in_progress' })
                        .eq('id', currentTripId);
                    
                    // شروع ردیابی
                    const tripData = {
                        driver_name: currentDriver.name,
                        eta: currentDriver.eta,
                        distance: currentDriver.distance
                    };
                    startTripTracking(tripData);
                    
                    showNotification('سفر شما با موفقیت ثبت شد. راننده به زودی با شما تماس خواهد گرفت.', 'success');
                    
                    // بازنشانی فرم
                    document.getElementById('rideForm').reset();
                    document.getElementById('tripCalculator').classList.remove('active');
                    currentDistance = 0;
                    currentPrice = 0;
                    
                    const rideTypes = document.querySelectorAll('.ride-type');
                    rideTypes.forEach(t => t.classList.remove('selected'));
                    if (rideTypes.length > 0) rideTypes[0].classList.add('selected');
                    selectedRideType = 'economy';
                    
                } catch (error) {
                    console.error('Error confirming ride:', error);
                    showNotification('خطا در تأیید سفر', 'error');
                }
            });

            // لغو ردیابی
            document.getElementById('cancelTracking').addEventListener('click', async () => {
                if (confirm('آیا از لغو این سفر مطمئن هستید؟')) {
                    document.getElementById('liveTracking').style.display = 'none';
                    
                    if (trackingInterval) {
                        clearInterval(trackingInterval);
                    }
                    
                    try {
                        await supabase
                            .from('trips')
                            .update({ status: 'cancelled' })
                            .eq('id', currentTripId);
                        
                        showNotification('سفر لغو شد', 'warning');
                    } catch (error) {
                        console.error('Error cancelling trip:', error);
                    }
                }
            });

            // محاسبه مسافت هنگام تغییر مقصد
            document.getElementById('destination').addEventListener('input', () => {
                setTimeout(calculateDistanceAndPrice, 1000);
            });

            document.getElementById('pickup').addEventListener('input', () => {
                setTimeout(calculateDistanceAndPrice, 1000);
            });

            // پیشنهادات مقصد
            document.querySelectorAll('.suggestion-item').forEach(item => {
                item.addEventListener('click', () => {
                    const destination = item.getAttribute('data-destination');
                    document.getElementById('destination').value = destination;
                    calculateDistanceAndPrice();
                    showNotification(`مقصد به "${destination}" تنظیم شد`, 'info');
                });
            });

            // مدیریت ورود/ثبتنام
            document.getElementById('loginBtn').addEventListener('click', openAuthModal);
            document.getElementById('mobileLoginBtn').addEventListener('click', openAuthModal);

            document.getElementById('loginForm').addEventListener('submit', async (e) => {
                e.preventDefault();
                clearErrors();
                
                const email = document.getElementById('loginEmail').value.trim();
                const password = document.getElementById('loginPassword').value;
                
                if (!email || !password) {
                    showError('loginEmail', 'لطفاً ایمیل و رمز عبور را وارد کنید');
                    return;
                }
                
                const success = await loginUser(email, password);
                if (success) {
                    document.getElementById('authModal').style.display = 'none';
                    document.getElementById('loginForm').reset();
                }
            });

            document.getElementById('registerForm').addEventListener('submit', async (e) => {
                e.preventDefault();
                clearErrors();
                
                const name = document.getElementById('registerName').value.trim();
                const email = document.getElementById('registerEmail').value.trim();
                const phone = document.getElementById('registerPhone').value.trim();
                const password = document.getElementById('registerPassword').value;
                const confirmPassword = document.getElementById('registerConfirmPassword').value;
                const userType = document.getElementById('userType').value;
                
                // اعتبارسنجی
                if (name.length < 2) {
                    showError('registerName', 'نام باید حداقل ۲ حرف داشته باشد');
                    return;
                }
                
                if (!email.includes('@')) {
                    showError('registerEmail', 'لطفاً یک ایمیل معتبر وارد کنید');
                    return;
                }
                
                if (phone.length < 10) {
                    showError('registerPhone', 'لطفاً یک شماره تماس معتبر وارد کنید');
                    return;
                }
                
                if (password.length < 6) {
                    showError('registerPassword', 'رمز عبور باید حداقل ۶ حرف داشته باشد');
                    return;
                }
                
                if (password !== confirmPassword) {
                    showError('registerConfirmPassword', 'رمز عبور و تکرار آن مطابقت ندارند');
                    return;
                }
                
                if (!userType) {
                    showError('userType', 'لطفاً نوع کاربر را انتخاب کنید');
                    return;
                }
                
                const userData = {
                    name,
                    email,
                    phone,
                    password, // در پروژه واقعی باید hash شود
                    role: userType
                };
                
                const success = await registerUser(userData);
                if (success) {
                    document.getElementById('registerForm').reset();
                    
                    // تغییر به تب ورود
                    document.querySelectorAll('.form-tab').forEach(t => t.classList.remove('active'));
                    document.querySelectorAll('.form-tab-content').forEach(c => c.classList.remove('active'));
                    document.querySelector('.form-tab[data-tab="login"]').classList.add('active');
                    document.getElementById('login-tab').classList.add('active');
                }
            });

            // مدیریت خروج
            document.getElementById('logoutBtn').addEventListener('click', logout);
            document.getElementById('mobileLogoutBtn').addEventListener('click', logout);

            // مدیریت منوی موبایل
            document.getElementById('hamburger').addEventListener('click', () => {
                document.getElementById('mobileMenu').classList.add('active');
                document.getElementById('overlay').classList.add('active');
                document.getElementById('hamburger').classList.add('active');
            });

            document.getElementById('closeMenu').addEventListener('click', () => {
                document.getElementById('mobileMenu').classList.remove('active');
                document.getElementById('overlay').classList.remove('active');
                document.getElementById('hamburger').classList.remove('active');
            });

            document.getElementById('overlay').addEventListener('click', () => {
                document.getElementById('mobileMenu').classList.remove('active');
                document.getElementById('overlay').classList.remove('active');
                document.getElementById('hamburger').classList.remove('active');
            });

            // مدیریت صفحات
            document.querySelectorAll('.nav-link').forEach(link => {
                link.addEventListener('click', (e) => {
                    e.preventDefault();
                    const pageId = link.getAttribute('data-page') + '-page';
                    
                    document.querySelectorAll('.page').forEach(page => {
                        page.classList.remove('active');
                    });
                    
                    document.querySelectorAll('.nav-link').forEach(l => {
                        l.classList.remove('active');
                    });
                    link.classList.add('active');
                    
                    const targetPage = document.getElementById(pageId);
                    if (targetPage) targetPage.classList.add('active');
                    
                    // بستن منوی موبایل
                    document.getElementById('mobileMenu').classList.remove('active');
                    document.getElementById('overlay').classList.remove('active');
                    document.getElementById('hamburger').classList.remove('active');
                    
                    // بارگذاری داده‌های صفحه
                    if (pageId === 'my-trips-page') {
                        loadMyTrips();
                    } else if (pageId === 'discounts-page') {
                        loadDiscounts();
                    } else if (pageId === 'profile-page') {
                        updateProfilePage();
                    } else if (pageId === 'admin-page') {
                        loadAdminPanel();
                    }
                });
            });

            // مدیریت تب‌های ادمین
            document.querySelectorAll('.admin-tab').forEach(tab => {
                tab.addEventListener('click', () => {
                    const tabId = tab.getAttribute('data-tab');
                    
                    document.querySelectorAll('.admin-tab').forEach(t => {
                        t.classList.remove('active');
                    });
                    tab.classList.add('active');
                    
                    document.querySelectorAll('.admin-tab-content').forEach(content => {
                        content.classList.remove('active');
                    });
                    
                    const targetContent = document.getElementById(`${tabId}-tab`);
                    if (targetContent) targetContent.classList.add('active');
                });
            });

            // دکمه‌های خروجی Excel
            document.getElementById('exportUsersBtn')?.addEventListener('click', () => exportToExcel('pendingUsersTable', 'کاربران_در_انتظار'));
            document.getElementById('exportAllUsersBtn')?.addEventListener('click', () => exportToExcel('allUsersTable', 'همه_کاربران'));
            document.getElementById('exportDriversBtn')?.addEventListener('click', () => exportToExcel('driversTable', 'رانندگان'));
            document.getElementById('exportTripsBtn')?.addEventListener('click', () => exportToExcel('adminTripsTable', 'سفرها'));
            document.getElementById('exportDiscountsBtn')?.addEventListener('click', () => exportToExcel('discountsTable', 'تخفیف‌ها'));
            document.getElementById('exportSupportBtn')?.addEventListener('click', () => exportToExcel('adminSupportTable', 'پشتیبانی'));

            // دکمه‌های بروزرسانی
            document.getElementById('refreshUsersBtn')?.addEventListener('click', () => {
                loadPendingUsers();
                loadAllUsers();
                showNotification('کاربران بروزرسانی شدند', 'info');
            });

            document.getElementById('refreshDriversBtn')?.addEventListener('click', () => {
                loadDrivers();
                showNotification('رانندگان بروزرسانی شدند', 'info');
            });

            document.getElementById('refreshTripsBtn')?.addEventListener('click', () => {
                loadAdminTrips();
                showNotification('سفرها بروزرسانی شدند', 'info');
            });

            document.getElementById('refreshDiscountsBtn')?.addEventListener('click', () => {
                loadAdminDiscounts();
                showNotification('تخفیف‌ها بروزرسانی شدند', 'info');
            });

            document.getElementById('refreshSupportBtn')?.addEventListener('click', () => {
                loadAdminSupport();
                showNotification('تیکت‌های پشتیبانی بروزرسانی شدند', 'info');
            });

            // دکمه فیلتر سفرها
            document.getElementById('filterTripsBtn')?.addEventListener('click', async () => {
                const date = document.getElementById('tripFilterDate').value;
                const status = document.getElementById('tripFilterStatus').value;
                
                try {
                    let query = supabase
                        .from('trips')
                        .select(`
                            *,
                            passenger:users!trips_user_id_fkey(name),
                            driver:drivers!trips_driver_id_fkey(name)
                        `)
                        .order('created_at', { ascending: false });
                    
                    if (date) {
                        const startDate = new Date(date);
                        const endDate = new Date(date);
                        endDate.setDate(endDate.getDate() + 1);
                        
                        query = query
                            .gte('created_at', startDate.toISOString())
                            .lt('created_at', endDate.toISOString());
                    }
                    
                    if (status) {
                        query = query.eq('status', status);
                    }
                    
                    const { data: trips, error } = await query;
                    
                    if (error) throw error;
                    
                    const adminTripsTable = document.getElementById('adminTripsTable');
                    if (!adminTripsTable) return;
                    
                    adminTripsTable.innerHTML = '';
                    
                    if (trips.length === 0) {
                        adminTripsTable.innerHTML = `
                            <tr>
                                <td colspan="9" style="text-align: center; padding: 20px; color: var(--gray);">
                                    هیچ سفر مطابق فیلترها یافت نشد
                                </td>
                            </tr>
                        `;
                        return;
                    }
                    
                    trips.forEach(trip => {
                        const row = document.createElement('tr');
                        const date = new Date(trip.created_at).toLocaleDateString('fa-IR');
                        const statusClass = `status-${trip.status}`;
                        const statusText = {
                            'requested': 'درخواست شده',
                            'confirmed': 'تأیید شده',
                            'in_progress': 'در حال انجام',
                            'completed': 'تکمیل شده',
                            'cancelled': 'لغو شده'
                        }[trip.status] || trip.status;
                        
                        row.innerHTML = `
                            <td>${date}</td>
                            <td>${trip.passenger?.name || '---'}</td>
                            <td>${trip.driver?.name || '---'}</td>
                            <td>${trip.pickup}</td>
                            <td>${trip.destination}</td>
                            <td>${trip.distance ? trip.distance.toFixed(2) + ' کیلومتر' : '---'}</td>
                            <td>${trip.price ? trip.price + ' افغانی' : '---'}</td>
                            <td><span class="status-badge ${statusClass}">${statusText}</span></td>
                            <td class="action-buttons">
                                ${trip.status === 'requested' || trip.status === 'confirmed' ? 
                                  `<button class="action-btn btn-reject" onclick="cancelTrip('${trip.id}')">لغو سفر</button>` : ''}
                                <button class="action-btn btn-reject" onclick="deleteTrip('${trip.id}')">حذف</button>
                            </td>
                        `;
                        
                        adminTripsTable.appendChild(row);
                    });
                    
                    showNotification('سفرها با موفقیت فیلتر شدند', 'success');
                    
                } catch (error) {
                    console.error('Error filtering trips:', error);
                    showNotification('خطا در فیلتر کردن سفرها', 'error');
                }
            });

            // کنترل‌های نقشه
            document.getElementById('locateMe')?.addEventListener('click', () => {
                if (navigator.geolocation) {
                    navigator.geolocation.getCurrentPosition(
                        (position) => {
                            const coords = [position.coords.latitude, position.coords.longitude];
                            
                            if (userMarker) {
                                map.removeLayer(userMarker);
                            }
                            
                            userMarker = L.marker(coords, {
                                icon: L.divIcon({
                                    className: 'passenger-marker',
                                    html: '<i class="fas fa-user"></i>',
                                    iconSize: [30, 30]
                                })
                            }).addTo(map);
                            userMarker.bindPopup('موقعیت فعلی شما').openPopup();
                            
                            map.setView(coords, 15);
                            showNotification('موقعیت شما روی نقشه نشان داده شد', 'info');
                        },
                        (error) => {
                            console.error('Geolocation error:', error);
                            showNotification('دسترسی به موقعیت مکانی امکان‌پذیر نیست', 'error');
                        }
                    );
                } else {
                    showNotification('مرورگر شما از موقعیت‌یابی پشتیبانی نمی‌کند', 'error');
                }
            });

            document.getElementById('zoomIn')?.addEventListener('click', () => {
                map.zoomIn();
            });

            document.getElementById('zoomOut')?.addEventListener('click', () => {
                map.zoomOut();
            });

            // مدیریت مدال‌ها
            document.querySelectorAll('.close-modal').forEach(btn => {
                btn.addEventListener('click', () => {
                    btn.closest('.modal').style.display = 'none';
                });
            });

            // بستن مدال‌ها با کلیک خارج
            window.addEventListener('click', (e) => {
                if (e.target.classList.contains('modal')) {
                    e.target.style.display = 'none';
                }
            });

            // چک کردن وضعیت ورود کاربر
            checkUserLoginStatus();
        });

        // چک کردن وضعیت ورود
        async function checkUserLoginStatus() {
            const savedUser = localStorage.getItem('snapp_current_user');
            if (savedUser) {
                try {
                    const userData = JSON.parse(savedUser);
                    
                    // بررسی وجود کاربر در دیتابیس
                    const { data, error } = await supabase
                        .from('users')
                        .select('*')
                        .eq('id', userData.id)
                        .single();
                    
                    if (!error && data) {
                        currentUser = data;
                        isAdmin = currentUser.role === 'admin';
                        updateUIAfterLogin();
                    }
                } catch (error) {
                    localStorage.removeItem('snapp_current_user');
                }
            }
        }

        // بارگذاری سفرهای من
        async function loadMyTrips() {
            if (!currentUser) return;
            
            try {
                const { data: trips, error } = await supabase
                    .from('trips')
                    .select(`
                        *,
                        driver:drivers!trips_driver_id_fkey(name, car_model, rating)
                    `)
                    .eq('user_id', currentUser.id)
                    .order('created_at', { ascending: false });
                
                if (error) throw error;
                
                const myTripsTable = document.getElementById('myTripsTable');
                if (!myTripsTable) return;
                
                myTripsTable.innerHTML = '';
                
                if (trips.length === 0) {
                    myTripsTable.innerHTML = `
                        <tr>
                            <td colspan="8" style="text-align: center; padding: 40px;">
                                <i class="fas fa-road" style="font-size: 48px; color: var(--gray); margin-bottom: 15px; display: block;"></i>
                                <p style="color: var(--gray);">هیچ سفری یافت نشد</p>
                            </td>
                        </tr>
                    `;
                    return;
                }
                
                trips.forEach(trip => {
                    const row = document.createElement('tr');
                    const date = new Date(trip.created_at).toLocaleDateString('fa-IR');
                    const statusClass = `status-${trip.status}`;
                    const statusText = {
                        'requested': 'درخواست شده',
                        'confirmed': 'تأیید شده',
                        'in_progress': 'در حال انجام',
                        'completed': 'تکمیل شده',
                        'cancelled': 'لغو شده'
                    }[trip.status] || trip.status;
                    
                    row.innerHTML = `
                        <td>${date}</td>
                        <td>${trip.pickup}</td>
                        <td>${trip.destination}</td>
                        <td>${trip.ride_type === 'economy' ? 'اقتصادی' : trip.ride_type === 'comfort' ? 'کلاسیک' : 'موتور'}</td>
                        <td>${trip.distance?.toFixed(2) || '0'} کیلومتر</td>
                        <td>${trip.price || '0'} افغانی</td>
                        <td><span class="status-badge ${statusClass}">${statusText}</span></td>
                        <td class="action-buttons">
                            ${trip.status === 'requested' || trip.status === 'confirmed' || trip.status === 'in_progress' ? 
                              `<button class="action-btn btn-reject" onclick="cancelUserTrip('${trip.id}')">لغو سفر</button>` : ''}
                            ${trip.status === 'completed' && !trip.rated ? 
                              `<button class="action-btn btn-approve" onclick="openRatingModal('${trip.id}', '${trip.driver?.name || ''}')">امتیازدهی</button>` : ''}
                        </td>
                    `;
                    
                    myTripsTable.appendChild(row);
                });
                
            } catch (error) {
                console.error('Error loading user trips:', error);
                showNotification('خطا در بارگذاری سفرها', 'error');
            }
        }

        async function cancelUserTrip(tripId) {
            if (!confirm('آیا از لغو این سفر مطمئن هستید؟')) return;
            
            try {
                const { error } = await supabase
                    .from('trips')
                    .update({ status: 'cancelled' })
                    .eq('id', tripId);
                
                if (error) throw error;
                
                showNotification('سفر لغو شد', 'success');
                loadMyTrips();
                
            } catch (error) {
                console.error('Error cancelling user trip:', error);
                showNotification('خطا در لغو سفر', 'error');
            }
        }

        // بارگذاری تخفیف‌ها
        async function loadDiscounts() {
            try {
                const { data: discounts, error } = await supabase
                    .from('discounts')
                    .select('*')
                    .gte('expiry_date', new Date().toISOString())
                    .order('created_at', { ascending: false });
                
                if (error) throw error;
                
                const discountsList = document.getElementById('discountsList');
                if (!discountsList) return;
                
                discountsList.innerHTML = '';
                
                if (discounts.length === 0) {
                    discountsList.innerHTML = `
                        <div style="text-align: center; padding: 40px;">
                            <i class="fas fa-tag" style="font-size: 48px; color: var(--gray); margin-bottom: 15px; display: block;"></i>
                            <p style="color: var(--gray);">هیچ تخفیف فعالی موجود نیست</p>
                        </div>
                    `;
                    return;
                }
                
                discounts.forEach(discount => {
                    const discountElement = document.createElement('div');
                    discountElement.className = 'discount-card';
                    
                    const expiryDate = new Date(discount.expiry_date).toLocaleDateString('fa-IR');
                    const progress = (discount.used_count / discount.max_uses) * 100;
                    
                    discountElement.innerHTML = `
                        <div class="discount-header">
                            <div class="discount-code">${discount.code}</div>
                            <div class="discount-percent">${discount.percent}% تخفیف</div>
                        </div>
                        <div class="discount-details">
                            <div>منقضی: ${expiryDate}</div>
                            <div>استفاده شده: ${discount.used_count} از ${discount.max_uses}</div>
                        </div>
                        <div class="discount-progress">
                            <div class="progress-text">
                                <span>۰</span>
                                <span>${discount.max_uses}</span>
                            </div>
                            <div class="progress-bar">
                                <div class="progress-fill" style="width: ${progress}%"></div>
                            </div>
                        </div>
                    `;
                    
                    discountsList.appendChild(discountElement);
                });
                
            } catch (error) {
                console.error('Error loading discounts:', error);
                showNotification('خطا در بارگذاری تخفیف‌ها', 'error');
            }
        }

        // به‌روزرسانی پروفایل
        async function updateProfilePage() {
            if (!currentUser) return;
            
            const profileAvatar = document.getElementById('profileAvatar');
            const profileName = document.getElementById('profileName');
            const profileEmail = document.getElementById('profileEmail');
            const profilePhone = document.getElementById('profilePhone');
            const profileRole = document.getElementById('profileRole');
            const editName = document.getElementById('editName');
            const editEmail = document.getElementById('editEmail');
            const editPhone = document.getElementById('editPhone');
            
            if (profileAvatar) profileAvatar.textContent = currentUser.name.charAt(0);
            if (profileName) profileName.textContent = currentUser.name;
            if (profileEmail) profileEmail.textContent = currentUser.email;
            if (profilePhone) profilePhone.textContent = currentUser.phone;
            if (profileRole) profileRole.textContent = currentUser.role === 'passenger' ? 'مسافر' : 'راننده';
            
            if (editName) editName.value = currentUser.name;
            if (editEmail) editEmail.value = currentUser.email;
            if (editPhone) editPhone.value = currentUser.phone;
            
            // محاسبه آمار
            try {
                const { data: trips, error: tripsError } = await supabase
                    .from('trips')
                    .select('price')
                    .eq('user_id', currentUser.id)
                    .eq('status', 'completed');
                
                if (!tripsError) {
                    const totalTrips = trips.length;
                    const totalSpent = trips.reduce((sum, trip) => sum + (trip.price || 0), 0);
                    
                    const totalTripsCount = document.getElementById('totalTripsCount');
                    const totalSpentElement = document.getElementById('totalSpent');
                    
                    if (totalTripsCount) totalTripsCount.textContent = totalTrips;
                    if (totalSpentElement) totalSpentElement.textContent = totalSpent;
                }
                
                const userRatingElement = document.getElementById('userRating');
                if (userRatingElement) userRatingElement.textContent = currentUser.rating || 'جدید';
                
            } catch (error) {
                console.error('Error loading profile stats:', error);
            }
        }

        // ذخیره پروفایل
        document.getElementById('saveProfile')?.addEventListener('click', async () => {
            const name = document.getElementById('editName').value;
            const email = document.getElementById('editEmail').value;
            const phone = document.getElementById('editPhone').value;
            
            if (!name || !email || !phone) {
                showNotification('لطفاً تمام فیلدها را پر کنید', 'error');
                return;
            }
            
            try {
                const { error } = await supabase
                    .from('users')
                    .update({ name, email, phone })
                    .eq('id', currentUser.id);
                
                if (error) throw error;
                
                // بروزرسانی کاربر فعلی
                currentUser.name = name;
                currentUser.email = email;
                currentUser.phone = phone;
                localStorage.setItem('snapp_current_user', JSON.stringify(currentUser));
                
                updateUIAfterLogin();
                showNotification('پروفایل با موفقیت به‌روزرسانی شد', 'success');
                
            } catch (error) {
                console.error('Error updating profile:', error);
                showNotification('خطا در به‌روزرسانی پروفایل', 'error');
            }
        });

        // مدال امتیازدهی
        function openRatingModal(tripId, driverName) {
            const ratingModal = document.getElementById('ratingModal');
            const ratingStars = document.getElementById('ratingStars');
            
            if (!ratingModal || !ratingStars) return;
            
            ratingModal.setAttribute('data-trip-id', tripId);
            
            if (driverName) {
                document.getElementById('ratingDriverName').textContent = driverName;
                document.getElementById('ratingDriverAvatar').textContent = driverName.charAt(0);
            }
            
            const stars = ratingStars.querySelectorAll('.rating-star');
            stars.forEach(star => {
                star.classList.remove('active');
                star.addEventListener('click', function() {
                    const rating = parseInt(this.getAttribute('data-rating'));
                    stars.forEach(s => {
                        if (parseInt(s.getAttribute('data-rating')) <= rating) {
                            s.classList.add('active');
                        } else {
                            s.classList.remove('active');
                        }
                    });
                    ratingModal.setAttribute('data-rating', rating);
                });
            });
            
            ratingModal.style.display = 'flex';
        }

        document.getElementById('submitRating')?.addEventListener('click', async () => {
            const tripId = document.getElementById('ratingModal').getAttribute('data-trip-id');
            const rating = document.getElementById('ratingModal').getAttribute('data-rating');
            const comment = document.getElementById('ratingComment').value;
            
            if (!rating) {
                showNotification('لطفاً امتیاز دهید', 'error');
                return;
            }
            
            try {
                // به‌روزرسانی سفر
                const { error: tripError } = await supabase
                    .from('trips')
                    .update({ 
                        rated: true,
                        rating: parseInt(rating),
                        rating_comment: comment
                    })
                    .eq('id', tripId);
                
                if (tripError) throw tripError;
                
                // محاسبه امتیاز جدید راننده
                const { data: trip, error: getTripError } = await supabase
                    .from('trips')
                    .select('driver_id, rating')
                    .eq('id', tripId)
                    .single();
                
                if (!getTripError && trip.driver_id) {
                    // دریافت امتیازهای قبلی راننده
                    const { data: driverTrips, error: driverTripsError } = await supabase
                        .from('trips')
                        .select('rating')
                        .eq('driver_id', trip.driver_id)
                        .not('rating', 'is', null);
                    
                    if (!driverTripsError) {
                        const ratings = driverTrips.map(t => t.rating);
                        const averageRating = ratings.reduce((a, b) => a + b, 0) / ratings.length;
                        
                        // به‌روزرسانی امتیاز راننده
                        await supabase
                            .from('drivers')
                            .update({ rating: averageRating.toFixed(1) })
                            .eq('id', trip.driver_id);
                    }
                }
                
                showNotification('امتیاز شما ثبت شد. متشکریم!', 'success');
                document.getElementById('ratingModal').style.display = 'none';
                loadMyTrips();
                
            } catch (error) {
                console.error('Error submitting rating:', error);
                showNotification('خطا در ثبت امتیاز', 'error');
            }
        });

        // مدال ورود/ثبتنام
        function openAuthModal() {
            const authModal = document.getElementById('authModal');
            if (authModal) authModal.style.display = 'flex';
            clearErrors();
        }

        // توابع کمکی برای دسترسی از المنت‌های HTML
        window.approveUser = approveUser;
        window.rejectUser = rejectUser;
        window.deactivateUser = deactivateUser;
        window.activateUser = activateUser;
        window.deleteUser = deleteUser;
        window.toggleDriverStatus = toggleDriverStatus;
        window.deleteDriver = deleteDriver;
        window.cancelTrip = cancelTrip;
        window.deleteTrip = deleteTrip;
        window.deleteDiscount = deleteDiscount;
        window.answerTicket = answerTicket;
        window.closeTicket = closeTicket;
        window.deleteTicket = deleteTicket;
        window.cancelUserTrip = cancelUserTrip;
        window.openRatingModal = openRatingModal;
    </script>
</body>
</html>
