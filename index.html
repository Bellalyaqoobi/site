<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>اسنپ افغانستان - تاکسی اینترنتی کابل</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Mapbox CSS -->
    <link href='https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.css' rel='stylesheet' />
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        :root {
            --primary: #00D474;
            --primary-dark: #00B562;
            --primary-light: #80EAB9;
            --secondary: #6C63FF;
            --accent: #FF6584;
            --light: #F8F9FA;
            --dark: #1A1A2E;
            --gray: #6c757d;
            --border: #E8EAF6;
            --shadow: 0 10px 30px rgba(0, 0, 0, 0.08);
            --radius: 16px;
            --afghan-red: #D32011;
            --afghan-black: #000000;
            --afghan-green: #00D474;
            --gradient-primary: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
            --gradient-dark: linear-gradient(135deg, var(--dark) 0%, #16213E 100%);
            --gradient-accent: linear-gradient(135deg, var(--accent) 0%, #FF9A9E 100%);
        }

        body {
            background-color: #F5F7FF;
            color: var(--dark);
            line-height: 1.6;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 0 20px;
            width: 100%;
        }

        /* صفحه خوشآمدگویی */
        .welcome-page {
            background: var(--gradient-dark);
            color: white;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            text-align: center;
            padding: 20px;
            position: relative;
            overflow: hidden;
        }

        .welcome-page::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: 
                radial-gradient(circle at 20% 80%, rgba(108, 99, 255, 0.1) 0%, transparent 50%),
                radial-gradient(circle at 80% 20%, rgba(0, 212, 116, 0.1) 0%, transparent 50%),
                radial-gradient(circle at 40% 40%, rgba(255, 101, 132, 0.05) 0%, transparent 50%);
            z-index: 0;
        }

        .welcome-content {
            max-width: 900px;
            margin: 0 auto;
            position: relative;
            z-index: 1;
        }

        .welcome-logo {
            font-size: 52px;
            margin-bottom: 25px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 20px;
            animation: float 3s ease-in-out infinite;
        }

        @keyframes float {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }

        .welcome-logo i {
            color: var(--primary);
            font-size: 64px;
            filter: drop-shadow(0 4px 12px rgba(0, 212, 116, 0.3));
        }

        .welcome-title {
            font-size: 48px;
            margin-bottom: 20px;
            font-weight: 800;
            background: var(--gradient-primary);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            text-shadow: 0 2px 10px rgba(0, 212, 116, 0.1);
        }

        .welcome-subtitle {
            font-size: 24px;
            margin-bottom: 40px;
            opacity: 0.9;
            font-weight: 300;
            letter-spacing: 0.5px;
        }

        .welcome-features {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 25px;
            margin: 50px 0;
        }

        .feature-card {
            background: rgba(255, 255, 255, 0.08);
            padding: 30px;
            border-radius: 20px;
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
        }

        .feature-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: var(--gradient-primary);
            transform: translateX(-100%);
            transition: transform 0.6s ease;
        }

        .feature-card:hover {
            transform: translateY(-8px) scale(1.02);
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.2);
            background: rgba(255, 255, 255, 0.12);
        }

        .feature-card:hover::before {
            transform: translateX(0);
        }

        .feature-icon {
            font-size: 42px;
            margin-bottom: 20px;
            color: var(--primary);
            background: rgba(0, 212, 116, 0.1);
            width: 70px;
            height: 70px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: all 0.3s;
        }

        .feature-card:hover .feature-icon {
            transform: scale(1.1) rotate(5deg);
            background: rgba(0, 212, 116, 0.2);
        }

        .feature-title {
            font-size: 22px;
            margin-bottom: 12px;
            font-weight: 600;
        }

        .feature-desc {
            font-size: 16px;
            opacity: 0.8;
            line-height: 1.8;
        }

        .welcome-actions {
            margin-top: 50px;
            display: flex;
            gap: 20px;
            justify-content: center;
            flex-wrap: wrap;
        }

        .btn-welcome {
            padding: 18px 40px;
            font-size: 18px;
            border-radius: 50px;
            font-weight: 600;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            min-width: 200px;
            position: relative;
            overflow: hidden;
        }

        .btn-welcome::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 5px;
            height: 5px;
            background: rgba(255, 255, 255, 0.5);
            opacity: 0;
            border-radius: 100%;
            transform: scale(1, 1) translate(-50%);
            transform-origin: 50% 50%;
        }

        .btn-welcome:hover::after {
            animation: ripple 1s ease-out;
        }

        @keyframes ripple {
            0% {
                transform: scale(0, 0);
                opacity: 0.5;
            }
            100% {
                transform: scale(40, 40);
                opacity: 0;
            }
        }

        .btn-welcome-primary {
            background: var(--gradient-primary);
            color: white;
            box-shadow: 0 10px 30px rgba(0, 212, 116, 0.3);
        }

        .btn-welcome-primary:hover {
            transform: translateY(-3px) scale(1.05);
            box-shadow: 0 15px 40px rgba(0, 212, 116, 0.4);
        }

        .btn-welcome-outline {
            background: transparent;
            border: 2px solid white;
            color: white;
        }

        .btn-welcome-outline:hover {
            background: white;
            color: var(--dark);
            transform: translateY(-3px) scale(1.05);
        }

        /* هدر */
        header {
            background: var(--gradient-dark);
            box-shadow: 0 4px 30px rgba(0, 0, 0, 0.1);
            position: sticky;
            top: 0;
            z-index: 1000;
            backdrop-filter: blur(10px);
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .nav-container {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 0;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 12px;
            font-size: 22px;
            font-weight: 700;
            color: white;
            text-decoration: none;
            transition: all 0.3s;
        }

        .logo:hover {
            transform: translateY(-2px);
        }

        .logo i {
            font-size: 28px;
            color: var(--primary);
            background: rgba(0, 212, 116, 0.1);
            width: 44px;
            height: 44px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 12px;
        }

        .nav-links {
            display: flex;
            list-style: none;
            gap: 30px;
        }

        .nav-links a {
            text-decoration: none;
            color: white;
            font-weight: 500;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 15px;
            padding: 8px 16px;
            border-radius: 12px;
            position: relative;
            overflow: hidden;
        }

        .nav-links a::before {
            content: '';
            position: absolute;
            bottom: 0;
            left: 50%;
            width: 0;
            height: 2px;
            background: var(--primary);
            transition: all 0.3s;
            transform: translateX(-50%);
        }

        .nav-links a:hover {
            background: rgba(255, 255, 255, 0.05);
        }

        .nav-links a:hover::before {
            width: 80%;
        }

        .nav-links a.active {
            background: rgba(0, 212, 116, 0.1);
            color: var(--primary);
        }

        .nav-links a.active::before {
            width: 80%;
        }

        .user-actions {
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .user-profile {
            display: flex;
            align-items: center;
            gap: 12px;
            color: white;
            cursor: pointer;
            padding: 8px 16px;
            border-radius: 12px;
            transition: all 0.3s;
        }

        .user-profile:hover {
            background: rgba(255, 255, 255, 0.05);
        }

        .user-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: var(--gradient-primary);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
            font-size: 16px;
            box-shadow: 0 4px 12px rgba(0, 212, 116, 0.3);
        }

        .user-name {
            font-weight: 500;
            font-size: 15px;
        }

        .btn {
            padding: 10px 24px;
            border-radius: 12px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s;
            border: none;
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 15px;
        }

        .btn-primary {
            background: var(--gradient-primary);
            color: white;
            box-shadow: 0 4px 15px rgba(0, 212, 116, 0.2);
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0, 212, 116, 0.3);
        }

        .btn-outline {
            background: transparent;
            border: 1px solid rgba(255, 255, 255, 0.3);
            color: white;
        }

        .btn-outline:hover {
            background: rgba(255, 255, 255, 0.05);
            border-color: rgba(255, 255, 255, 0.5);
        }

        /* منوی همبرگر */
        .hamburger {
            display: none;
            flex-direction: column;
            cursor: pointer;
            gap: 5px;
            z-index: 1001;
            padding: 10px;
        }

        .hamburger span {
            width: 28px;
            height: 3px;
            background: white;
            border-radius: 2px;
            transition: all 0.3s;
        }

        .hamburger.active span:nth-child(1) {
            transform: rotate(45deg) translate(6px, 6px);
        }

        .hamburger.active span:nth-child(2) {
            opacity: 0;
        }

        .hamburger.active span:nth-child(3) {
            transform: rotate(-45deg) translate(6px, -6px);
        }

        /* منوی موبایل */
        .mobile-menu {
            position: fixed;
            top: 0;
            right: -320px;
            width: 300px;
            height: 100%;
            background: var(--gradient-dark);
            box-shadow: -5px 0 30px rgba(0, 0, 0, 0.2);
            z-index: 1000;
            transition: right 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            padding: 20px;
            overflow-y: auto;
        }

        .mobile-menu.active {
            right: 0;
        }

        .mobile-menu-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 40px;
            padding-bottom: 20px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .mobile-menu-logo {
            display: flex;
            align-items: center;
            gap: 12px;
            font-size: 20px;
            font-weight: 700;
            color: white;
        }

        .mobile-menu-logo i {
            color: var(--primary);
            font-size: 24px;
        }

        .close-menu {
            background: none;
            border: none;
            font-size: 28px;
            cursor: pointer;
            color: white;
            opacity: 0.7;
            transition: opacity 0.3s;
        }

        .close-menu:hover {
            opacity: 1;
        }

        .mobile-nav-links {
            list-style: none;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .mobile-nav-links a {
            text-decoration: none;
            color: white;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 15px 20px;
            border-radius: 12px;
            transition: all 0.3s;
            font-size: 16px;
        }

        .mobile-nav-links a:hover,
        .mobile-nav-links a.active {
            background: rgba(0, 212, 116, 0.1);
            color: var(--primary);
        }

        .mobile-nav-links a i {
            width: 24px;
            text-align: center;
            font-size: 18px;
        }

        .mobile-user-actions {
            margin-top: 40px;
            display: flex;
            flex-direction: column;
            gap: 15px;
            padding: 20px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 16px;
        }

        .overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(5px);
            z-index: 999;
            display: none;
            opacity: 0;
            transition: opacity 0.3s;
        }

        .overlay.active {
            display: block;
            opacity: 1;
        }

        /* نقشه */
        .map-container {
            background: white;
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            overflow: hidden;
            height: 600px;
            position: relative;
            border: 1px solid var(--border);
        }

        #map {
            width: 100%;
            height: 100%;
        }

        /* نشانگرهای نقشه */
        .mapboxgl-marker {
            cursor: pointer;
        }

        .car-marker {
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.2); }
            100% { transform: scale(1); }
        }

        /* پنل درخواست سفر */
        .ride-panel {
            background: white;
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            padding: 25px;
            height: fit-content;
            border: 1px solid var(--border);
            position: sticky;
            top: 100px;
        }

        .panel-title {
            font-size: 20px;
            margin-bottom: 25px;
            color: var(--dark);
            display: flex;
            align-items: center;
            gap: 12px;
            padding-bottom: 15px;
            border-bottom: 2px solid var(--border);
        }

        .panel-title i {
            color: var(--primary);
            background: rgba(0, 212, 116, 0.1);
            width: 44px;
            height: 44px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 12px;
        }

        /* فرم درخواست تاکسی */
        .ride-form {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .form-group label {
            font-weight: 600;
            color: var(--dark);
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .input-with-icon {
            position: relative;
        }

        .form-input {
            padding: 15px 20px 15px 50px;
            border: 2px solid var(--border);
            border-radius: 12px;
            font-size: 16px;
            transition: all 0.3s;
            width: 100%;
            background: white;
        }

        .form-input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(0, 212, 116, 0.1);
        }

        .input-icon {
            position: absolute;
            left: 20px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--gray);
            font-size: 18px;
            transition: color 0.3s;
        }

        .form-input:focus + .input-icon {
            color: var(--primary);
        }

        .location-swap {
            display: flex;
            justify-content: center;
            margin: 10px 0;
        }

        .swap-btn {
            background: var(--light);
            border: none;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            color: var(--gray);
            transition: all 0.3s;
            font-size: 16px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .swap-btn:hover {
            background: var(--primary);
            color: white;
            transform: rotate(180deg);
        }

        /* انتخاب نوع سفر */
        .ride-type-selector {
            display: flex;
            flex-direction: column;
            gap: 12px;
            margin: 20px 0;
        }

        .ride-type {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 18px;
            border: 2px solid var(--border);
            border-radius: 16px;
            cursor: pointer;
            transition: all 0.3s;
            position: relative;
            overflow: hidden;
        }

        .ride-type::before {
            content: '';
            position: absolute;
            top: 0;
            right: 0;
            width: 4px;
            height: 0;
            background: var(--primary);
            transition: height 0.3s;
        }

        .ride-type:hover {
            border-color: var(--primary);
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0, 212, 116, 0.1);
        }

        .ride-type.selected {
            border-color: var(--primary);
            background: linear-gradient(135deg, rgba(0, 212, 116, 0.05) 0%, rgba(108, 99, 255, 0.05) 100%);
        }

        .ride-type.selected::before {
            height: 100%;
        }

        .ride-type-info {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .ride-icon {
            width: 44px;
            height: 44px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 18px;
            flex-shrink: 0;
            transition: all 0.3s;
        }

        .economy .ride-icon {
            background: var(--gradient-primary);
        }

        .comfort .ride-icon {
            background: var(--gradient-dark);
        }

        .bike .ride-icon {
            background: var(--gradient-accent);
        }

        .ride-details h3 {
            font-size: 16px;
            margin-bottom: 5px;
            font-weight: 600;
        }

        .ride-details p {
            font-size: 13px;
            color: var(--gray);
        }

        .ride-price {
            font-weight: 700;
            color: var(--dark);
            text-align: left;
            font-size: 16px;
            min-width: 100px;
        }

        .price-estimate {
            font-size: 12px;
            color: var(--gray);
            margin-top: 4px;
            font-weight: normal;
        }

        /* معلومات مسافت و قیمت */
        .trip-calculator {
            background: linear-gradient(135deg, rgba(0, 212, 116, 0.05) 0%, rgba(108, 99, 255, 0.05) 100%);
            padding: 20px;
            border-radius: 16px;
            margin: 20px 0;
            display: none;
            border: 1px solid var(--border);
        }

        .trip-calculator.active {
            display: block;
            animation: slideDown 0.3s ease;
        }

        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .calculator-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
            font-size: 15px;
        }

        .calculator-row:last-child {
            margin-bottom: 0;
            font-weight: 700;
            border-top: 1px solid var(--border);
            padding-top: 10px;
            font-size: 18px;
            color: var(--primary);
        }

        /* دکمه درخواست */
        .submit-btn {
            background: var(--gradient-primary);
            color: white;
            border: none;
            padding: 18px;
            border-radius: 16px;
            font-size: 18px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
            margin-top: 10px;
            box-shadow: 0 8px 25px rgba(0, 212, 116, 0.2);
        }

        .submit-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 15px 35px rgba(0, 212, 116, 0.3);
        }

        .submit-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        /* روش پرداخت */
        .payment-methods {
            display: flex;
            gap: 12px;
            margin-top: 15px;
        }

        .payment-method {
            flex: 1;
            padding: 15px;
            border: 2px solid var(--border);
            border-radius: 12px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
        }

        .payment-method i {
            font-size: 24px;
            transition: all 0.3s;
        }

        .payment-method.selected {
            border-color: var(--primary);
            background: rgba(0, 212, 116, 0.05);
        }

        .payment-method.selected i {
            color: var(--primary);
        }

        /* وضعیت جستجو */
        .searching-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            display: none;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 100;
        }

        .searching-animation {
            width: 80px;
            height: 80px;
            border: 4px solid var(--border);
            border-top: 4px solid var(--primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .searching-text {
            font-size: 18px;
            color: var(--dark);
            margin-bottom: 10px;
            text-align: center;
            font-weight: 600;
        }

        .cancel-search {
            background: transparent;
            border: 1px solid var(--gray);
            color: var(--gray);
            padding: 10px 24px;
            border-radius: 50px;
            cursor: pointer;
            margin-top: 15px;
            font-size: 14px;
            transition: all 0.3s;
        }

        .cancel-search:hover {
            background: var(--accent);
            border-color: var(--accent);
            color: white;
        }

        /* ردیابی زنده */
        .live-tracking {
            position: absolute;
            bottom: 25px;
            right: 25px;
            background: white;
            border-radius: 20px;
            box-shadow: 0 15px 40px rgba(0, 0, 0, 0.15);
            padding: 20px;
            z-index: 200;
            max-width: 320px;
            border: 1px solid var(--border);
            animation: slideUp 0.3s ease;
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .tracking-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 15px;
            border-bottom: 1px solid var(--border);
        }

        .tracking-header h3 {
            color: var(--primary);
            font-size: 16px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .tracking-info {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .tracking-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .tracking-label {
            color: var(--gray);
            font-size: 14px;
        }

        .tracking-value {
            font-weight: 600;
            font-size: 15px;
            color: var(--dark);
        }

        .progress-container {
            margin: 15px 0;
        }

        .progress-bar {
            height: 6px;
            background: var(--border);
            border-radius: 3px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: var(--gradient-primary);
            border-radius: 3px;
            width: 0%;
            transition: width 0.5s ease;
        }

        .progress-text {
            display: flex;
            justify-content: space-between;
            font-size: 12px;
            color: var(--gray);
            margin-top: 5px;
        }

        /* مدالها */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(10px);
            justify-content: center;
            align-items: center;
            z-index: 2000;
            padding: 20px;
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
            }
            to {
                opacity: 1;
            }
        }

        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 24px;
            max-width: 500px;
            width: 100%;
            box-shadow: 0 25px 50px rgba(0, 0, 0, 0.25);
            max-height: 90vh;
            overflow-y: auto;
            animation: modalSlideUp 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            border: 1px solid var(--border);
        }

        @keyframes modalSlideUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
            padding-bottom: 20px;
            border-bottom: 1px solid var(--border);
        }

        .modal-title {
            font-size: 24px;
            color: var(--dark);
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .modal-title i {
            color: var(--primary);
            background: rgba(0, 212, 116, 0.1);
            width: 44px;
            height: 44px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 12px;
        }

        .close-modal {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: var(--gray);
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 12px;
            transition: all 0.3s;
        }

        .close-modal:hover {
            background: var(--light);
            color: var(--dark);
        }

        /* مدال راننده */
        .driver-info {
            background: linear-gradient(135deg, rgba(0, 212, 116, 0.05) 0%, rgba(108, 99, 255, 0.05) 100%);
            padding: 25px;
            border-radius: 20px;
            margin: 25px 0;
            border: 1px solid var(--border);
        }

        .driver-details {
            display: flex;
            align-items: center;
            gap: 20px;
            margin-bottom: 20px;
        }

        .driver-avatar {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: var(--gradient-primary);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 24px;
            font-weight: 600;
            flex-shrink: 0;
            box-shadow: 0 8px 25px rgba(0, 212, 116, 0.3);
        }

        .driver-name-rating h3 {
            font-size: 18px;
            margin-bottom: 8px;
            color: var(--dark);
        }

        .driver-rating {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .driver-rating .stars {
            color: #FFC107;
            font-size: 16px;
        }

        .driver-rating span {
            font-size: 14px;
            color: var(--gray);
        }

        .car-details {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding-top: 20px;
            border-top: 1px solid var(--border);
        }

        .car-info {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .car-model {
            font-weight: 700;
            font-size: 16px;
            color: var(--dark);
        }

        .car-color {
            color: var(--gray);
            font-size: 14px;
        }

        .car-plate {
            background: var(--gradient-dark);
            color: white;
            padding: 8px 16px;
            border-radius: 12px;
            font-family: monospace;
            font-weight: 600;
            font-size: 16px;
            box-shadow: 0 4px 15px rgba(26, 26, 46, 0.2);
        }

        .trip-info {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
            margin: 25px 0;
            padding: 20px;
            background: white;
            border-radius: 16px;
            border: 1px solid var(--border);
        }

        .trip-detail {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
            text-align: center;
        }

        .trip-detail i {
            font-size: 22px;
            color: var(--primary);
            background: rgba(0, 212, 116, 0.1);
            width: 44px;
            height: 44px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 12px;
        }

        .trip-detail span {
            font-size: 13px;
            color: var(--gray);
        }

        .trip-detail .value {
            font-weight: 700;
            color: var(--dark);
            font-size: 18px;
        }

        .modal-actions {
            display: flex;
            gap: 15px;
        }

        .modal-actions .btn {
            flex: 1;
            justify-content: center;
            padding: 15px;
            font-size: 16px;
            font-weight: 600;
        }

        /* مدال امتیازدهی */
        .rating-stars {
            display: flex;
            gap: 8px;
            direction: ltr;
            margin: 20px 0;
            justify-content: center;
        }

        .rating-star {
            color: #E0E0E0;
            cursor: pointer;
            font-size: 36px;
            transition: all 0.3s;
            position: relative;
        }

        .rating-star:hover,
        .rating-star.active {
            color: #FFC107;
            transform: scale(1.1);
        }

        .rating-star:hover ~ .rating-star {
            color: #E0E0E0;
        }

        /* مناطق کابل */
        .kabul-districts {
            margin-top: 30px;
            background: white;
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            padding: 25px;
            border: 1px solid var(--border);
        }

        .districts-title {
            font-size: 18px;
            margin-bottom: 20px;
            color: var(--dark);
            display: flex;
            align-items: center;
            gap: 12px;
            padding-bottom: 15px;
            border-bottom: 1px solid var(--border);
        }

        .districts-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 12px;
        }

        .district-item {
            padding: 12px;
            background: var(--light);
            border-radius: 12px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 14px;
            font-weight: 500;
            border: 1px solid transparent;
        }

        .district-item:hover {
            background: var(--primary);
            color: white;
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0, 212, 116, 0.2);
            border-color: var(--primary);
        }

        /* نوتیفیکیشن */
        .notification {
            position: fixed;
            top: 30px;
            right: 30px;
            padding: 18px 24px;
            background: var(--gradient-dark);
            color: white;
            border-radius: 16px;
            box-shadow: 0 15px 40px rgba(0, 0, 0, 0.2);
            display: none;
            z-index: 3000;
            max-width: 350px;
            font-size: 15px;
            animation: slideInRight 0.3s ease;
            border: 1px solid rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
        }

        @keyframes slideInRight {
            from {
                opacity: 0;
                transform: translateX(100%);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        .notification.success {
            background: var(--gradient-primary);
        }

        .notification.error {
            background: var(--gradient-accent);
        }

        .notification.warning {
            background: linear-gradient(135deg, #FFB74D 0%, #FF9800 100%);
        }

        .notification.info {
            background: linear-gradient(135deg, #4FC3F7 0%, #0288D1 100%);
        }

        /* صفحات */
        .main-content {
            display: grid;
            grid-template-columns: 1fr 400px;
            gap: 30px;
            margin: 30px 0;
            flex: 1;
        }

        @media (max-width: 1200px) {
            .main-content {
                grid-template-columns: 1fr;
            }
            
            .ride-panel {
                position: static;
                margin-top: 20px;
            }
        }

        /* استایل‌های عمومی صفحات */
        .page {
            display: none;
            background: white;
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            padding: 30px;
            margin: 30px 0;
            min-height: 500px;
            border: 1px solid var(--border);
        }

        .page.active {
            display: block;
            animation: fadeIn 0.5s ease;
        }

        .page-title {
            font-size: 28px;
            margin-bottom: 30px;
            color: var(--dark);
            display: flex;
            align-items: center;
            gap: 15px;
            padding-bottom: 20px;
            border-bottom: 2px solid var(--border);
        }

        .page-title i {
            color: var(--primary);
            background: rgba(0, 212, 116, 0.1);
            width: 52px;
            height: 52px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 16px;
            font-size: 22px;
        }

        /* جدول‌ها */
        .table-container {
            overflow-x: auto;
            margin-top: 25px;
            border-radius: 16px;
            border: 1px solid var(--border);
            box-shadow: 0 4px 15px rgba(0,0,0,0.05);
        }

        .data-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 15px;
            min-width: 800px;
        }

        .data-table th {
            background: linear-gradient(135deg, rgba(0, 212, 116, 0.05) 0%, rgba(108, 99, 255, 0.05) 100%);
            padding: 18px 20px;
            text-align: right;
            font-weight: 600;
            color: var(--dark);
            border-bottom: 1px solid var(--border);
        }

        .data-table td {
            padding: 16px 20px;
            text-align: right;
            border-bottom: 1px solid var(--border);
            transition: background 0.3s;
        }

        .data-table tbody tr:hover {
            background: rgba(0, 212, 116, 0.03);
        }

        .data-table tbody tr:last-child td {
            border-bottom: none;
        }

        .status-badge {
            padding: 6px 14px;
            border-radius: 50px;
            font-size: 13px;
            font-weight: 600;
            display: inline-block;
        }

        .status-requested { background: #FFF3E0; color: #EF6C00; }
        .status-confirmed { background: #E3F2FD; color: #1976D2; }
        .status-completed { background: #E8F5E9; color: #388E3C; }
        .status-cancelled { background: #FFEBEE; color: #D32F2F; }
        .status-approved { background: #E8F5E9; color: #388E3C; }
        .status-pending { background: #FFF3E0; color: #EF6C00; }
        .status-rejected { background: #FFEBEE; color: #D32F2F; }
        .status-active { background: #E8F5E9; color: #388E3C; }
        .status-inactive { background: #F5F5F5; color: #757575; }

        .action-buttons {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        .action-btn {
            padding: 6px 14px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 13px;
            font-weight: 500;
            transition: all 0.3s;
        }

        .btn-approve {
            background: var(--gradient-primary);
            color: white;
        }

        .btn-reject {
            background: var(--gradient-accent);
            color: white;
        }

        .btn-edit {
            background: var(--gradient-dark);
            color: white;
        }

        .action-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }

        /* پنل مدیریت */
        .admin-panel {
            display: none;
        }

        .admin-panel.active {
            display: block;
        }

        .admin-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 25px;
            margin-bottom: 40px;
        }

        .stat-card {
            background: white;
            padding: 25px;
            border-radius: 20px;
            box-shadow: var(--shadow);
            border: 1px solid var(--border);
            transition: all 0.3s;
            position: relative;
            overflow: hidden;
        }

        .stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            right: 0;
            width: 100%;
            height: 4px;
            background: var(--gradient-primary);
            transform: translateX(-100%);
            transition: transform 0.6s ease;
        }

        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
        }

        .stat-card:hover::before {
            transform: translateX(0);
        }

        .stat-card h3 {
            font-size: 15px;
            margin-bottom: 15px;
            color: var(--gray);
            font-weight: 500;
        }

        .stat-card .value {
            font-size: 32px;
            font-weight: 700;
            color: var(--primary);
            margin-bottom: 10px;
        }

        .stat-card .change {
            font-size: 14px;
            color: var(--gray);
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .stat-card .change.positive {
            color: var(--primary);
        }

        .stat-card .change.negative {
            color: var(--accent);
        }

        .admin-tabs {
            display: flex;
            border-bottom: 2px solid var(--border);
            margin-bottom: 30px;
            overflow-x: auto;
            padding-bottom: 2px;
        }

        .admin-tab {
            padding: 15px 25px;
            cursor: pointer;
            border-bottom: 2px solid transparent;
            transition: all 0.3s;
            font-weight: 500;
            white-space: nowrap;
            position: relative;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .admin-tab:hover {
            color: var(--primary);
        }

        .admin-tab.active {
            color: var(--primary);
            border-bottom-color: var(--primary);
        }

        .admin-tab i {
            font-size: 16px;
        }

        .admin-tab-content {
            display: none;
            animation: fadeIn 0.5s ease;
        }

        .admin-tab-content.active {
            display: block;
        }

        .tab-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
            flex-wrap: wrap;
            gap: 15px;
        }

        /* کارت تخفیف */
        .discount-card {
            background: white;
            border-radius: 20px;
            box-shadow: var(--shadow);
            padding: 25px;
            margin-bottom: 25px;
            border: 1px solid var(--border);
            transition: all 0.3s;
            position: relative;
            overflow: hidden;
        }

        .discount-card::before {
            content: '';
            position: absolute;
            top: 0;
            right: 0;
            width: 4px;
            height: 100%;
            background: var(--gradient-primary);
        }

        .discount-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.1);
        }

        .discount-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .discount-code {
            font-size: 20px;
            font-weight: 700;
            color: var(--primary);
            font-family: monospace;
        }

        .discount-percent {
            background: var(--gradient-primary);
            color: white;
            padding: 6px 16px;
            border-radius: 50px;
            font-size: 15px;
            font-weight: 600;
        }

        .discount-details {
            display: flex;
            justify-content: space-between;
            color: var(--gray);
            font-size: 14px;
            margin-bottom: 15px;
        }

        .discount-progress {
            margin-top: 15px;
        }

        .progress-text {
            display: flex;
            justify-content: space-between;
            font-size: 13px;
            color: var(--gray);
            margin-bottom: 8px;
        }

        .progress-bar {
            height: 6px;
            background: var(--border);
            border-radius: 3px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: var(--gradient-primary);
            border-radius: 3px;
        }

        /* پیشنهادات */
        .suggestions {
            background: white;
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            margin-top: 25px;
            padding: 25px;
            border: 1px solid var(--border);
        }

        .suggestions-title {
            font-size: 18px;
            margin-bottom: 20px;
            color: var(--dark);
            display: flex;
            align-items: center;
            gap: 12px;
            padding-bottom: 15px;
            border-bottom: 1px solid var(--border);
        }

        .suggestion-list {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
        }

        .suggestion-item {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 18px;
            border: 1px solid var(--border);
            border-radius: 16px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .suggestion-item:hover {
            border-color: var(--primary);
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(0, 212, 116, 0.1);
        }

        .suggestion-icon {
            width: 44px;
            height: 44px;
            border-radius: 12px;
            background: rgba(0, 212, 116, 0.1);
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--primary);
            font-size: 18px;
            flex-shrink: 0;
        }

        .suggestion-text {
            font-weight: 500;
            font-size: 15px;
            color: var(--dark);
        }

        /* بنر تبلیغاتی */
        .promo-banner {
            background: var(--gradient-primary);
            color: white;
            padding: 25px;
            border-radius: 20px;
            margin: 30px 0;
            text-align: center;
            position: relative;
            overflow: hidden;
            box-shadow: 0 15px 40px rgba(0, 212, 116, 0.3);
        }

        .promo-banner::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(255,255,255,0.1) 1px, transparent 1px);
            background-size: 20px 20px;
            opacity: 0.3;
            animation: moveBackground 20s linear infinite;
        }

        @keyframes moveBackground {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        .promo-title {
            font-size: 24px;
            margin-bottom: 10px;
            font-weight: 700;
            position: relative;
            z-index: 1;
        }

        .promo-desc {
            font-size: 16px;
            opacity: 0.9;
            position: relative;
            z-index: 1;
        }

        /* چت پشتیبانی */
        .chat-container {
            height: 500px;
            border: 1px solid var(--border);
            border-radius: 20px;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            background: white;
        }

        .chat-messages {
            flex: 1;
            padding: 25px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 15px;
            background: linear-gradient(135deg, #F8F9FA 0%, #FFFFFF 100%);
        }

        .message {
            max-width: 80%;
            padding: 15px 20px;
            border-radius: 20px;
            font-size: 15px;
            line-height: 1.6;
            position: relative;
            animation: messageAppear 0.3s ease;
        }

        @keyframes messageAppear {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .message.received {
            align-self: flex-start;
            background: white;
            border-bottom-right-radius: 5px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.05);
            border: 1px solid var(--border);
        }

        .message.sent {
            align-self: flex-end;
            background: var(--gradient-primary);
            color: white;
            border-bottom-left-radius: 5px;
            box-shadow: 0 4px 15px rgba(0, 212, 116, 0.2);
        }

        .message-time {
            font-size: 11px;
            opacity: 0.7;
            margin-top: 5px;
            text-align: left;
        }

        .chat-input {
            display: flex;
            padding: 20px;
            border-top: 1px solid var(--border);
            background: white;
            gap: 12px;
        }

        .chat-input input {
            flex: 1;
            padding: 14px 20px;
            border: 1px solid var(--border);
            border-radius: 50px;
            outline: none;
            font-size: 15px;
            transition: all 0.3s;
        }

        .chat-input input:focus {
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(0, 212, 116, 0.1);
        }

        .chat-input button {
            background: var(--gradient-primary);
            color: white;
            border: none;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 18px;
            transition: all 0.3s;
            flex-shrink: 0;
        }

        .chat-input button:hover {
            transform: scale(1.05);
            box-shadow: 0 8px 25px rgba(0, 212, 116, 0.3);
        }

        /* پروفایل */
        .profile-section {
            display: flex;
            flex-direction: column;
            gap: 30px;
        }

        .profile-header {
            display: flex;
            align-items: center;
            gap: 25px;
            padding-bottom: 25px;
            border-bottom: 1px solid var(--border);
        }

        .profile-avatar {
            width: 100px;
            height: 100px;
            border-radius: 50%;
            background: var(--gradient-primary);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 36px;
            font-weight: 700;
            box-shadow: 0 15px 40px rgba(0, 212, 116, 0.3);
            flex-shrink: 0;
        }

        .profile-info h3 {
            font-size: 24px;
            margin-bottom: 8px;
            color: var(--dark);
        }

        .profile-info p {
            color: var(--gray);
            font-size: 16px;
            margin-bottom: 5px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .profile-info p i {
            width: 20px;
            color: var(--primary);
        }

        .profile-stats {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 20px;
            margin: 20px 0;
        }

        .profile-stat {
            text-align: center;
            padding: 25px;
            background: linear-gradient(135deg, rgba(0, 212, 116, 0.05) 0%, rgba(108, 99, 255, 0.05) 100%);
            border-radius: 16px;
            border: 1px solid var(--border);
            transition: all 0.3s;
        }

        .profile-stat:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 35px rgba(0, 212, 116, 0.1);
        }

        .profile-stat .value {
            font-size: 32px;
            font-weight: 700;
            color: var(--primary);
            margin-bottom: 8px;
        }

        .profile-stat .label {
            font-size: 14px;
            color: var(--gray);
        }

        /* مراحل سفر */
        .trip-progress {
            margin: 30px 0;
        }

        .progress-steps {
            display: flex;
            justify-content: space-between;
            position: relative;
            margin-bottom: 40px;
        }

        .progress-steps::before {
            content: '';
            position: absolute;
            top: 20px;
            right: 50px;
            left: 50px;
            height: 3px;
            background: var(--border);
            z-index: 1;
        }

        .progress-step {
            display: flex;
            flex-direction: column;
            align-items: center;
            position: relative;
            z-index: 2;
            flex: 1;
        }

        .step-icon {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: white;
            border: 3px solid var(--border);
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 10px;
            transition: all 0.3s;
            font-size: 16px;
            color: var(--gray);
        }

        .step-icon.active {
            background: var(--primary);
            border-color: var(--primary);
            color: white;
            box-shadow: 0 8px 25px rgba(0, 212, 116, 0.3);
        }

        .step-label {
            font-size: 13px;
            color: var(--gray);
            text-align: center;
            font-weight: 500;
        }

        .step-label.active {
            color: var(--primary);
            font-weight: 600;
        }

        /* فرم‌های احراز هویت */
        .auth-form {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .form-tabs {
            display: flex;
            border-bottom: 2px solid var(--border);
            margin-bottom: 25px;
        }

        .form-tab {
            padding: 12px 25px;
            cursor: pointer;
            border-bottom: 2px solid transparent;
            transition: all 0.3s;
            font-size: 16px;
            font-weight: 500;
        }

        .form-tab.active {
            border-bottom: 2px solid var(--primary);
            color: var(--primary);
        }

        .form-tab-content {
            display: none;
        }

        .form-tab-content.active {
            display: block;
        }

        .password-toggle {
            position: absolute;
            left: 20px;
            top: 50%;
            transform: translateY(-50%);
            background: none;
            border: none;
            cursor: pointer;
            color: var(--gray);
            font-size: 16px;
        }

        .form-footer {
            text-align: center;
            margin-top: 20px;
            font-size: 14px;
            color: var(--gray);
        }

        .form-footer a {
            color: var(--primary);
            text-decoration: none;
            font-weight: 500;
            transition: color 0.3s;
        }

        .form-footer a:hover {
            text-decoration: underline;
        }

        .error-message {
            color: var(--accent);
            font-size: 13px;
            margin-top: 5px;
            display: none;
            font-weight: 500;
        }

        /* فوتر */
        footer {
            background: var(--gradient-dark);
            color: white;
            padding: 50px 0 25px;
            margin-top: auto;
        }

        .footer-content {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 30px;
            margin-bottom: 30px;
        }

        .footer-column h3 {
            font-size: 18px;
            margin-bottom: 20px;
            color: var(--primary);
            font-weight: 600;
        }

        .footer-links {
            list-style: none;
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .footer-links a {
            color: rgba(255, 255, 255, 0.8);
            text-decoration: none;
            transition: all 0.3s;
            font-size: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .footer-links a:hover {
            color: var(--primary);
            transform: translateX(-5px);
        }

        .social-links {
            display: flex;
            gap: 15px;
            margin-top: 20px;
        }

        .social-links a {
            color: white;
            font-size: 20px;
            transition: all 0.3s;
            width: 44px;
            height: 44px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 12px;
        }

        .social-links a:hover {
            background: var(--primary);
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(0, 212, 116, 0.3);
        }

        .footer-bottom {
            text-align: center;
            padding-top: 25px;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            color: rgba(255, 255, 255, 0.6);
            font-size: 14px;
        }

        /* ریسپانسیو */
        @media (max-width: 1200px) {
            .container {
                max-width: 100%;
            }
            
            .footer-content {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        @media (max-width: 992px) {
            .nav-links {
                display: none;
            }

            .hamburger {
                display: flex;
            }

            .user-actions .btn {
                display: none;
            }

            .main-content {
                grid-template-columns: 1fr;
                gap: 25px;
            }

            .map-container {
                height: 450px;
            }

            .suggestion-list {
                grid-template-columns: 1fr;
            }

            .districts-grid {
                grid-template-columns: repeat(2, 1fr);
            }

            .profile-header {
                flex-direction: column;
                text-align: center;
                gap: 20px;
            }

            .profile-stats {
                grid-template-columns: 1fr;
            }
        }

        @media (max-width: 768px) {
            .container {
                padding: 0 15px;
            }

            .logo {
                font-size: 20px;
            }

            .logo i {
                font-size: 24px;
                width: 40px;
                height: 40px;
            }

            .welcome-title {
                font-size: 36px;
            }

            .welcome-subtitle {
                font-size: 20px;
            }

            .welcome-features {
                grid-template-columns: 1fr;
            }

            .welcome-actions {
                flex-direction: column;
            }

            .btn-welcome {
                min-width: 100%;
            }

            .page-title {
                font-size: 24px;
            }

            .page-title i {
                width: 44px;
                height: 44px;
                font-size: 20px;
            }

            .modal-content {
                padding: 25px;
            }

            .modal-title {
                font-size: 20px;
            }

            .trip-info {
                grid-template-columns: 1fr;
                gap: 20px;
            }

            .admin-stats {
                grid-template-columns: 1fr;
            }

            .admin-tabs {
                flex-direction: column;
                border-bottom: none;
                gap: 10px;
            }

            .admin-tab {
                border: 1px solid var(--border);
                border-radius: 12px;
                padding: 15px;
            }

            .admin-tab.active {
                border-color: var(--primary);
                background: rgba(0, 212, 116, 0.05);
            }

            .footer-content {
                grid-template-columns: 1fr;
                gap: 25px;
            }

            .chat-container {
                height: 400px;
            }
        }

        @media (max-width: 576px) {
            .container {
                padding: 0 10px;
            }

            .map-container {
                height: 400px;
            }

            .ride-panel {
                padding: 20px;
            }

            .districts-grid {
                grid-template-columns: 1fr;
            }

            .modal-content {
                padding: 20px;
            }

            .notification {
                right: 10px;
                left: 10px;
                max-width: none;
            }

            .mobile-menu {
                width: 280px;
            }

            .profile-stat {
                padding: 20px;
            }

            .profile-stat .value {
                font-size: 28px;
            }
        }

        @media (max-width: 400px) {
            .modal-content {
                padding: 15px;
            }

            .page {
                padding: 20px;
            }

            .suggestion-item {
                flex-direction: column;
                text-align: center;
                gap: 10px;
            }
        }
    </style>
</head>
<body>
    <!-- صفحه خوشآمدگویی -->
    <div class="welcome-page" id="welcome-page">
        <div class="welcome-content">
            <div class="welcome-logo">
                <i class="fas fa-car-side"></i>
                <span>اسنپ افغانستان</span>
            </div>
            <h1 class="welcome-title">سرویس تاکسی اینترنتی در سراسر کابل</h1>
            <p class="welcome-subtitle">سریع، مطمئن و مقرون به صرفه</p>
            
            <div class="welcome-features">
                <div class="feature-card">
                    <div class="feature-icon">
                        <i class="fas fa-bolt"></i>
                    </div>
                    <h3 class="feature-title">سریع و آسان</h3>
                    <p class="feature-desc">در کمتر از ۵ دقیقه یک خودرو در نزدیکی شما خواهد بود</p>
                </div>
                <div class="feature-card">
                    <div class="feature-icon">
                        <i class="fas fa-shield-alt"></i>
                    </div>
                    <h3 class="feature-title">مطمئن و امن</h3>
                    <p class="feature-desc">تمام رانندگان ما تایید شده و دارای بیمه هستند</p>
                </div>
                <div class="feature-card">
                    <div class="feature-icon">
                        <i class="fas fa-money-bill-wave"></i>
                    </div>
                    <h3 class="feature-title">قیمت مناسب</h3>
                    <p class="feature-desc">قیمتهای شفاف و رقابتی با امکان پرداخت نقدی</p>
                </div>
            </div>
            
            <div class="welcome-actions">
                <button class="btn-welcome btn-welcome-primary" id="start-using-btn">
                    <i class="fas fa-play-circle"></i>
                    شروع استفاده از اسنپ
                </button>
                <button class="btn-welcome btn-welcome-outline" id="learn-more-btn">
                    <i class="fas fa-info-circle"></i>
                    اطلاعات بیشتر
                </button>
            </div>
        </div>
    </div>

    <!-- هدر -->
    <header style="display: none;" id="main-header">
        <div class="container nav-container">
            <a href="#" class="logo" data-page="home">
                <i class="fas fa-car-side"></i>
                <span>اسنپ افغانستان</span>
            </a>
            <ul class="nav-links">
                <li><a href="#" class="nav-link active" data-page="home"><i class="fas fa-home"></i> خانه</a></li>
                <li><a href="#" class="nav-link" data-page="my-trips"><i class="fas fa-history"></i> سفرهای من</a></li>
                <li><a href="#" class="nav-link" data-page="discounts"><i class="fas fa-gift"></i> تخفیفها</a></li>
                <li><a href="#" class="nav-link" data-page="support"><i class="fas fa-question-circle"></i> پشتیبانی</a></li>
                <li><a href="#" class="nav-link" data-page="profile"><i class="fas fa-user"></i> پروفایل</a></li>
                <li><a href="#" class="nav-link" data-page="admin" id="adminLink" style="display: none;"><i class="fas fa-cog"></i> پنل مدیریت</a></li>
            </ul>
            <div class="user-actions">
                <div class="user-profile" id="userProfile" style="display: none;">
                    <div class="user-avatar" id="userAvatar">ا</div>
                    <div class="user-name" id="userName">احمد محمدی</div>
                </div>
                <button class="btn btn-outline" id="loginBtn"><i class="fas fa-user"></i> ورود / ثبتنام</button>
                <button class="btn btn-outline" id="logoutBtn" style="display: none;"><i class="fas fa-sign-out-alt"></i> خروج</button>
            </div>
            <div class="hamburger" id="hamburger">
                <span></span>
                <span></span>
                <span></span>
            </div>
        </div>
    </header>

    <!-- منوی موبایل -->
    <div class="mobile-menu" id="mobileMenu">
        <div class="mobile-menu-header">
            <div class="mobile-menu-logo">
                <i class="fas fa-car-side"></i>
                <span>اسنپ افغانستان</span>
            </div>
            <button class="close-menu" id="closeMenu">&times;</button>
        </div>
        <ul class="mobile-nav-links">
            <li><a href="#" class="nav-link active" data-page="home"><i class="fas fa-home"></i> خانه</a></li>
            <li><a href="#" class="nav-link" data-page="my-trips"><i class="fas fa-history"></i> سفرهای من</a></li>
            <li><a href="#" class="nav-link" data-page="discounts"><i class="fas fa-gift"></i> تخفیفها</a></li>
            <li><a href="#" class="nav-link" data-page="support"><i class="fas fa-question-circle"></i> پشتیبانی</a></li>
            <li><a href="#" class="nav-link" data-page="profile"><i class="fas fa-user"></i> پروفایل</a></li>
            <li><a href="#" class="nav-link" data-page="admin" id="mobileAdminLink" style="display: none;"><i class="fas fa-cog"></i> پنل مدیریت</a></li>
        </ul>
        <div class="mobile-user-actions">
            <button class="btn btn-primary" id="mobileLoginBtn" style="width: 100%;">ورود / ثبتنام</button>
            <button class="btn btn-outline" id="mobileLogoutBtn" style="width: 100%; display: none;">خروج</button>
        </div>
    </div>
    <div class="overlay" id="overlay"></div>

    <!-- محتوای اصلی -->
    <div class="container" style="display: none;" id="main-container">
        <div class="page active" id="home-page">
            <div class="main-content">
                <!-- نقشه کابل -->
                <div class="map-container">
                    <div id="map"></div>
                    
                    <!-- ردیابی زنده -->
                    <div class="live-tracking" id="liveTracking" style="display: none;">
                        <div class="tracking-header">
                            <h3><i class="fas fa-map-marker-alt"></i> ردیابی زنده</h3>
                            <button class="close-modal" id="closeTracking">&times;</button>
                        </div>
                        <div class="tracking-info">
                            <div class="tracking-row">
                                <span class="tracking-label">راننده:</span>
                                <span class="tracking-value" id="trackingDriverName">احمد ظاهر</span>
                            </div>
                            <div class="tracking-row">
                                <span class="tracking-label">زمان رسیدن:</span>
                                <span class="tracking-value" id="trackingETA">۴ دقیقه</span>
                            </div>
                            <div class="tracking-row">
                                <span class="tracking-label">مسافت باقی‌مانده:</span>
                                <span class="tracking-value" id="trackingDistance">۲.۸ کیلومتر</span>
                            </div>
                            <div class="progress-container">
                                <div class="progress-bar">
                                    <div class="progress-fill" id="trackingProgress"></div>
                                </div>
                                <div class="progress-text">
                                    <span>مبدا</span>
                                    <span>مقصد</span>
                                </div>
                            </div>
                            <button class="btn btn-outline" id="cancelTracking" style="width: 100%; margin-top: 10px;">
                                <i class="fas fa-times"></i>
                                لغو سفر
                            </button>
                        </div>
                    </div>
                    
                    <!-- وضعیت جستجو -->
                    <div class="searching-overlay" id="searchingOverlay">
                        <div class="searching-animation"></div>
                        <div class="searching-text" id="searchingText">در حال یافتن نزدیکترین راننده...</div>
                        <button class="cancel-search" id="cancelSearch">لغو درخواست</button>
                    </div>
                </div>

                <!-- پنل درخواست سفر -->
                <div class="ride-panel">
                    <h2 class="panel-title"><i class="fas fa-map-marker-alt"></i> درخواست سفر</h2>
                    
                    <form class="ride-form" id="rideForm">
                        <div class="form-group">
                            <label for="pickup"><i class="fas fa-circle"></i> مبدا</label>
                            <div class="input-with-icon">
                                <i class="fas fa-map-marker-alt input-icon"></i>
                                <input type="text" id="pickup" class="form-input" placeholder="آدرس فعلی شما" required>
                            </div>
                        </div>
                        
                        <div class="location-swap">
                            <button type="button" class="swap-btn" id="swapLocations">
                                <i class="fas fa-exchange-alt"></i>
                            </button>
                        </div>
                        
                        <div class="form-group">
                            <label for="destination"><i class="fas fa-flag-checkered"></i> مقصد</label>
                            <div class="input-with-icon">
                                <i class="fas fa-flag-checkered input-icon"></i>
                                <input type="text" id="destination" class="form-input" placeholder="محل مورد نظر شما" required>
                            </div>
                        </div>

                        <!-- محاسبه قیمت -->
                        <div class="trip-calculator" id="tripCalculator">
                            <div class="calculator-row">
                                <span>مسافت تخمینی:</span>
                                <span id="distanceValue">0 کیلومتر</span>
                            </div>
                            <div class="calculator-row">
                                <span>کرایه پایه:</span>
                                <span id="baseFareValue">0 افغانی</span>
                            </div>
                            <div class="calculator-row">
                                <span>کرایه مسافت:</span>
                                <span id="distanceFareValue">0 افغانی</span>
                            </div>
                            <div class="calculator-row">
                                <span>هزینه نهایی:</span>
                                <span id="totalFareValue">0 افغانی</span>
                            </div>
                        </div>

                        <div class="form-group">
                            <label><i class="fas fa-car"></i> نوع سفر</label>
                            <div class="ride-type-selector" id="rideTypeSelector">
                                <div class="ride-type economy" data-type="economy" data-base-fare="50">
                                    <div class="ride-type-info">
                                        <div class="ride-icon">
                                            <i class="fas fa-car"></i>
                                        </div>
                                        <div class="ride-details">
                                            <h3>اقتصادی</h3>
                                            <p>مناسب برای سفرهای روزمره</p>
                                        </div>
                                    </div>
                                    <div class="ride-price">
                                        <div id="economyPrice">-- افغانی</div>
                                        <div class="price-estimate">برآورد قیمت</div>
                                    </div>
                                </div>
                                <div class="ride-type comfort" data-type="comfort" data-base-fare="80">
                                    <div class="ride-type-info">
                                        <div class="ride-icon">
                                            <i class="fas fa-car-side"></i>
                                        </div>
                                        <div class="ride-details">
                                            <h3>کلاسیک</h3>
                                            <p>خودروی مناسب و راحت</p>
                                        </div>
                                    </div>
                                    <div class="ride-price">
                                        <div id="comfortPrice">-- افغانی</div>
                                        <div class="price-estimate">برآورد قیمت</div>
                                    </div>
                                </div>
                                <div class="ride-type bike" data-type="bike" data-base-fare="30">
                                    <div class="ride-type-info">
                                        <div class="ride-icon">
                                            <i class="fas fa-motorcycle"></i>
                                        </div>
                                        <div class="ride-details">
                                            <h3>موتور</h3>
                                            <p>سریع و مقرون به صرفه</p>
                                        </div>
                                    </div>
                                    <div class="ride-price">
                                        <div id="bikePrice">-- افغانی</div>
                                        <div class="price-estimate">برآورد قیمت</div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- روش پرداخت -->
                        <div class="form-group">
                            <label><i class="fas fa-credit-card"></i> روش پرداخت</label>
                            <div class="payment-methods">
                                <div class="payment-method selected" data-method="cash">
                                    <i class="fas fa-money-bill-wave"></i>
                                    <span>نقدی</span>
                                </div>
                                <div class="payment-method" data-method="wallet">
                                    <i class="fas fa-wallet"></i>
                                    <span>کیف پول</span>
                                </div>
                            </div>
                        </div>

                        <button type="submit" class="submit-btn" id="submitBtn">
                            <i class="fas fa-search"></i>
                            درخواست خودرو
                        </button>
                    </form>

                    <!-- مناطق کابل -->
                    <div class="kabul-districts">
                        <h3 class="districts-title"><i class="fas fa-map"></i> مناطق کابل</h3>
                        <div class="districts-grid" id="districtsGrid">
                            <!-- مناطق به صورت داینامیک اضافه می‌شوند -->
                        </div>
                    </div>
                </div>
            </div>

            <!-- پیشنهادات مقصد -->
            <div class="suggestions">
                <h3 class="suggestions-title"><i class="fas fa-fire"></i> مقاصد پرطرفدار در کابل</h3>
                <div class="suggestion-list">
                    <div class="suggestion-item" data-destination="میدان هوایی بین المللی کابل">
                        <div class="suggestion-icon">
                            <i class="fas fa-plane"></i>
                        </div>
                        <div class="suggestion-text">میدان هوایی بین المللی کابل</div>
                    </div>
                    <div class="suggestion-item" data-destination="سفارت امریکا">
                        <div class="suggestion-icon">
                            <i class="fas fa-landmark"></i>
                        </div>
                        <div class="suggestion-text">سفارت امریکا</div>
                    </div>
                    <div class="suggestion-item" data-destination="سفارت ایران">
                        <div class="suggestion-icon">
                            <i class="fas fa-landmark"></i>
                        </div>
                        <div class="suggestion-text">سفارت ایران</div>
                    </div>
                    <div class="suggestion-item" data-destination="سفارت پاکستان">
                        <div class="suggestion-icon">
                            <i class="fas fa-landmark"></i>
                        </div>
                        <div class="suggestion-text">سفارت پاکستان</div>
                    </div>
                    <div class="suggestion-item" data-destination="وزارت امور خارجه">
                        <div class="suggestion-icon">
                            <i class="fas fa-building"></i>
                        </div>
                        <div class="suggestion-text">وزارت امور خارجه</div>
                    </div>
                    <div class="suggestion-item" data-destination="ارگ ریاست جمهوری">
                        <div class="suggestion-icon">
                            <i class="fas fa-monument"></i>
                        </div>
                        <div class="suggestion-text">ارگ ریاست جمهوری</div>
                    </div>
                </div>
            </div>

            <!-- بنر تبلیغاتی -->
            <div class="promo-banner">
                <div class="promo-title">اولین سفر رایگان!</div>
                <div class="promo-desc">با کد WELCOME100 از ۱۰۰ افغانی تخفیف در اولین سفر خود استفاده کنید</div>
            </div>
        </div>

        <!-- صفحه سفرهای من -->
        <div class="page" id="my-trips-page">
            <h2 class="page-title"><i class="fas fa-history"></i> سفرهای من</h2>
            <div class="table-container">
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>تاریخ</th>
                            <th>مبدا</th>
                            <th>مقصد</th>
                            <th>نوع سفر</th>
                            <th>مسافت</th>
                            <th>هزینه</th>
                            <th>وضعیت</th>
                            <th>عملیات</th>
                        </tr>
                    </thead>
                    <tbody id="myTripsTable">
                        <!-- سفرهای کاربر به صورت داینامیک اضافه می‌شوند -->
                    </tbody>
                </table>
            </div>
        </div>

        <!-- صفحه تخفیفها -->
        <div class="page" id="discounts-page">
            <h2 class="page-title"><i class="fas fa-gift"></i> تخفیفها</h2>
            <div id="discountsList">
                <!-- تخفیفها به صورت داینامیک اضافه می‌شوند -->
            </div>
        </div>

        <!-- صفحه پشتیبانی -->
        <div class="page" id="support-page">
            <h2 class="page-title"><i class="fas fa-question-circle"></i> پشتیبانی</h2>
            
            <div class="chat-container">
                <div class="chat-messages" id="chatMessages">
                    <div class="message received">
                        سلام! به پشتیبانی اسنپ افغانستان خوش آمدید. چگونه میتوانم کمکتان کنم؟
                        <div class="message-time">امروز ۱۲:۳۰</div>
                    </div>
                </div>
                <div class="chat-input">
                    <input type="text" id="chatInput" placeholder="پیام خود را بنویسید...">
                    <button id="sendMessage"><i class="fas fa-paper-plane"></i></button>
                </div>
            </div>
            
            <div class="support-info" style="margin-top: 30px;">
                <h3>راههای ارتباطی</h3>
                <p><i class="fas fa-phone"></i> شماره تماس: ۰۷۰۰۱۲۳۴۵۶</p>
                <p><i class="fas fa-envelope"></i> ایمیل: support@snapp.af</p>
                <p><i class="fas fa-clock"></i> ساعات پاسخگویی: ۲۴ ساعته</p>
            </div>
        </div>

        <!-- صفحه پروفایل -->
        <div class="page" id="profile-page">
            <h2 class="page-title"><i class="fas fa-user"></i> پروفایل</h2>
            
            <div class="profile-section">
                <div class="profile-header">
                    <div class="profile-avatar" id="profileAvatar">ا</div>
                    <div class="profile-info">
                        <h3 id="profileName">احمد محمدی</h3>
                        <p><i class="fas fa-envelope"></i> <span id="profileEmail">ahmad@example.com</span></p>
                        <p><i class="fas fa-phone"></i> <span id="profilePhone">۰۷۰۰۱۱۱۲۲۲</span></p>
                        <p><i class="fas fa-user-tag"></i> <span id="profileRole">مسافر</span></p>
                    </div>
                </div>
                
                <div class="profile-stats">
                    <div class="profile-stat">
                        <div class="value" id="totalTripsCount">۱۲</div>
                        <div class="label">تعداد سفرها</div>
                    </div>
                    <div class="profile-stat">
                        <div class="value" id="totalSpent">۱,۳۴۰</div>
                        <div class="label">افغانی هزینه شده</div>
                    </div>
                    <div class="profile-stat">
                        <div class="value" id="userRating">۴.۷</div>
                        <div class="label">امتیاز شما</div>
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="editName"><i class="fas fa-user"></i> نام کامل</label>
                    <input type="text" id="editName" class="form-input" value="احمد محمدی">
                </div>
                
                <div class="form-group">
                    <label for="editEmail"><i class="fas fa-envelope"></i> ایمیل</label>
                    <input type="email" id="editEmail" class="form-input" value="ahmad@example.com">
                </div>
                
                <div class="form-group">
                    <label for="editPhone"><i class="fas fa-phone"></i> شماره تماس</label>
                    <input type="tel" id="editPhone" class="form-input" value="0700111222">
                </div>
                
                <button class="btn btn-primary" id="saveProfile">
                    <i class="fas fa-save"></i>
                    ذخیره تغییرات
                </button>
            </div>
        </div>

        <!-- صفحه پنل مدیریت -->
        <div class="page admin-panel" id="admin-page">
            <h2 class="page-title"><i class="fas fa-cog"></i> پنل مدیریت</h2>
            
            <div class="admin-stats">
                <div class="stat-card">
                    <h3>تعداد سفرها</h3>
                    <div class="value" id="totalTrips">0</div>
                    <div class="change positive"><i class="fas fa-arrow-up"></i> ۱۲% نسبت به ماه گذشته</div>
                </div>
                <div class="stat-card">
                    <h3>کاربران فعال</h3>
                    <div class="value" id="activeUsers">0</div>
                    <div class="change positive"><i class="fas fa-arrow-up"></i> ۸% نسبت به ماه گذشته</div>
                </div>
                <div class="stat-card">
                    <h3>رانندگان</h3>
                    <div class="value" id="totalDrivers">0</div>
                    <div class="change positive"><i class="fas fa-arrow-up"></i> ۵% نسبت به ماه گذشته</div>
                </div>
                <div class="stat-card">
                    <h3>درآمد کل</h3>
                    <div class="value" id="totalRevenue">0 افغانی</div>
                    <div class="change positive"><i class="fas fa-arrow-up"></i> ۱۵% نسبت به ماه گذشته</div>
                </div>
            </div>
            
            <div class="admin-tabs">
                <div class="admin-tab active" data-tab="users">
                    <i class="fas fa-users"></i>
                    مدیریت کاربران
                </div>
                <div class="admin-tab" data-tab="drivers">
                    <i class="fas fa-car"></i>
                    مدیریت رانندگان
                </div>
                <div class="admin-tab" data-tab="trips">
                    <i class="fas fa-road"></i>
                    مدیریت سفرها
                </div>
                <div class="admin-tab" data-tab="discounts">
                    <i class="fas fa-tag"></i>
                    مدیریت تخفیفها
                </div>
                <div class="admin-tab" data-tab="support">
                    <i class="fas fa-headset"></i>
                    مدیریت پشتیبانی
                </div>
            </div>
            
            <div class="admin-tab-content active" id="users-tab">
                <div class="tab-header">
                    <h3>کاربران در انتظار تایید</h3>
                    <button class="btn btn-primary" id="refreshUsersBtn">
                        <i class="fas fa-sync-alt"></i>
                        بروزرسانی
                    </button>
                </div>
                <div class="table-container">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>نام</th>
                                <th>ایمیل</th>
                                <th>شماره تماس</th>
                                <th>نوع کاربر</th>
                                <th>تاریخ ثبتنام</th>
                                <th>عملیات</th>
                            </tr>
                        </thead>
                        <tbody id="pendingUsersTable">
                            <!-- کاربران در انتظار تایید -->
                        </tbody>
                    </table>
                </div>
                
                <div class="tab-header" style="margin-top: 40px;">
                    <h3>همه کاربران</h3>
                    <button class="btn btn-primary" id="exportUsersBtn">
                        <i class="fas fa-download"></i>
                        خروجی Excel
                    </button>
                </div>
                <div class="table-container">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>نام</th>
                                <th>ایمیل</th>
                                <th>شماره تماس</th>
                                <th>نوع کاربر</th>
                                <th>وضعیت</th>
                                <th>تاریخ ثبتنام</th>
                                <th>عملیات</th>
                            </tr>
                        </thead>
                        <tbody id="allUsersTable">
                            <!-- همه کاربران -->
                        </tbody>
                    </table>
                </div>
            </div>
            
            <div class="admin-tab-content" id="drivers-tab">
                <div class="tab-header">
                    <h3>مدیریت رانندگان</h3>
                    <div class="action-buttons">
                        <button class="btn btn-primary" id="addDriverBtn">
                            <i class="fas fa-user-plus"></i>
                            افزودن راننده جدید
                        </button>
                        <button class="btn btn-edit" id="refreshDriversBtn">
                            <i class="fas fa-sync-alt"></i>
                        </button>
                    </div>
                </div>
                <div class="table-container">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>نام</th>
                                <th>شماره تماس</th>
                                <th>نوع وسیله</th>
                                <th>مدل خودرو</th>
                                <th>پلاک</th>
                                <th>وضعیت</th>
                                <th>عملیات</th>
                            </tr>
                        </thead>
                        <tbody id="driversTable">
                            <!-- رانندگان -->
                        </tbody>
                    </table>
                </div>
            </div>
            
            <div class="admin-tab-content" id="trips-tab">
                <div class="tab-header">
                    <h3>مدیریت سفرها</h3>
                    <div class="action-buttons">
                        <button class="btn btn-primary" id="filterTripsBtn">
                            <i class="fas fa-filter"></i>
                            فیلتر
                        </button>
                        <button class="btn btn-edit" id="refreshTripsBtn">
                            <i class="fas fa-sync-alt"></i>
                        </button>
                    </div>
                </div>
                <div class="table-container">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>تاریخ</th>
                                <th>مسافر</th>
                                <th>مبدا</th>
                                <th>مقصد</th>
                                <th>هزینه</th>
                                <th>وضعیت</th>
                                <th>عملیات</th>
                            </tr>
                        </thead>
                        <tbody id="adminTripsTable">
                            <!-- سفرها -->
                        </tbody>
                    </table>
                </div>
            </div>
            
            <div class="admin-tab-content" id="discounts-tab">
                <div class="tab-header">
                    <h3>مدیریت تخفیفها</h3>
                    <div class="action-buttons">
                        <button class="btn btn-primary" id="addDiscountBtn">
                            <i class="fas fa-plus-circle"></i>
                            افزودن تخفیف جدید
                        </button>
                        <button class="btn btn-edit" id="refreshDiscountsBtn">
                            <i class="fas fa-sync-alt"></i>
                        </button>
                    </div>
                </div>
                <div class="table-container">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>کد تخفیف</th>
                                <th>درصد تخفیف</th>
                                <th>تاریخ انقضا</th>
                                <th>کاربران استفاده‌کننده</th>
                                <th>وضعیت</th>
                                <th>عملیات</th>
                            </tr>
                        </thead>
                        <tbody id="discountsTable">
                            <!-- تخفیفها -->
                        </tbody>
                    </table>
                </div>
            </div>
            
            <div class="admin-tab-content" id="support-tab">
                <div class="tab-header">
                    <h3>مدیریت درخواستهای پشتیبانی</h3>
                    <div class="action-buttons">
                        <button class="btn btn-primary" id="markAllReadBtn">
                            <i class="fas fa-check-double"></i>
                            علامت‌گذاری همه
                        </button>
                        <button class="btn btn-edit" id="refreshSupportBtn">
                            <i class="fas fa-sync-alt"></i>
                        </button>
                    </div>
                </div>
                <div class="table-container">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>کاربر</th>
                                <th>موضوع</th>
                                <th>پیام</th>
                                <th>تاریخ</th>
                                <th>وضعیت</th>
                                <th>عملیات</th>
                            </tr>
                        </thead>
                        <tbody id="adminSupportTable">
                            <!-- درخواستهای پشتیبانی -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- مدال راننده -->
    <div class="modal" id="driverModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title"><i class="fas fa-check-circle"></i> راننده پیدا شد!</h2>
                <button class="close-modal" id="closeModal">&times;</button>
            </div>
            
            <div class="driver-info">
                <div class="driver-details">
                    <div class="driver-avatar" id="driverAvatar">ا</div>
                    <div class="driver-name-rating">
                        <h3 id="driverName">احمد ظاهر</h3>
                        <div class="driver-rating">
                            <span class="stars">
                                <i class="fas fa-star"></i>
                                <i class="fas fa-star"></i>
                                <i class="fas fa-star"></i>
                                <i class="fas fa-star"></i>
                                <i class="fas fa-star-half-alt"></i>
                            </span>
                            <span id="driverRating">۴.۷</span>
                            <span id="driverTrips">(۱۲۵ سفر)</span>
                        </div>
                    </div>
                </div>
                
                <div class="car-details">
                    <div class="car-info">
                        <div class="car-model" id="carModel">تویوتا کورولا</div>
                        <div class="car-color" id="carColor">سفید</div>
                    </div>
                    <div class="car-plate" id="plateNumber">کابل ۱۲۳۴</div>
                </div>
            </div>
            
            <div class="trip-info">
                <div class="trip-detail">
                    <i class="fas fa-clock"></i>
                    <span>زمان رسیدن</span>
                    <div class="value" id="eta">۴ دقیقه</div>
                </div>
                <div class="trip-detail">
                    <i class="fas fa-road"></i>
                    <span>مسافت</span>
                    <div class="value" id="distance">۲.۸ کیلومتر</div>
                </div>
                <div class="trip-detail">
                    <i class="fas fa-money-bill-wave"></i>
                    <span>هزینه</span>
                    <div class="value" id="price">۱۵۰ افغانی</div>
                </div>
            </div>
            
            <div class="modal-actions">
                <button class="btn btn-outline" id="cancelRide">
                    <i class="fas fa-times"></i>
                    لغو سفر
                </button>
                <button class="btn btn-primary" id="confirmRide">
                    <i class="fas fa-check"></i>
                    تأیید سفر
                </button>
            </div>
        </div>
    </div>

    <!-- مدال امتیازدهی -->
    <div class="modal" id="ratingModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title"><i class="fas fa-star"></i> امتیازدهی به راننده</h2>
                <button class="close-modal" id="closeRatingModal">&times;</button>
            </div>
            
            <div style="text-align: center; padding: 20px 0;">
                <div class="driver-details" style="justify-content: center; margin-bottom: 25px;">
                    <div class="driver-avatar" id="ratingDriverAvatar">ا</div>
                    <div class="driver-name-rating">
                        <h3 id="ratingDriverName">احمد ظاهر</h3>
                    </div>
                </div>
                
                <p style="margin-bottom: 20px; font-size: 16px; color: var(--gray);">لطفاً به راننده امتیاز دهید</p>
                
                <div class="rating-stars" id="ratingStars">
                    <i class="fas fa-star rating-star" data-rating="1"></i>
                    <i class="fas fa-star rating-star" data-rating="2"></i>
                    <i class="fas fa-star rating-star" data-rating="3"></i>
                    <i class="fas fa-star rating-star" data-rating="4"></i>
                    <i class="fas fa-star rating-star" data-rating="5"></i>
                </div>
                
                <textarea id="ratingComment" placeholder="نظر خود را بنویسید (اختیاری)" style="width: 100%; padding: 15px; border: 1px solid var(--border); border-radius: 12px; margin-top: 20px; resize: vertical; min-height: 100px; font-family: inherit; font-size: 14px;"></textarea>
            </div>
            
            <div class="modal-actions">
                <button class="btn btn-primary" id="submitRating">
                    <i class="fas fa-paper-plane"></i>
                    ثبت امتیاز
                </button>
            </div>
        </div>
    </div>

    <!-- مدال پرداخت -->
    <div class="modal" id="paymentModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title"><i class="fas fa-credit-card"></i> پرداخت</h2>
                <button class="close-modal" id="closePaymentModal">&times;</button>
            </div>
            
            <div style="padding: 20px 0;">
                <div class="trip-info">
                    <div class="trip-detail">
                        <i class="fas fa-road"></i>
                        <span>مسافت</span>
                        <div class="value" id="paymentDistance">۲.۸ کیلومتر</div>
                    </div>
                    <div class="trip-detail">
                        <i class="fas fa-money-bill-wave"></i>
                        <span>هزینه</span>
                        <div class="value" id="paymentPrice">۱۵۰ افغانی</div>
                    </div>
                </div>
                
                <div class="form-group" style="margin-top: 25px;">
                    <label><i class="fas fa-credit-card"></i> روش پرداخت</label>
                    <div class="payment-methods">
                        <div class="payment-method selected" data-method="cash">
                            <i class="fas fa-money-bill-wave"></i>
                            <span>نقدی</span>
                        </div>
                        <div class="payment-method" data-method="wallet">
                            <i class="fas fa-wallet"></i>
                            <span>کیف پول</span>
                        </div>
                    </div>
                </div>
                
                <div id="walletPayment" style="display: none; margin-top: 20px;">
                    <div class="form-group">
                        <label>موجودی کیف پول:</label>
                        <div style="font-size: 24px; font-weight: 700; color: var(--primary); text-align: center; margin: 10px 0;">
                            <span id="walletBalance">۵۰۰</span> افغانی
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="modal-actions">
                <button class="btn btn-outline" id="cancelPayment">
                    <i class="fas fa-times"></i>
                    انصراف
                </button>
                <button class="btn btn-primary" id="confirmPayment">
                    <i class="fas fa-check"></i>
                    پرداخت
                </button>
            </div>
        </div>
    </div>

    <!-- مدال ورود/ثبتنام -->
    <div class="modal" id="authModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title"><i class="fas fa-user"></i> ورود / ثبتنام</h2>
                <button class="close-modal" id="closeAuthModal">&times;</button>
            </div>
            
            <div class="form-tabs">
                <div class="form-tab active" data-tab="login">ورود</div>
                <div class="form-tab" data-tab="register">ثبتنام</div>
            </div>
            
            <div class="form-tab-content active" id="login-tab">
                <form class="auth-form" id="loginForm">
                    <div class="form-group">
                        <label for="loginEmail">ایمیل یا شماره تماس</label>
                        <div class="input-with-icon">
                            <i class="fas fa-envelope input-icon"></i>
                            <input type="text" id="loginEmail" class="form-input" placeholder="ایمیل یا شماره تماس خود را وارد کنید" required>
                        </div>
                        <div class="error-message" id="loginEmailError"></div>
                    </div>
                    <div class="form-group">
                        <label for="loginPassword">رمز عبور</label>
                        <div class="input-with-icon">
                            <i class="fas fa-lock input-icon"></i>
                            <input type="password" id="loginPassword" class="form-input" placeholder="رمز عبور خود را وارد کنید" required>
                            <button type="button" class="password-toggle" id="loginPasswordToggle">
                                <i class="fas fa-eye"></i>
                            </button>
                        </div>
                        <div class="error-message" id="loginPasswordError"></div>
                    </div>
                    <div class="form-footer">
                        <a href="#" id="forgotPassword">رمز عبور خود را فراموش کردهاید؟</a>
                    </div>
                    <button type="submit" class="btn btn-primary" id="loginSubmitBtn">
                        <i class="fas fa-sign-in-alt"></i>
                        ورود
                    </button>
                </form>
            </div>
            
            <div class="form-tab-content" id="register-tab">
                <form class="auth-form" id="registerForm">
                    <div class="form-group">
                        <label for="registerName">نام کامل</label>
                        <div class="input-with-icon">
                            <i class="fas fa-user input-icon"></i>
                            <input type="text" id="registerName" class="form-input" placeholder="نام کامل خود را وارد کنید" required>
                        </div>
                        <div class="error-message" id="registerNameError"></div>
                    </div>
                    <div class="form-group">
                        <label for="registerEmail">ایمیل</label>
                        <div class="input-with-icon">
                            <i class="fas fa-envelope input-icon"></i>
                            <input type="email" id="registerEmail" class="form-input" placeholder="ایمیل خود را وارد کنید" required>
                        </div>
                        <div class="error-message" id="registerEmailError"></div>
                    </div>
                    <div class="form-group">
                        <label for="registerPhone">شماره تماس</label>
                        <div class="input-with-icon">
                            <i class="fas fa-phone input-icon"></i>
                            <input type="tel" id="registerPhone" class="form-input" placeholder="شماره تماس خود را وارد کنید" required>
                        </div>
                        <div class="error-message" id="registerPhoneError"></div>
                    </div>
                    <div class="form-group">
                        <label for="registerPassword">رمز عبور</label>
                        <div class="input-with-icon">
                            <i class="fas fa-lock input-icon"></i>
                            <input type="password" id="registerPassword" class="form-input" placeholder="رمز عبور خود را وارد کنید" required>
                            <button type="button" class="password-toggle" id="registerPasswordToggle">
                                <i class="fas fa-eye"></i>
                            </button>
                        </div>
                        <div class="error-message" id="registerPasswordError"></div>
                    </div>
                    <div class="form-group">
                        <label for="registerConfirmPassword">تکرار رمز عبور</label>
                        <div class="input-with-icon">
                            <i class="fas fa-lock input-icon"></i>
                            <input type="password" id="registerConfirmPassword" class="form-input" placeholder="رمز عبور خود را مجدداً وارد کنید" required>
                            <button type="button" class="password-toggle" id="registerConfirmPasswordToggle">
                                <i class="fas fa-eye"></i>
                            </button>
                        </div>
                        <div class="error-message" id="registerConfirmPasswordError"></div>
                    </div>
                    <div class="form-group">
                        <label for="userType">نوع کاربر</label>
                        <select id="userType" class="form-input" required style="padding: 15px 20px;">
                            <option value="">انتخاب کنید</option>
                            <option value="passenger">مسافر</option>
                            <option value="driver">راننده</option>
                        </select>
                        <div class="error-message" id="userTypeError"></div>
                    </div>
                    <div class="form-footer">
                        با ثبتنام، <a href="#">قوانین و مقررات</a> اسنپ افغانستان را میپذیرید.
                    </div>
                    <button type="submit" class="btn btn-primary" id="registerSubmitBtn">
                        <i class="fas fa-user-plus"></i>
                        ثبتنام
                    </button>
                </form>
            </div>
        </div>
    </div>

    <!-- مدال بازیابی رمز عبور -->
    <div class="modal" id="forgotPasswordModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title"><i class="fas fa-key"></i> بازیابی رمز عبور</h2>
                <button class="close-modal" id="closeForgotPasswordModal">&times;</button>
            </div>
            
            <form class="auth-form" id="forgotPasswordForm">
                <div class="form-group">
                    <label for="forgotPasswordEmail">ایمیل یا شماره تماس</label>
                    <div class="input-with-icon">
                        <i class="fas fa-envelope input-icon"></i>
                        <input type="text" id="forgotPasswordEmail" class="form-input" placeholder="ایمیل یا شماره تماس خود را وارد کنید" required>
                    </div>
                    <div class="error-message" id="forgotPasswordEmailError"></div>
                </div>
                <div class="form-footer">
                    لینک بازیابی رمز عبور به ایمیل یا شماره تماس شما ارسال خواهد شد.
                </div>
                <button type="submit" class="btn btn-primary" id="forgotPasswordSubmitBtn">
                    <i class="fas fa-paper-plane"></i>
                    ارسال لینک بازیابی
                </button>
            </form>
        </div>
    </div>

    <!-- مدال افزودن راننده -->
    <div class="modal" id="addDriverModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title"><i class="fas fa-user-plus"></i> افزودن راننده جدید</h2>
                <button class="close-modal" id="closeAddDriverModal">&times;</button>
            </div>
            
            <form class="auth-form" id="addDriverForm">
                <div class="form-group">
                    <label for="driverName">نام کامل</label>
                    <input type="text" id="driverName" class="form-input" placeholder="نام کامل راننده" required>
                </div>
                <div class="form-group">
                    <label for="driverEmail">ایمیل</label>
                    <input type="email" id="driverEmail" class="form-input" placeholder="ایمیل راننده" required>
                </div>
                <div class="form-group">
                    <label for="driverPhone">شماره تماس</label>
                    <input type="tel" id="driverPhone" class="form-input" placeholder="شماره تماس راننده" required>
                </div>
                <div class="form-group">
                    <label for="vehicleType">نوع وسیله</label>
                    <select id="vehicleType" class="form-input" required style="padding: 15px 20px;">
                        <option value="car">خودرو</option>
                        <option value="bike">موتور</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="carModel">مدل خودرو</label>
                    <input type="text" id="carModelInput" class="form-input" placeholder="مدل خودرو" required>
                </div>
                <div class="form-group">
                    <label for="carColor">رنگ خودرو</label>
                    <input type="text" id="carColorInput" class="form-input" placeholder="رنگ خودرو" required>
                </div>
                <div class="form-group">
                    <label for="plateNumber">شماره پلاک</label>
                    <input type="text" id="plateNumberInput" class="form-input" placeholder="شماره پلاک" required>
                </div>
                <button type="submit" class="btn btn-primary">
                    <i class="fas fa-plus-circle"></i>
                    افزودن راننده
                </button>
            </form>
        </div>
    </div>

    <!-- مدال افزودن تخفیف -->
    <div class="modal" id="addDiscountModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title"><i class="fas fa-tag"></i> افزودن تخفیف جدید</h2>
                <button class="close-modal" id="closeAddDiscountModal">&times;</button>
            </div>
            
            <form class="auth-form" id="addDiscountForm">
                <div class="form-group">
                    <label for="discountCode">کد تخفیف</label>
                    <input type="text" id="discountCode" class="form-input" placeholder="کد تخفیف" required>
                </div>
                <div class="form-group">
                    <label for="discountPercent">درصد تخفیف</label>
                    <input type="number" id="discountPercent" class="form-input" placeholder="درصد تخفیف" min="1" max="100" required>
                </div>
                <div class="form-group">
                    <label for="discountExpiry">تاریخ انقضا</label>
                    <input type="date" id="discountExpiry" class="form-input" required>
                </div>
                <div class="form-group">
                    <label for="maxUses">حداکثر استفاده</label>
                    <input type="number" id="maxUses" class="form-input" placeholder="حداکثر تعداد استفاده" min="1" required>
                </div>
                <button type="submit" class="btn btn-primary">
                    <i class="fas fa-plus-circle"></i>
                    افزودن تخفیف
                </button>
            </form>
        </div>
    </div>

    <!-- نوتیفیکیشن -->
    <div class="notification" id="notification"></div>

    <!-- فوتر -->
    <footer style="display: none;" id="main-footer">
        <div class="container">
            <div class="footer-content">
                <div class="footer-column">
                    <h3>اسنپ افغانستان</h3>
                    <ul class="footer-links">
                        <li><a href="#"><i class="fas fa-info-circle"></i> درباره ما</a></li>
                        <li><a href="#"><i class="fas fa-briefcase"></i> فرصتهای کاری</a></li>
                        <li><a href="#"><i class="fas fa-phone"></i> تماس با ما</a></li>
                        <li><a href="#"><i class="fas fa-blog"></i> وبلاگ</a></li>
                    </ul>
                </div>
                <div class="footer-column">
                    <h3>خدمات</h3>
                    <ul class="footer-links">
                        <li><a href="#"><i class="fas fa-taxi"></i> تاکسی</a></li>
                        <li><a href="#"><i class="fas fa-shipping-fast"></i> پیک</a></li>
                        <li><a href="#"><i class="fas fa-motorcycle"></i> موتور</a></li>
                        <li><a href="#"><i class="fas fa-shopping-cart"></i> بازار</a></li>
                    </ul>
                </div>
                <div class="footer-column">
                    <h3>مسافران</h3>
                    <ul class="footer-links">
                        <li><a href="#"><i class="fas fa-mobile-alt"></i> دانلود اپلیکیشن</a></li>
                        <li><a href="#"><i class="fas fa-gavel"></i> قوانین و مقررات</a></li>
                        <li><a href="#"><i class="fas fa-question-circle"></i> سوالات متداول</a></li>
                        <li><a href="#"><i class="fas fa-shield-alt"></i> حریم خصوصی</a></li>
                    </ul>
                </div>
                <div class="footer-column">
                    <h3>ارتباط با ما</h3>
                    <p><i class="fas fa-headset"></i> پشتیبانی ۲۴ ساعته</p>
                    <p><i class="fas fa-phone"></i> شماره: ۰۷۰۰۱۲۳۴۵۶</p>
                    <div class="social-links">
                        <a href="#"><i class="fab fa-whatsapp"></i></a>
                        <a href="#"><i class="fab fa-telegram"></i></a>
                        <a href="#"><i class="fab fa-facebook"></i></a>
                        <a href="#"><i class="fab fa-twitter"></i></a>
                    </div>
                </div>
            </div>
            <div class="footer-bottom">
                <p>© ۱۴۰۳ اسنپ افغانستان. تمامی حقوق محفوظ است.</p>
            </div>
        </div>
    </footer>

    <!-- Mapbox JS -->
    <script src='https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.js'></script>
    <script>
        // تنظیم توکن Mapbox
        const MAPBOX_TOKEN = 'eyJvcmciOiI1YjNjZTM1OTc4NTExMTAwMDFjZjYyNDgiLCJpZCI6IjgxNTkwYjU0NDBiYTQwOTg5NjcyMWFjYmUwNTM2OTE4IiwiaCI6Im11cm11cjY0In0=';
        
        // داده‌های اصلی سیستم
        const kabulData = {
            locations: [
                // مناطق مرکزی
                { name: "میدان هوایی", coordinates: [69.2120, 34.5658] },
                { name: "کارته سخی", coordinates: [69.1725, 34.5160] },
                { name: "کارته چهار", coordinates: [69.1768, 34.5265] },
                { name: "شهر نو", coordinates: [69.1680, 34.5320] },
                { name: "دشت برچی", coordinates: [69.1400, 34.4700] },
                { name: "قلعه نور", coordinates: [69.1900, 34.5500] },
                { name: "پغمان", coordinates: [69.1200, 34.5800] },
                { name: "خیرخانه", coordinates: [69.2100, 34.5300] },
                { name: "قلعه فتح الله", coordinates: [69.1800, 34.5000] },
                { name: "مکروریان", coordinates: [69.2000, 34.4900] },
                
                // سفارتخانه‌ها
                { name: "سفارت امریکا", coordinates: [69.1833, 34.5350] },
                { name: "سفارت ایران", coordinates: [69.1850, 34.5250] },
                { name: "سفارت پاکستان", coordinates: [69.1870, 34.5200] },
                { name: "سفارت ترکیه", coordinates: [69.1900, 34.5300] },
                
                // وزارتخانه‌ها
                { name: "ارگ ریاست جمهوری", coordinates: [69.1800, 34.5250] },
                { name: "وزارت امور خارجه", coordinates: [69.1820, 34.5270] },
                { name: "وزارت داخله", coordinates: [69.1840, 34.5290] },
                { name: "وزارت دفاع", coordinates: [69.1860, 69.1860] },
                
                // مراکز خرید
                { name: "بازار کابل", coordinates: [69.1700, 34.5150] },
                { name: "بازار کارته سخی", coordinates: [69.1725, 34.5160] },
                { name: "بازار شورا", coordinates: [69.1650, 34.5200] },
                
                // دانشگاه‌ها
                { name: "پوهنتون کابل", coordinates: [69.1600, 34.5400] },
                { name: "پوهنتون پولی تخنیک کابل", coordinates: [69.1550, 34.5350] },
                { name: "پوهنتون ابن سینا", coordinates: [69.1500, 34.5450] },
                
                // شفاخانه‌ها
                { name: "شفاخانه علی آباد", coordinates: [69.1750, 34.5150] },
                { name: "شفاخانه جمهوریت", coordinates: [69.1800, 34.5200] },
                { name: "شفاخانه ایندیانا", coordinates: [69.1850, 34.5250] }
            ],
            
            districts: [
                "کارته سخی", "کارته چهار", "شهر نو", "دشت برچی", "قلعه نور",
                "قلعه فتح الله", "پغمان", "مکروریان", "خیرخانه", "قلعه ذوالفقار",
                "چندول", "ده سبز", "افشار", "قره باغ", "بگرامی", "نادر پشته",
                "کارته پروان", "کارته منصور", "کارته خوشحال", "کارته سید"
            ]
        };

        // متغیرهای سیستم
        let currentUser = null;
        let isAdmin = false;
        let selectedRideType = 'economy';
        let selectedPaymentMethod = 'cash';
        let currentDistance = 0;
        let currentPrice = 0;
        let currentTripId = null;
        let currentDriver = null;
        let map = null;
        let markers = [];
        let routeLayer = null;
        let carMarker = null;
        let carAnimationInterval = null;
        let trackingInterval = null;
        let currentRoute = null;

        // ذخیره‌سازی داده‌ها
        const storage = {
            get: (key) => JSON.parse(localStorage.getItem(key) || '[]'),
            set: (key, data) => localStorage.setItem(key, JSON.stringify(data)),
            remove: (key) => localStorage.removeItem(key)
        };

        // کلاس User برای مدیریت کاربران
        class User {
            constructor(data) {
                this.id = data.id;
                this.name = data.name;
                this.email = data.email;
                this.phone = data.phone;
                this.password = data.password;
                this.role = data.role;
                this.status = data.status || 'pending';
                this.created_at = data.created_at || new Date().toISOString();
                this.wallet_balance = data.wallet_balance || 0;
                this.rating = data.rating || 0;
                
                // برای رانندگان
                if (data.role === 'driver') {
                    this.vehicle_type = data.vehicle_type || 'car';
                    this.car_model = data.car_model;
                    this.car_color = data.car_color;
                    this.plate_number = data.plate_number;
                    this.driver_license = data.driver_license;
                    this.driver_status = data.driver_status || 'active';
                    this.rating = data.rating || 4.5;
                    this.total_trips = data.total_trips || 0;
                    this.current_location = data.current_location || [69.1800, 34.5250];
                }
            }

            save() {
                let users = storage.get('snapp_users');
                const index = users.findIndex(u => u.id === this.id);
                if (index !== -1) {
                    users[index] = this;
                } else {
                    users.push(this);
                }
                storage.set('snapp_users', users);
            }

            static findById(id) {
                const users = storage.get('snapp_users');
                const userData = users.find(u => u.id === id);
                return userData ? new User(userData) : null;
            }

            static findByCredentials(email, password) {
                const users = storage.get('snapp_users');
                const userData = users.find(u => 
                    (u.email === email || u.phone === email) && 
                    u.password === password
                );
                return userData ? new User(userData) : null;
            }

            static getAll() {
                return storage.get('snapp_users').map(data => new User(data));
            }

            static delete(id) {
                let users = storage.get('snapp_users');
                users = users.filter(u => u.id !== id);
                storage.set('snapp_users', users);
            }
        }

        // کلاس Trip برای مدیریت سفرها
        class Trip {
            constructor(data) {
                this.id = data.id || Date.now();
                this.pickup = data.pickup;
                this.destination = data.destination;
                this.pickup_coords = data.pickup_coords;
                this.destination_coords = data.destination_coords;
                this.ride_type = data.ride_type;
                this.distance = data.distance;
                this.price = data.price;
                this.status = data.status || 'requested';
                this.user_id = data.user_id;
                this.user_name = data.user_name;
                this.driver_id = data.driver_id;
                this.driver_name = data.driver_name;
                this.payment_method = data.payment_method || 'cash';
                this.rated = data.rated || false;
                this.rating = data.rating || 0;
                this.rating_comment = data.rating_comment || '';
                this.created_at = data.created_at || new Date().toISOString();
                this.started_at = data.started_at;
                this.completed_at = data.completed_at;
                this.route = data.route;
            }

            save() {
                let trips = storage.get('snapp_trips');
                const index = trips.findIndex(t => t.id === this.id);
                if (index !== -1) {
                    trips[index] = this;
                } else {
                    trips.push(this);
                }
                storage.set('snapp_trips', trips);
            }

            static findById(id) {
                const trips = storage.get('snapp_trips');
                const tripData = trips.find(t => t.id === id);
                return tripData ? new Trip(tripData) : null;
            }

            static findByUserId(userId) {
                const trips = storage.get('snapp_trips');
                return trips
                    .filter(t => t.user_id === userId)
                    .map(data => new Trip(data))
                    .sort((a, b) => new Date(b.created_at) - new Date(a.created_at));
            }

            static getAll() {
                return storage.get('snapp_trips').map(data => new Trip(data));
            }

            static delete(id) {
                let trips = storage.get('snapp_trips');
                trips = trips.filter(t => t.id !== id);
                storage.set('snapp_trips', trips);
            }
        }

        // کلاس Discount برای مدیریت تخفیف‌ها
        class Discount {
            constructor(data) {
                this.id = data.id || Date.now();
                this.code = data.code;
                this.percent = data.percent;
                this.expiry_date = data.expiry_date;
                this.max_uses = data.max_uses;
                this.used_count = data.used_count || 0;
                this.created_at = data.created_at || new Date().toISOString();
            }

            save() {
                let discounts = storage.get('snapp_discounts');
                const index = discounts.findIndex(d => d.id === this.id);
                if (index !== -1) {
                    discounts[index] = this;
                } else {
                    discounts.push(this);
                }
                storage.set('snapp_discounts', discounts);
            }

            static findValid() {
                const discounts = storage.get('snapp_discounts');
                const now = new Date();
                return discounts
                    .filter(d => new Date(d.expiry_date) > now)
                    .map(data => new Discount(data));
            }

            static getAll() {
                return storage.get('snapp_discounts').map(data => new Discount(data));
            }

            static delete(id) {
                let discounts = storage.get('snapp_discounts');
                discounts = discounts.filter(d => d.id !== id);
                storage.set('snapp_discounts', discounts);
            }
        }

        // کلاس SupportTicket برای مدیریت درخواست‌های پشتیبانی
        class SupportTicket {
            constructor(data) {
                this.id = data.id || Date.now();
                this.user_id = data.user_id;
                this.user_name = data.user_name;
                this.subject = data.subject;
                this.message = data.message;
                this.status = data.status || 'pending';
                this.reply = data.reply || '';
                this.created_at = data.created_at || new Date().toISOString();
                this.replied_at = data.replied_at;
            }

            save() {
                let tickets = storage.get('snapp_support');
                const index = tickets.findIndex(t => t.id === this.id);
                if (index !== -1) {
                    tickets[index] = this;
                } else {
                    tickets.push(this);
                }
                storage.set('snapp_support', tickets);
            }

            static getAll() {
                return storage.get('snapp_support').map(data => new SupportTicket(data));
            }

            static findByUserId(userId) {
                const tickets = storage.get('snapp_support');
                return tickets
                    .filter(t => t.user_id === userId)
                    .map(data => new SupportTicket(data))
                    .sort((a, b) => new Date(b.created_at) - new Date(a.created_at));
            }
        }

        // توابع کمکی
        function showNotification(message, type = 'success') {
            const notification = document.getElementById('notification');
            notification.textContent = message;
            notification.className = `notification ${type}`;
            notification.style.display = 'block';
            
            setTimeout(() => {
                notification.style.display = 'none';
            }, 5000);
        }

        function clearErrors() {
            document.querySelectorAll('.error-message').forEach(el => {
                el.style.display = 'none';
            });
            document.querySelectorAll('.form-input').forEach(el => {
                el.style.borderColor = 'var(--border)';
            });
        }

        function showError(inputId, message) {
            const errorElement = document.getElementById(inputId + 'Error');
            const inputElement = document.getElementById(inputId);
            
            if (errorElement && inputElement) {
                errorElement.textContent = message;
                errorElement.style.display = 'block';
                inputElement.style.borderColor = 'var(--accent)';
            }
        }

        // مدیریت نقشه
        function initMap() {
            if (!mapboxgl) {
                console.error('Mapbox GL JS failed to load');
                return;
            }

            mapboxgl.accessToken = MAPBOX_TOKEN;
            
            try {
                map = new mapboxgl.Map({
                    container: 'map',
                    style: 'mapbox://styles/mapbox/streets-v11',
                    center: [69.1800, 34.5250], // مرکز کابل
                    zoom: 12,
                    language: 'fa'
                });

                map.addControl(new mapboxgl.NavigationControl());
                map.addControl(new mapboxgl.GeolocateControl({
                    positionOptions: {
                        enableHighAccuracy: true
                    },
                    trackUserLocation: true
                }));

                // اضافه کردن نشانگرهای نقاط مهم
                addLocationMarkers();
                
                // اضافه کردن مناطق
                createDistrictsList();

            } catch (error) {
                console.error('Error initializing map:', error);
                showNotification('خطا در بارگذاری نقشه. لطفاً اینترنت خود را بررسی کنید.', 'error');
            }
        }

        function addLocationMarkers() {
            if (!map) return;

            // حذف نشانگرهای قبلی
            markers.forEach(marker => marker.remove());
            markers = [];

            kabulData.locations.forEach(location => {
                const el = document.createElement('div');
                el.className = 'location-marker';
                el.innerHTML = '<i class="fas fa-map-marker-alt"></i>';
                el.style.color = '#00D474';
                el.style.fontSize = '20px';
                el.style.cursor = 'pointer';

                const marker = new mapboxgl.Marker(el)
                    .setLngLat(location.coordinates)
                    .setPopup(new mapboxgl.Popup({ offset: 25 })
                        .setHTML(`<h3>${location.name}</h3>`))
                    .addTo(map);

                el.addEventListener('click', () => {
                    handleLocationClick(location.name);
                });

                markers.push(marker);
            });
        }

        function handleLocationClick(locationName) {
            const pickupInput = document.getElementById('pickup');
            const destinationInput = document.getElementById('destination');
            
            if (!pickupInput || !destinationInput) return;
            
            if (!pickupInput.value) {
                pickupInput.value = locationName;
                showNotification(`مبدا به "${locationName}" تنظیم شد`, 'info');
            } else if (!destinationInput.value) {
                destinationInput.value = locationName;
                showNotification(`مقصد به "${locationName}" تنظیم شد`, 'info');
            } else {
                if (confirm(`آیا می‌خواهید "${locationName}" را به عنوان مقصد انتخاب کنید؟`)) {
                    destinationInput.value = locationName;
                    showNotification(`مقصد به "${locationName}" تنظیم شد`, 'info');
                }
            }
            calculateDistanceAndPrice();
        }

        function createDistrictsList() {
            const districtsGrid = document.getElementById('districtsGrid');
            if (!districtsGrid) return;
            
            districtsGrid.innerHTML = '';
            
            kabulData.districts.forEach(district => {
                const districtItem = document.createElement('div');
                districtItem.className = 'district-item';
                districtItem.textContent = district;
                
                districtItem.addEventListener('click', () => {
                    const pickupInput = document.getElementById('pickup');
                    const destinationInput = document.getElementById('destination');
                    
                    if (!pickupInput || !destinationInput) return;
                    
                    if (!pickupInput.value) {
                        pickupInput.value = district;
                        showNotification(`مبدا به "${district}" تنظیم شد`, 'info');
                    } else if (!destinationInput.value) {
                        destinationInput.value = district;
                        showNotification(`مقصد به "${district}" تنظیم شد`, 'info');
                    } else {
                        if (confirm(`آیا می‌خواهید "${district}" را به عنوان مقصد انتخاب کنید؟`)) {
                            destinationInput.value = district;
                            showNotification(`مقصد به "${district}" تنظیم شد`, 'info');
                        }
                    }
                    calculateDistanceAndPrice();
                });
                
                districtsGrid.appendChild(districtItem);
            });
        }

        // محاسبه مسافت و قیمت
        function calculateDistanceAndPrice() {
            const pickupInput = document.getElementById('pickup');
            const destinationInput = document.getElementById('destination');
            const tripCalculator = document.getElementById('tripCalculator');
            
            if (!pickupInput || !destinationInput || !tripCalculator) return;
            
            const pickup = pickupInput.value.trim();
            const destination = destinationInput.value.trim();

            if (!pickup || !destination) {
                tripCalculator.classList.remove('active');
                return;
            }

            // شبیه‌سازی محاسبه مسافت
            const randomDistance = (Math.random() * 15 + 2).toFixed(1);
            currentDistance = parseFloat(randomDistance);

            // نمایش معلومات مسافت
            const distanceValue = document.getElementById('distanceValue');
            if (distanceValue) distanceValue.textContent = `${currentDistance} کیلومتر`;
            
            tripCalculator.classList.add('active');
            updatePrice();
        }

        function updatePrice() {
            if (currentDistance === 0) return;

            const selectedRide = document.querySelector('.ride-type.selected');
            if (!selectedRide) return;
            
            const baseFare = parseInt(selectedRide.dataset.baseFare);
            const distanceFare = Math.round(currentDistance * 5);
            const totalFare = baseFare + distanceFare;

            currentPrice = totalFare;

            // نمایش جزئیات قیمت
            const baseFareValue = document.getElementById('baseFareValue');
            const distanceFareValue = document.getElementById('distanceFareValue');
            const totalFareValue = document.getElementById('totalFareValue');
            
            if (baseFareValue) baseFareValue.textContent = `${baseFare} افغانی`;
            if (distanceFareValue) distanceFareValue.textContent = `${distanceFare} افغانی`;
            if (totalFareValue) totalFareValue.textContent = `${totalFare} افغانی`;

            // به‌روزرسانی قیمت در کارت‌ها
            const economyPrice = document.getElementById('economyPrice');
            const comfortPrice = document.getElementById('comfortPrice');
            const bikePrice = document.getElementById('bikePrice');
            
            if (economyPrice) economyPrice.textContent = `${calculateRidePrice('economy')} افغانی`;
            if (comfortPrice) comfortPrice.textContent = `${calculateRidePrice('comfort')} افغانی`;
            if (bikePrice) bikePrice.textContent = `${calculateRidePrice('bike')} افغانی`;
        }

        function calculateRidePrice(type) {
            const baseFares = {
                economy: 50,
                comfort: 80,
                bike: 30
            };
            return baseFares[type] + Math.round(currentDistance * 5);
        }

        // مدیریت رانندگان
        function findNearestDriver(pickupLocation, rideType) {
            const drivers = User.getAll()
                .filter(user => 
                    user.role === 'driver' && 
                    user.status === 'approved' && 
                    user.driver_status === 'active' &&
                    (rideType === 'bike' ? user.vehicle_type === 'bike' : user.vehicle_type === 'car')
                );

            if (drivers.length === 0) {
                return null;
            }

            // انتخاب راننده تصادفی
            const randomIndex = Math.floor(Math.random() * drivers.length);
            const driver = drivers[randomIndex];
            
            // محاسبه ETA
            const eta = Math.floor(Math.random() * 10) + 3; // 3-12 دقیقه
            const distance = (Math.random() * 5 + 1).toFixed(1); // 1-6 کیلومتر

            return {
                ...driver,
                eta: `${eta} دقیقه`,
                distance: `${distance} کیلومتر`,
                position: driver.current_location
            };
        }

        // رسم مسیر روی نقشه
        function drawRoute(startCoords, endCoords) {
            clearRoute();
            
            if (!map || !startCoords || !endCoords) return;

            // خط مستقیم برای سادگی
            const route = {
                type: 'Feature',
                properties: {},
                geometry: {
                    type: 'LineString',
                    coordinates: [startCoords, endCoords]
                }
            };

            if (routeLayer) {
                map.removeLayer('route');
                map.removeSource('route');
            }

            map.addSource('route', {
                type: 'geojson',
                data: route
            });

            map.addLayer({
                id: 'route',
                type: 'line',
                source: 'route',
                layout: {
                    'line-join': 'round',
                    'line-cap': 'round'
                },
                paint: {
                    'line-color': '#00D474',
                    'line-width': 4,
                    'line-opacity': 0.8
                }
            });

            routeLayer = 'route';
        }

        function clearRoute() {
            if (!map || !routeLayer) return;
            
            if (map.getLayer(routeLayer)) {
                map.removeLayer(routeLayer);
            }
            if (map.getSource(routeLayer)) {
                map.removeSource(routeLayer);
            }
            routeLayer = null;
        }

        // شبیه‌سازی حرکت خودرو
        function simulateCarMovement(startCoords, endCoords, isBike = false) {
            if (!map || !startCoords || !endCoords) return;
            
            if (carMarker) {
                carMarker.remove();
            }
            
            // ایجاد نشانگر خودرو
            const el = document.createElement('div');
            el.className = isBike ? 'bike-marker' : 'car-marker';
            el.innerHTML = isBike ? '🏍️' : '🚗';
            el.style.fontSize = '24px';
            el.style.filter = 'drop-shadow(0 2px 4px rgba(0,0,0,0.2))';
            
            carMarker = new mapboxgl.Marker(el)
                .setLngLat(startCoords)
                .addTo(map);

            // شبیه‌سازی حرکت
            const steps = 50;
            const latStep = (endCoords[0] - startCoords[0]) / steps;
            const lngStep = (endCoords[1] - startCoords[1]) / steps;
            
            let currentStep = 0;
            
            if (carAnimationInterval) {
                clearInterval(carAnimationInterval);
            }
            
            carAnimationInterval = setInterval(() => {
                if (currentStep >= steps) {
                    clearInterval(carAnimationInterval);
                    showNotification('شما به مقصد رسیدید!', 'success');
                    const liveTracking = document.getElementById('liveTracking');
                    if (liveTracking) liveTracking.style.display = 'none';
                    openRatingModal();
                    return;
                }
                
                const newLng = startCoords[0] + (latStep * currentStep);
                const newLat = startCoords[1] + (lngStep * currentStep);
                
                carMarker.setLngLat([newLng, newLat]);
                currentStep++;
                updateTrackingInfo(currentStep, steps);
            }, 200);
        }

        function updateTrackingInfo(currentStep, totalSteps) {
            const progress = (currentStep / totalSteps) * 100;
            const remainingTime = Math.round((totalSteps - currentStep) * 0.2);
            const remainingDistance = (currentDistance * (1 - progress/100)).toFixed(1);
            
            const trackingETA = document.getElementById('trackingETA');
            const trackingDistance = document.getElementById('trackingDistance');
            const trackingProgress = document.getElementById('trackingProgress');
            
            if (trackingETA) trackingETA.textContent = `${remainingTime} دقیقه`;
            if (trackingDistance) trackingDistance.textContent = `${remainingDistance} کیلومتر`;
            if (trackingProgress) trackingProgress.style.width = `${progress}%`;
        }

        // مدیریت کاربران
        function checkUserLoginStatus() {
            const savedUser = localStorage.getItem('snapp_current_user');
            if (savedUser) {
                try {
                    const userData = JSON.parse(savedUser);
                    if (userData && userData.id && userData.name) {
                        currentUser = new User(userData);
                        isAdmin = currentUser.role === 'admin';
                        updateUIAfterLogin();
                    }
                } catch (error) {
                    localStorage.removeItem('snapp_current_user');
                }
            }
            initializeSampleData();
        }

        function updateUIAfterLogin() {
            const loginBtn = document.getElementById('loginBtn');
            const logoutBtn = document.getElementById('logoutBtn');
            const mobileLoginBtn = document.getElementById('mobileLoginBtn');
            const mobileLogoutBtn = document.getElementById('mobileLogoutBtn');
            const userProfile = document.getElementById('userProfile');
            const userAvatar = document.getElementById('userAvatar');
            const userName = document.getElementById('userName');
            
            if (loginBtn) loginBtn.style.display = 'none';
            if (logoutBtn) logoutBtn.style.display = 'block';
            if (mobileLoginBtn) mobileLoginBtn.style.display = 'none';
            if (mobileLogoutBtn) mobileLogoutBtn.style.display = 'block';
            if (userProfile) userProfile.style.display = 'flex';
            
            if (userAvatar && currentUser) {
                userAvatar.textContent = currentUser.name.charAt(0);
            }
            if (userName && currentUser) {
                userName.textContent = currentUser.name;
            }
            
            if (isAdmin) {
                const adminLink = document.getElementById('adminLink');
                const mobileAdminLink = document.getElementById('mobileAdminLink');
                if (adminLink) adminLink.style.display = 'block';
                if (mobileAdminLink) mobileAdminLink.style.display = 'block';
            }
            
            updateProfilePage();
        }

        function updateUIAfterLogout() {
            const loginBtn = document.getElementById('loginBtn');
            const logoutBtn = document.getElementById('logoutBtn');
            const mobileLoginBtn = document.getElementById('mobileLoginBtn');
            const mobileLogoutBtn = document.getElementById('mobileLogoutBtn');
            const userProfile = document.getElementById('userProfile');
            
            if (loginBtn) loginBtn.style.display = 'block';
            if (logoutBtn) logoutBtn.style.display = 'none';
            if (mobileLoginBtn) mobileLoginBtn.style.display = 'block';
            if (mobileLogoutBtn) mobileLogoutBtn.style.display = 'none';
            if (userProfile) userProfile.style.display = 'none';
            
            const adminLink = document.getElementById('adminLink');
            const mobileAdminLink = document.getElementById('mobileAdminLink');
            if (adminLink) adminLink.style.display = 'none';
            if (mobileAdminLink) mobileAdminLink.style.display = 'none';
            
            document.querySelectorAll('.page').forEach(page => page.classList.remove('active'));
            const homePage = document.getElementById('home-page');
            if (homePage) homePage.classList.add('active');
        }

        function logout() {
            currentUser = null;
            isAdmin = false;
            localStorage.removeItem('snapp_current_user');
            showNotification('با موفقیت خارج شدید', 'success');
            updateUIAfterLogout();
        }

        // بارگذاری داده‌های نمونه
        function initializeSampleData() {
            let users = storage.get('snapp_users');
            
            if (users.length === 0) {
                const sampleUsers = [
                    {
                        id: 1,
                        name: 'مدیر سیستم',
                        email: 'admin@snapp.af',
                        phone: '0700123456',
                        password: 'admin123',
                        role: 'admin',
                        status: 'approved',
                        created_at: new Date().toISOString()
                    },
                    {
                        id: 2,
                        name: 'احمد محمدی',
                        email: 'ahmad@example.com',
                        phone: '0700111222',
                        password: '123456',
                        role: 'passenger',
                        status: 'approved',
                        wallet_balance: 500,
                        created_at: new Date().toISOString()
                    },
                    {
                        id: 3,
                        name: 'رحمان علی',
                        email: 'rahman@example.com',
                        phone: '0700555666',
                        password: '123456',
                        role: 'driver',
                        status: 'approved',
                        vehicle_type: 'car',
                        car_model: 'تویوتا کورولا',
                        car_color: 'سفید',
                        plate_number: 'کابل ۱۲۳۴',
                        driver_status: 'active',
                        rating: 4.7,
                        total_trips: 125,
                        current_location: [69.1800, 34.5250],
                        created_at: new Date().toISOString()
                    },
                    {
                        id: 4,
                        name: 'کریم احمدی',
                        email: 'karim@example.com',
                        phone: '0700777888',
                        password: '123456',
                        role: 'driver',
                        status: 'approved',
                        vehicle_type: 'bike',
                        car_model: 'هوندا 125',
                        car_color: 'قرمز',
                        plate_number: 'کابل ۵۶۷۸',
                        driver_status: 'active',
                        rating: 4.5,
                        total_trips: 80,
                        current_location: [69.1900, 34.5300],
                        created_at: new Date().toISOString()
                    }
                ];
                
                sampleUsers.forEach(user => {
                    const userObj = new User(user);
                    userObj.save();
                });
            }
            
            let trips = storage.get('snapp_trips');
            
            if (trips.length === 0) {
                const sampleTrips = [
                    {
                        id: 1,
                        pickup: 'کارته سخی',
                        destination: 'میدان هوایی',
                        pickup_coords: [69.1725, 34.5160],
                        destination_coords: [69.2120, 34.5658],
                        ride_type: 'economy',
                        distance: 12.5,
                        price: 112,
                        status: 'completed',
                        user_id: 2,
                        user_name: 'احمد محمدی',
                        driver_id: 3,
                        driver_name: 'رحمان علی',
                        rated: true,
                        rating: 5,
                        created_at: new Date(Date.now() - 86400000).toISOString()
                    },
                    {
                        id: 2,
                        pickup: 'شهر نو',
                        destination: 'سفارت امریکا',
                        pickup_coords: [69.1680, 34.5320],
                        destination_coords: [69.1833, 34.5350],
                        ride_type: 'comfort',
                        distance: 3.2,
                        price: 95,
                        status: 'completed',
                        user_id: 2,
                        user_name: 'احمد محمدی',
                        driver_id: 3,
                        driver_name: 'رحمان علی',
                        rated: true,
                        rating: 4,
                        created_at: new Date(Date.now() - 172800000).toISOString()
                    }
                ];
                
                sampleTrips.forEach(trip => {
                    const tripObj = new Trip(trip);
                    tripObj.save();
                });
            }
            
            let discounts = storage.get('snapp_discounts');
            
            if (discounts.length === 0) {
                const futureDate = new Date();
                futureDate.setDate(futureDate.getDate() + 30);
                
                const sampleDiscounts = [
                    {
                        id: 1,
                        code: 'SNAPP20',
                        percent: 20,
                        expiry_date: futureDate.toISOString(),
                        max_uses: 100,
                        used_count: 15
                    },
                    {
                        id: 2,
                        code: 'WELCOME100',
                        percent: 100,
                        expiry_date: futureDate.toISOString(),
                        max_uses: 1,
                        used_count: 0
                    }
                ];
                
                sampleDiscounts.forEach(discount => {
                    const discountObj = new Discount(discount);
                    discountObj.save();
                });
            }
        }

        // بارگذاری صفحات
        function loadMyTrips() {
            const myTripsTable = document.getElementById('myTripsTable');
            if (!myTripsTable || !currentUser) return;
            
            myTripsTable.innerHTML = '';
            const trips = Trip.findByUserId(currentUser.id);
            
            if (trips.length === 0) {
                myTripsTable.innerHTML = `
                    <tr>
                        <td colspan="8" style="text-align: center; padding: 40px;">
                            <i class="fas fa-road" style="font-size: 48px; color: var(--gray); margin-bottom: 15px; display: block;"></i>
                            <p style="color: var(--gray);">هیچ سفری یافت نشد</p>
                        </td>
                    </tr>
                `;
                return;
            }
            
            trips.forEach(trip => {
                const row = document.createElement('tr');
                const date = new Date(trip.created_at).toLocaleDateString('fa-IR');
                const statusClass = `status-${trip.status}`;
                const statusText = {
                    'requested': 'درخواست شده',
                    'confirmed': 'تأیید شده',
                    'completed': 'تکمیل شده',
                    'cancelled': 'لغو شده'
                }[trip.status] || trip.status;
                
                const rideTypeText = {
                    'economy': 'اقتصادی',
                    'comfort': 'کلاسیک',
                    'bike': 'موتور'
                }[trip.ride_type] || trip.ride_type;
                
                row.innerHTML = `
                    <td>${date}</td>
                    <td>${trip.pickup}</td>
                    <td>${trip.destination}</td>
                    <td>${rideTypeText}</td>
                    <td>${trip.distance} کیلومتر</td>
                    <td>${trip.price} افغانی</td>
                    <td><span class="status-badge ${statusClass}">${statusText}</span></td>
                    <td class="action-buttons">
                        ${trip.status === 'requested' || trip.status === 'confirmed' ? 
                          `<button class="action-btn btn-reject cancel-trip-btn" data-id="${trip.id}">لغو سفر</button>` : ''}
                        ${trip.status === 'completed' && !trip.rated ? 
                          `<button class="action-btn btn-approve rate-trip-btn" data-id="${trip.id}">امتیازدهی</button>` : ''}
                    </td>
                `;
                
                myTripsTable.appendChild(row);
            });
            
            // اضافه کردن event listeners برای دکمه‌ها
            document.querySelectorAll('.cancel-trip-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const tripId = this.getAttribute('data-id');
                    cancelTrip(tripId);
                });
            });
            
            document.querySelectorAll('.rate-trip-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const tripId = this.getAttribute('data-id');
                    openRatingModal(tripId);
                });
            });
        }

        function cancelTrip(tripId) {
            if (confirm('آیا از لغو این سفر مطمئن هستید؟')) {
                const trip = Trip.findById(tripId);
                if (trip) {
                    trip.status = 'cancelled';
                    trip.save();
                    showNotification('سفر با موفقیت لغو شد', 'success');
                    loadMyTrips();
                }
            }
        }

        function loadDiscounts() {
            const discountsList = document.getElementById('discountsList');
            if (!discountsList) return;
            
            discountsList.innerHTML = '';
            const discounts = Discount.findValid();
            
            if (discounts.length === 0) {
                discountsList.innerHTML = `
                    <div style="text-align: center; padding: 40px;">
                        <i class="fas fa-tag" style="font-size: 48px; color: var(--gray); margin-bottom: 15px; display: block;"></i>
                        <p style="color: var(--gray);">هیچ تخفیف فعالی موجود نیست</p>
                    </div>
                `;
                return;
            }
            
            discounts.forEach(discount => {
                const discountElement = document.createElement('div');
                discountElement.className = 'discount-card';
                
                const expiryDate = new Date(discount.expiry_date).toLocaleDateString('fa-IR');
                const progress = (discount.used_count / discount.max_uses) * 100;
                
                discountElement.innerHTML = `
                    <div class="discount-header">
                        <div class="discount-code">${discount.code}</div>
                        <div class="discount-percent">${discount.percent}% تخفیف</div>
                    </div>
                    <div class="discount-details">
                        <div>منقضی: ${expiryDate}</div>
                        <div>استفاده شده: ${discount.used_count} از ${discount.max_uses}</div>
                    </div>
                    <div class="discount-progress">
                        <div class="progress-text">
                            <span>۰</span>
                            <span>${discount.max_uses}</span>
                        </div>
                        <div class="progress-bar">
                            <div class="progress-fill" style="width: ${progress}%"></div>
                        </div>
                    </div>
                `;
                
                discountsList.appendChild(discountElement);
            });
        }

        function updateProfilePage() {
            if (!currentUser) return;
            
            const profileAvatar = document.getElementById('profileAvatar');
            const profileName = document.getElementById('profileName');
            const profileEmail = document.getElementById('profileEmail');
            const profilePhone = document.getElementById('profilePhone');
            const profileRole = document.getElementById('profileRole');
            const editName = document.getElementById('editName');
            const editEmail = document.getElementById('editEmail');
            const editPhone = document.getElementById('editPhone');
            
            if (profileAvatar) profileAvatar.textContent = currentUser.name.charAt(0);
            if (profileName) profileName.textContent = currentUser.name;
            if (profileEmail) profileEmail.textContent = currentUser.email;
            if (profilePhone) profilePhone.textContent = currentUser.phone;
            if (profileRole) profileRole.textContent = currentUser.role === 'passenger' ? 'مسافر' : 'راننده';
            
            if (editName) editName.value = currentUser.name;
            if (editEmail) editEmail.value = currentUser.email;
            if (editPhone) editPhone.value = currentUser.phone;
            
            // محاسبه آمار
            const trips = Trip.findByUserId(currentUser.id);
            const totalTrips = trips.length;
            const totalSpent = trips.reduce((sum, trip) => sum + (trip.price || 0), 0);
            const userRating = currentUser.rating || 4.7;
            
            const totalTripsCount = document.getElementById('totalTripsCount');
            const totalSpentElement = document.getElementById('totalSpent');
            const userRatingElement = document.getElementById('userRating');
            
            if (totalTripsCount) totalTripsCount.textContent = totalTrips;
            if (totalSpentElement) totalSpentElement.textContent = totalSpent;
            if (userRatingElement) userRatingElement.textContent = userRating;
        }

        // مدیریت پنل ادمین
        function loadAdminPanel() {
            if (!isAdmin) {
                showNotification('شما دسترسی به پنل مدیریت ندارید', 'error');
                document.getElementById('home-page').classList.add('active');
                document.getElementById('admin-page').classList.remove('active');
                return;
            }
            
            loadAdminStats();
            loadPendingUsers();
            loadAllUsers();
            loadDrivers();
            loadAdminTrips();
            loadAdminDiscounts();
            loadAdminSupport();
        }

        function loadAdminStats() {
            const users = User.getAll();
            const trips = Trip.getAll();
            
            const totalTripsElement = document.getElementById('totalTrips');
            const activeUsersElement = document.getElementById('activeUsers');
            const totalDriversElement = document.getElementById('totalDrivers');
            const totalRevenueElement = document.getElementById('totalRevenue');
            
            if (totalTripsElement) totalTripsElement.textContent = trips.length;
            if (activeUsersElement) activeUsersElement.textContent = users.filter(u => u.status === 'approved').length;
            if (totalDriversElement) totalDriversElement.textContent = users.filter(u => u.role === 'driver' && u.status === 'approved').length;
            
            const totalRevenue = trips.reduce((sum, trip) => sum + (trip.price || 0), 0);
            if (totalRevenueElement) totalRevenueElement.textContent = `${totalRevenue} افغانی`;
        }

        function loadPendingUsers() {
            const pendingUsersTable = document.getElementById('pendingUsersTable');
            if (!pendingUsersTable) return;
            
            pendingUsersTable.innerHTML = '';
            const users = User.getAll().filter(user => user.status === 'pending');
            
            if (users.length === 0) {
                pendingUsersTable.innerHTML = `
                    <tr>
                        <td colspan="6" style="text-align: center; padding: 20px; color: var(--gray);">
                            هیچ کاربری در انتظار تایید نیست
                        </td>
                    </tr>
                `;
                return;
            }
            
            users.forEach(user => {
                const row = document.createElement('tr');
                const date = new Date(user.created_at).toLocaleDateString('fa-IR');
                const roleText = user.role === 'passenger' ? 'مسافر' : 'راننده';
                
                row.innerHTML = `
                    <td>${user.name}</td>
                    <td>${user.email}</td>
                    <td>${user.phone}</td>
                    <td>${roleText}</td>
                    <td>${date}</td>
                    <td class="action-buttons">
                        <button class="action-btn btn-approve approve-user-btn" data-id="${user.id}">تایید</button>
                        <button class="action-btn btn-reject reject-user-btn" data-id="${user.id}">رد</button>
                    </td>
                `;
                
                pendingUsersTable.appendChild(row);
            });
            
            // اضافه کردن event listeners
            document.querySelectorAll('.approve-user-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const userId = parseInt(this.getAttribute('data-id'));
                    updateUserStatus(userId, 'approved');
                });
            });
            
            document.querySelectorAll('.reject-user-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const userId = parseInt(this.getAttribute('data-id'));
                    updateUserStatus(userId, 'rejected');
                });
            });
        }

        function updateUserStatus(userId, status) {
            const user = User.findById(userId);
            if (user) {
                user.status = status;
                user.save();
                showNotification(`کاربر ${user.name} ${status === 'approved' ? 'تایید' : 'رد'} شد`, 'success');
                loadPendingUsers();
                loadAllUsers();
            }
        }

        function loadAllUsers() {
            const allUsersTable = document.getElementById('allUsersTable');
            if (!allUsersTable) return;
            
            allUsersTable.innerHTML = '';
            const users = User.getAll();
            
            if (users.length === 0) {
                allUsersTable.innerHTML = `
                    <tr>
                        <td colspan="7" style="text-align: center; padding: 20px; color: var(--gray);">
                            هیچ کاربری ثبت نشده است
                        </td>
                    </tr>
                `;
                return;
            }
            
            users.forEach(user => {
                const row = document.createElement('tr');
                const date = new Date(user.created_at).toLocaleDateString('fa-IR');
                const roleText = user.role === 'passenger' ? 'مسافر' : 'راننده';
                const statusClass = `status-${user.status}`;
                const statusText = {
                    'pending': 'در انتظار تایید',
                    'approved': 'تایید شده',
                    'rejected': 'رد شده'
                }[user.status] || user.status;
                
                row.innerHTML = `
                    <td>${user.name}</td>
                    <td>${user.email}</td>
                    <td>${user.phone}</td>
                    <td>${roleText}</td>
                    <td><span class="status-badge ${statusClass}">${statusText}</span></td>
                    <td>${date}</td>
                    <td class="action-buttons">
                        ${user.status === 'approved' ? 
                          `<button class="action-btn btn-reject deactivate-user-btn" data-id="${user.id}">غیرفعال</button>` : 
                          user.status === 'rejected' ? 
                          `<button class="action-btn btn-approve activate-user-btn" data-id="${user.id}">فعال</button>` : ''}
                        <button class="action-btn btn-reject delete-user-btn" data-id="${user.id}">حذف</button>
                    </td>
                `;
                
                allUsersTable.appendChild(row);
            });
            
            // اضافه کردن event listeners
            document.querySelectorAll('.activate-user-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const userId = parseInt(this.getAttribute('data-id'));
                    updateUserStatus(userId, 'approved');
                });
            });
            
            document.querySelectorAll('.deactivate-user-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const userId = parseInt(this.getAttribute('data-id'));
                    updateUserStatus(userId, 'rejected');
                });
            });
            
            document.querySelectorAll('.delete-user-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const userId = parseInt(this.getAttribute('data-id'));
                    if (confirm('آیا از حذف این کاربر مطمئن هستید؟')) {
                        User.delete(userId);
                        showNotification('کاربر با موفقیت حذف شد', 'success');
                        loadAllUsers();
                        loadPendingUsers();
                    }
                });
            });
        }

        function loadDrivers() {
            const driversTable = document.getElementById('driversTable');
            if (!driversTable) return;
            
            driversTable.innerHTML = '';
            const drivers = User.getAll().filter(user => user.role === 'driver' && user.status === 'approved');
            
            if (drivers.length === 0) {
                driversTable.innerHTML = `
                    <tr>
                        <td colspan="7" style="text-align: center; padding: 20px; color: var(--gray);">
                            هیچ راننده‌ای ثبت نشده است
                        </td>
                    </tr>
                `;
                return;
            }
            
            drivers.forEach(driver => {
                const row = document.createElement('tr');
                const vehicleType = driver.vehicle_type || 'car';
                const vehicleTypeText = vehicleType === 'car' ? 'خودرو' : 'موتور';
                const statusClass = driver.driver_status === 'active' ? 'status-active' : 'status-inactive';
                const statusText = driver.driver_status === 'active' ? 'فعال' : 'غیرفعال';
                
                row.innerHTML = `
                    <td>${driver.name}</td>
                    <td>${driver.phone}</td>
                    <td>${vehicleTypeText}</td>
                    <td>${driver.car_model || '---'}</td>
                    <td>${driver.plate_number || '---'}</td>
                    <td><span class="status-badge ${statusClass}">${statusText}</span></td>
                    <td class="action-buttons">
                        <button class="action-btn ${driver.driver_status === 'active' ? 'btn-reject' : 'btn-approve'} toggle-driver-btn" data-id="${driver.id}" data-status="${driver.driver_status}">
                            ${driver.driver_status === 'active' ? 'غیرفعال' : 'فعال'}
                        </button>
                        <button class="action-btn btn-reject delete-driver-btn" data-id="${driver.id}">حذف</button>
                    </td>
                `;
                
                driversTable.appendChild(row);
            });
            
            // اضافه کردن event listeners
            document.querySelectorAll('.toggle-driver-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const driverId = parseInt(this.getAttribute('data-id'));
                    const currentStatus = this.getAttribute('data-status');
                    const newStatus = currentStatus === 'active' ? 'inactive' : 'active';
                    
                    const driver = User.findById(driverId);
                    if (driver) {
                        driver.driver_status = newStatus;
                        driver.save();
                        showNotification(`راننده ${driver.name} ${newStatus === 'active' ? 'فعال' : 'غیرفعال'} شد`, 'success');
                        loadDrivers();
                    }
                });
            });
            
            document.querySelectorAll('.delete-driver-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const driverId = parseInt(this.getAttribute('data-id'));
                    if (confirm('آیا از حذف این راننده مطمئن هستید؟')) {
                        User.delete(driverId);
                        showNotification('راننده با موفقیت حذف شد', 'success');
                        loadDrivers();
                    }
                });
            });
        }

        function loadAdminTrips() {
            const adminTripsTable = document.getElementById('adminTripsTable');
            if (!adminTripsTable) return;
            
            adminTripsTable.innerHTML = '';
            const trips = Trip.getAll().sort((a, b) => new Date(b.created_at) - new Date(a.created_at));
            
            if (trips.length === 0) {
                adminTripsTable.innerHTML = `
                    <tr>
                        <td colspan="7" style="text-align: center; padding: 20px; color: var(--gray);">
                            هیچ سفری ثبت نشده است
                        </td>
                    </tr>
                `;
                return;
            }
            
            trips.forEach(trip => {
                const row = document.createElement('tr');
                const date = new Date(trip.created_at).toLocaleDateString('fa-IR');
                const statusClass = `status-${trip.status}`;
                const statusText = {
                    'requested': 'درخواست شده',
                    'confirmed': 'تأیید شده',
                    'completed': 'تکمیل شده',
                    'cancelled': 'لغو شده'
                }[trip.status] || trip.status;
                
                row.innerHTML = `
                    <td>${date}</td>
                    <td>${trip.user_name || '---'}</td>
                    <td>${trip.pickup}</td>
                    <td>${trip.destination}</td>
                    <td>${trip.price} افغانی</td>
                    <td><span class="status-badge ${statusClass}">${statusText}</span></td>
                    <td class="action-buttons">
                        ${trip.status === 'requested' || trip.status === 'confirmed' ? 
                          `<button class="action-btn btn-reject cancel-admin-trip-btn" data-id="${trip.id}">لغو سفر</button>` : ''}
                        <button class="action-btn btn-reject delete-admin-trip-btn" data-id="${trip.id}">حذف</button>
                    </td>
                `;
                
                adminTripsTable.appendChild(row);
            });
            
            // اضافه کردن event listeners
            document.querySelectorAll('.cancel-admin-trip-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const tripId = parseInt(this.getAttribute('data-id'));
                    const trip = Trip.findById(tripId);
                    if (trip && confirm('آیا از لغو این سفر مطمئن هستید؟')) {
                        trip.status = 'cancelled';
                        trip.save();
                        showNotification('سفر لغو شد', 'success');
                        loadAdminTrips();
                    }
                });
            });
            
            document.querySelectorAll('.delete-admin-trip-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const tripId = parseInt(this.getAttribute('data-id'));
                    if (confirm('آیا از حذف این سفر مطمئن هستید؟')) {
                        Trip.delete(tripId);
                        showNotification('سفر با موفقیت حذف شد', 'success');
                        loadAdminTrips();
                    }
                });
            });
        }

        function loadAdminDiscounts() {
            const discountsTable = document.getElementById('discountsTable');
            if (!discountsTable) return;
            
            discountsTable.innerHTML = '';
            const discounts = Discount.getAll().sort((a, b) => new Date(b.created_at) - new Date(a.created_at));
            
            if (discounts.length === 0) {
                discountsTable.innerHTML = `
                    <tr>
                        <td colspan="6" style="text-align: center; padding: 20px; color: var(--gray);">
                            هیچ تخفیفی ثبت نشده است
                        </td>
                    </tr>
                `;
                return;
            }
            
            discounts.forEach(discount => {
                const row = document.createElement('tr');
                const expiryDate = new Date(discount.expiry_date).toLocaleDateString('fa-IR');
                const statusClass = new Date(discount.expiry_date) > new Date() ? 'status-active' : 'status-inactive';
                const statusText = new Date(discount.expiry_date) > new Date() ? 'فعال' : 'منقضی';
                
                row.innerHTML = `
                    <td>${discount.code}</td>
                    <td>${discount.percent}%</td>
                    <td>${expiryDate}</td>
                    <td>${discount.used_count || 0} / ${discount.max_uses}</td>
                    <td><span class="status-badge ${statusClass}">${statusText}</span></td>
                    <td class="action-buttons">
                        <button class="action-btn btn-reject delete-discount-btn" data-id="${discount.id}">حذف</button>
                    </td>
                `;
                
                discountsTable.appendChild(row);
            });
            
            // اضافه کردن event listeners
            document.querySelectorAll('.delete-discount-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const discountId = parseInt(this.getAttribute('data-id'));
                    if (confirm('آیا از حذف این تخفیف مطمئن هستید؟')) {
                        Discount.delete(discountId);
                        showNotification('تخفیف با موفقیت حذف شد', 'success');
                        loadAdminDiscounts();
                    }
                });
            });
        }

        function loadAdminSupport() {
            const adminSupportTable = document.getElementById('adminSupportTable');
            if (!adminSupportTable) return;
            
            adminSupportTable.innerHTML = '';
            const tickets = SupportTicket.getAll().sort((a, b) => new Date(b.created_at) - new Date(a.created_at));
            
            if (tickets.length === 0) {
                adminSupportTable.innerHTML = `
                    <tr>
                        <td colspan="6" style="text-align: center; padding: 20px; color: var(--gray);">
                            هیچ درخواست پشتیبانی ثبت نشده است
                        </td>
                    </tr>
                `;
                return;
            }
            
            tickets.forEach(ticket => {
                const row = document.createElement('tr');
                const date = new Date(ticket.created_at).toLocaleDateString('fa-IR');
                const statusClass = `status-${ticket.status}`;
                const statusText = {
                    'pending': 'در انتظار پاسخ',
                    'answered': 'پاسخ داده شده',
                    'closed': 'بسته شده'
                }[ticket.status] || ticket.status;
                
                row.innerHTML = `
                    <td>${ticket.user_name || '---'}</td>
                    <td>${ticket.subject}</td>
                    <td>${ticket.message.length > 50 ? ticket.message.substring(0, 50) + '...' : ticket.message}</td>
                    <td>${date}</td>
                    <td><span class="status-badge ${statusClass}">${statusText}</span></td>
                    <td class="action-buttons">
                        ${ticket.status !== 'closed' ? 
                          `<button class="action-btn btn-approve reply-ticket-btn" data-id="${ticket.id}">پاسخ</button>` : ''}
                        <button class="action-btn btn-reject close-ticket-btn" data-id="${ticket.id}">${ticket.status === 'closed' ? 'حذف' : 'بستن'}</button>
                    </td>
                `;
                
                adminSupportTable.appendChild(row);
            });
            
            // اضافه کردن event listeners
            document.querySelectorAll('.reply-ticket-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const ticketId = parseInt(this.getAttribute('data-id'));
                    replyToTicket(ticketId);
                });
            });
            
            document.querySelectorAll('.close-ticket-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const ticketId = parseInt(this.getAttribute('data-id'));
                    const ticket = SupportTicket.getAll().find(t => t.id === ticketId);
                    if (ticket) {
                        if (ticket.status === 'closed') {
                            if (confirm('آیا از حذف این تیکت مطمئن هستید؟')) {
                                // حذف تیکت
                                let tickets = storage.get('snapp_support');
                                tickets = tickets.filter(t => t.id !== ticketId);
                                storage.set('snapp_support', tickets);
                                showNotification('تیکت با موفقیت حذف شد', 'success');
                                loadAdminSupport();
                            }
                        } else {
                            if (confirm('آیا می‌خواهید این تیکت را ببندید؟')) {
                                ticket.status = 'closed';
                                ticket.save();
                                showNotification('تیکت بسته شد', 'success');
                                loadAdminSupport();
                            }
                        }
                    }
                });
            });
        }

        function replyToTicket(ticketId) {
            const reply = prompt('پاسخ خود را وارد کنید:');
            if (reply) {
                const ticket = SupportTicket.getAll().find(t => t.id === ticketId);
                if (ticket) {
                    ticket.reply = reply;
                    ticket.status = 'answered';
                    ticket.replied_at = new Date().toISOString();
                    ticket.save();
                    showNotification('پاسخ با موفقیت ثبت شد', 'success');
                    loadAdminSupport();
                }
            }
        }

        // مدال‌ها
        function openRatingModal(tripId = null) {
            const ratingModal = document.getElementById('ratingModal');
            const ratingStars = document.getElementById('ratingStars');
            
            if (!ratingModal || !ratingStars) return;
            
            const stars = ratingStars.querySelectorAll('.rating-star');
            stars.forEach(star => {
                star.classList.remove('active');
                star.addEventListener('click', function() {
                    const rating = parseInt(this.getAttribute('data-rating'));
                    stars.forEach(s => {
                        if (parseInt(s.getAttribute('data-rating')) <= rating) {
                            s.classList.add('active');
                        } else {
                            s.classList.remove('active');
                        }
                    });
                });
            });
            
            ratingModal.style.display = 'flex';
            if (tripId) {
                ratingModal.setAttribute('data-trip-id', tripId);
            }
        }

        function openPaymentModal() {
            const paymentModal = document.getElementById('paymentModal');
            if (!paymentModal) return;
            
            const paymentDistance = document.getElementById('paymentDistance');
            const paymentPrice = document.getElementById('paymentPrice');
            
            if (paymentDistance) paymentDistance.textContent = `${currentDistance} کیلومتر`;
            if (paymentPrice) paymentPrice.textContent = `${currentPrice} افغانی`;
            
            document.querySelectorAll('.payment-method').forEach(method => {
                method.classList.remove('selected');
                if (method.getAttribute('data-method') === selectedPaymentMethod) {
                    method.classList.add('selected');
                }
            });
            
            const walletPayment = document.getElementById('walletPayment');
            if (selectedPaymentMethod === 'wallet') {
                if (walletPayment) walletPayment.style.display = 'block';
                const walletBalance = document.getElementById('walletBalance');
                if (walletBalance) walletBalance.textContent = currentUser?.wallet_balance || 0;
            } else {
                if (walletPayment) walletPayment.style.display = 'none';
            }
            
            paymentModal.style.display = 'flex';
        }

        function openAuthModal() {
            const authModal = document.getElementById('authModal');
            if (authModal) authModal.style.display = 'flex';
            clearErrors();
        }

        // Event Listeners
        window.onload = function() {
            initMap();
            checkUserLoginStatus();
            
            // دکمه شروع استفاده
            document.getElementById('start-using-btn').addEventListener('click', () => {
                document.getElementById('welcome-page').style.display = 'none';
                document.getElementById('main-header').style.display = 'block';
                document.getElementById('main-container').style.display = 'block';
                document.getElementById('main-footer').style.display = 'block';
                showNotification('به اسنپ افغانستان خوش آمدید!', 'success');
            });

            // دکمه اطلاعات بیشتر
            document.getElementById('learn-more-btn').addEventListener('click', () => {
                showNotification('اسنپ افغانستان اولین سرویس تاکسی اینترنتی در کابل است که با بهترین کیفیت و مناسب‌ترین قیمت خدمات ارائه می‌دهد.', 'info');
            });

            // انتخاب نوع سفر
            document.querySelectorAll('.ride-type').forEach(type => {
                type.addEventListener('click', () => {
                    document.querySelectorAll('.ride-type').forEach(t => t.classList.remove('selected'));
                    type.classList.add('selected');
                    selectedRideType = type.dataset.type;
                    updatePrice();
                });
            });

            // انتخاب روش پرداخت
            document.querySelectorAll('.payment-method').forEach(method => {
                method.addEventListener('click', () => {
                    document.querySelectorAll('.payment-method').forEach(m => m.classList.remove('selected'));
                    method.classList.add('selected');
                    selectedPaymentMethod = method.getAttribute('data-method');
                });
            });

            // تعویض مبدا و مقصد
            document.getElementById('swapLocations').addEventListener('click', () => {
                const pickupInput = document.getElementById('pickup');
                const destinationInput = document.getElementById('destination');
                
                if (!destinationInput.value) {
                    showNotification('لطفاً ابتدا مقصد را وارد کنید', 'error');
                    return;
                }
                
                const pickupValue = pickupInput.value;
                const destinationValue = destinationInput.value;
                
                pickupInput.value = destinationValue;
                destinationInput.value = pickupValue;
                calculateDistanceAndPrice();
                showNotification('مبدا و مقصد با موفقیت تعویض شدند', 'info');
            });

            // فرم درخواست سفر
            document.getElementById('rideForm').addEventListener('submit', (e) => {
                e.preventDefault();
                
                if (!currentUser) {
                    showNotification('لطفاً ابتدا وارد حساب کاربری خود شوید', 'error');
                    openAuthModal();
                    return;
                }
                
                const pickupInput = document.getElementById('pickup');
                const destinationInput = document.getElementById('destination');
                const pickup = pickupInput?.value.trim();
                const destination = destinationInput?.value.trim();

                if (!pickup || !destination) {
                    showNotification('لطفاً مبدا و مقصد را وارد کنید', 'error');
                    return;
                }

                if (pickup === destination) {
                    showNotification('مبدا و مقصد نمی‌توانند یکسان باشند', 'error');
                    return;
                }

                if (currentDistance === 0) {
                    showNotification('لطفاً منتظر بمانید تا مسافت محاسبه شود', 'error');
                    return;
                }

                // پیدا کردن مختصات
                const pickupLocation = kabulData.locations.find(loc => loc.name === pickup);
                const destinationLocation = kabulData.locations.find(loc => loc.name === destination);

                // ایجاد سفر
                const trip = new Trip({
                    pickup,
                    destination,
                    pickup_coords: pickupLocation?.coordinates || [69.1800, 34.5250],
                    destination_coords: destinationLocation?.coordinates || [69.1900, 34.5300],
                    ride_type: selectedRideType,
                    distance: currentDistance,
                    price: currentPrice,
                    user_id: currentUser.id,
                    user_name: currentUser.name,
                    payment_method: selectedPaymentMethod
                });

                trip.save();
                currentTripId = trip.id;

                showNotification('سفر شما ثبت شد. در حال یافتن راننده...', 'info');
                startDriverSearch();
            });

            // شروع جستجوی راننده
            function startDriverSearch() {
                const submitBtn = document.getElementById('submitBtn');
                const searchingOverlay = document.getElementById('searchingOverlay');
                
                if (submitBtn) submitBtn.disabled = true;
                if (searchingOverlay) searchingOverlay.style.display = 'flex';
                
                let searchTime = 0;
                const searchInterval = setInterval(() => {
                    searchTime++;
                    const searchingText = document.getElementById('searchingText');
                    
                    if (searchTime === 3 && searchingText) {
                        searchingText.textContent = "در حال بررسی رانندگان موجود...";
                    } else if (searchTime === 6 && searchingText) {
                        searchingText.textContent = "برقراری ارتباط با راننده...";
                    } else if (searchTime === 9) {
                        clearInterval(searchInterval);
                        findDriver();
                    }
                }, 500);
                
                window.searchInterval = searchInterval;
            }

            function findDriver() {
                const pickupInput = document.getElementById('pickup');
                const searchingOverlay = document.getElementById('searchingOverlay');
                const submitBtn = document.getElementById('submitBtn');
                
                if (searchingOverlay) searchingOverlay.style.display = 'none';
                if (submitBtn) submitBtn.disabled = false;
                
                const nearestDriver = findNearestDriver(pickupInput?.value, selectedRideType);
                
                if (!nearestDriver) {
                    showNotification('هیچ راننده‌ای در حال حاضر در دسترس نیست. لطفاً بعداً تلاش کنید.', 'error');
                    return;
                }
                
                currentDriver = nearestDriver;
                
                // پر کردن معلومات راننده
                document.getElementById('driverAvatar').textContent = nearestDriver.name.charAt(0);
                document.getElementById('driverName').textContent = nearestDriver.name;
                document.getElementById('driverRating').textContent = nearestDriver.rating;
                document.getElementById('driverTrips').textContent = `(${nearestDriver.total_trips} سفر)`;
                document.getElementById('carModel').textContent = nearestDriver.car_model || '---';
                document.getElementById('carColor').textContent = nearestDriver.car_color || '---';
                document.getElementById('plateNumber').textContent = nearestDriver.plate_number || '---';
                document.getElementById('eta').textContent = nearestDriver.eta;
                document.getElementById('distance').textContent = nearestDriver.distance;
                document.getElementById('price').textContent = `${currentPrice} افغانی`;
                
                document.getElementById('driverModal').style.display = 'flex';
                showNotification(`راننده ${nearestDriver.name} پیدا شد!`, 'success');
            }

            // لغو جستجو
            document.getElementById('cancelSearch').addEventListener('click', () => {
                clearInterval(window.searchInterval);
                document.getElementById('searchingOverlay').style.display = 'none';
                document.getElementById('submitBtn').disabled = false;
                showNotification('جستجو لغو شد', 'warning');
            });

            // تأیید سفر
            document.getElementById('confirmRide').addEventListener('click', () => {
                document.getElementById('driverModal').style.display = 'none';
                
                // به‌روزرسانی وضعیت سفر
                const trip = Trip.findById(currentTripId);
                if (trip) {
                    trip.status = 'confirmed';
                    trip.driver_id = currentDriver.id;
                    trip.driver_name = currentDriver.name;
                    trip.save();
                }
                
                // پیدا کردن مختصات
                const pickupLocation = kabulData.locations.find(loc => loc.name === trip.pickup);
                const destinationLocation = kabulData.locations.find(loc => loc.name === trip.destination);
                
                // شروع ردیابی
                startTripTracking(currentDriver, 
                    pickupLocation?.coordinates || [69.1800, 34.5250],
                    destinationLocation?.coordinates || [69.1900, 34.5300]
                );
                showNotification('سفر شما با موفقیت ثبت شد. راننده به زودی با شما تماس خواهد گرفت.', 'success');
                
                // بازنشانی فرم
                document.getElementById('rideForm').reset();
                document.getElementById('tripCalculator').classList.remove('active');
                currentDistance = 0;
                currentPrice = 0;
                
                const rideTypes = document.querySelectorAll('.ride-type');
                rideTypes.forEach(t => t.classList.remove('selected'));
                if (rideTypes.length > 0) rideTypes[0].classList.add('selected');
                selectedRideType = 'economy';
            });

            function startTripTracking(driver, startCoords, endCoords) {
                const liveTracking = document.getElementById('liveTracking');
                if (liveTracking) liveTracking.style.display = 'block';
                
                document.getElementById('trackingDriverName').textContent = driver.name;
                document.getElementById('trackingETA').textContent = driver.eta;
                document.getElementById('trackingDistance').textContent = driver.distance;
                
                drawRoute(startCoords, endCoords);
                simulateCarMovement(startCoords, endCoords, selectedRideType === 'bike');
            }

            // لغو ردیابی
            document.getElementById('cancelTracking').addEventListener('click', () => {
                if (confirm('آیا از لغو این سفر مطمئن هستید؟')) {
                    document.getElementById('liveTracking').style.display = 'none';
                    clearRoute();
                    if (carAnimationInterval) {
                        clearInterval(carAnimationInterval);
                    }
                    
                    const trip = Trip.findById(currentTripId);
                    if (trip) {
                        trip.status = 'cancelled';
                        trip.save();
                    }
                    showNotification('سفر لغو شد', 'warning');
                }
            });

            // محاسبه مسافت هنگام تغییر مقصد
            document.getElementById('destination').addEventListener('input', () => {
                setTimeout(calculateDistanceAndPrice, 1000);
            });

            document.getElementById('pickup').addEventListener('input', () => {
                setTimeout(calculateDistanceAndPrice, 1000);
            });

            // پیشنهادات مقصد
            document.querySelectorAll('.suggestion-item').forEach(item => {
                item.addEventListener('click', () => {
                    const destination = item.getAttribute('data-destination');
                    const destinationInput = document.getElementById('destination');
                    if (destinationInput) {
                        destinationInput.value = destination;
                        showNotification(`مقصد به "${destination}" تنظیم شد`, 'info');
                        calculateDistanceAndPrice();
                    }
                });
            });

            // مدیریت ورود/ثبت‌نام
            document.getElementById('loginBtn').addEventListener('click', openAuthModal);
            document.getElementById('mobileLoginBtn').addEventListener('click', openAuthModal);

            document.getElementById('loginForm').addEventListener('submit', (e) => {
                e.preventDefault();
                clearErrors();
                
                const email = document.getElementById('loginEmail').value.trim();
                const password = document.getElementById('loginPassword').value;
                
                const user = User.findByCredentials(email, password);
                
                if (!user) {
                    showError('loginEmail', 'ایمیل/شماره تماس یا رمز عبور اشتباه است');
                    return;
                }
                
                if (user.status !== 'approved') {
                    showError('loginEmail', 'حساب کاربری شما هنوز تایید نشده است');
                    return;
                }
                
                currentUser = user;
                isAdmin = currentUser.role === 'admin';
                localStorage.setItem('snapp_current_user', JSON.stringify(currentUser));
                
                showNotification(`خوش آمدید ${currentUser.name}`, 'success');
                document.getElementById('authModal').style.display = 'none';
                document.getElementById('loginForm').reset();
                updateUIAfterLogin();
            });

            document.getElementById('registerForm').addEventListener('submit', (e) => {
                e.preventDefault();
                clearErrors();
                
                const name = document.getElementById('registerName').value.trim();
                const email = document.getElementById('registerEmail').value.trim();
                const phone = document.getElementById('registerPhone').value.trim();
                const password = document.getElementById('registerPassword').value;
                const confirmPassword = document.getElementById('registerConfirmPassword').value;
                const userType = document.getElementById('userType').value;
                
                // اعتبارسنجی
                if (name.length < 2) {
                    showError('registerName', 'نام باید حداقل ۲ حرف داشته باشد');
                    return;
                }
                
                if (!email.includes('@')) {
                    showError('registerEmail', 'لطفاً یک ایمیل معتبر وارد کنید');
                    return;
                }
                
                if (phone.length < 10) {
                    showError('registerPhone', 'لطفاً یک شماره تماس معتبر وارد کنید');
                    return;
                }
                
                if (password.length < 6) {
                    showError('registerPassword', 'رمز عبور باید حداقل ۶ حرف داشته باشد');
                    return;
                }
                
                if (password !== confirmPassword) {
                    showError('registerConfirmPassword', 'رمز عبور و تکرار آن مطابقت ندارند');
                    return;
                }
                
                if (!userType) {
                    showError('userType', 'لطفاً نوع کاربر را انتخاب کنید');
                    return;
                }
                
                // بررسی تکراری نبودن ایمیل
                const existingUser = User.getAll().find(u => u.email === email);
                if (existingUser) {
                    showError('registerEmail', 'این ایمیل قبلاً ثبت شده است');
                    return;
                }
                
                // ایجاد کاربر جدید
                const user = new User({
                    id: Date.now(),
                    name,
                    email,
                    phone,
                    password,
                    role: userType,
                    status: 'pending'
                });
                
                user.save();
                
                showNotification('ثبت‌نام شما با موفقیت انجام شد. پس از تایید مدیر می‌توانید وارد شوید.', 'success');
                document.getElementById('registerForm').reset();
                
                // تغییر به تب ورود
                document.querySelectorAll('.form-tab').forEach(t => t.classList.remove('active'));
                document.querySelectorAll('.form-tab-content').forEach(c => c.classList.remove('active'));
                document.querySelector('.form-tab[data-tab="login"]').classList.add('active');
                document.getElementById('login-tab').classList.add('active');
            });

            // مدیریت خروج
            document.getElementById('logoutBtn').addEventListener('click', logout);
            document.getElementById('mobileLogoutBtn').addEventListener('click', logout);

            // مدیریت منوی موبایل
            document.getElementById('hamburger').addEventListener('click', () => {
                document.getElementById('mobileMenu').classList.add('active');
                document.getElementById('overlay').classList.add('active');
                document.getElementById('hamburger').classList.add('active');
            });

            document.getElementById('closeMenu').addEventListener('click', () => {
                document.getElementById('mobileMenu').classList.remove('active');
                document.getElementById('overlay').classList.remove('active');
                document.getElementById('hamburger').classList.remove('active');
            });

            document.getElementById('overlay').addEventListener('click', () => {
                document.getElementById('mobileMenu').classList.remove('active');
                document.getElementById('overlay').classList.remove('active');
                document.getElementById('hamburger').classList.remove('active');
            });

            // مدیریت صفحات
            document.querySelectorAll('.nav-link').forEach(link => {
                link.addEventListener('click', (e) => {
                    e.preventDefault();
                    const pageId = link.getAttribute('data-page') + '-page';
                    
                    document.querySelectorAll('.page').forEach(page => {
                        page.classList.remove('active');
                    });
                    
                    document.querySelectorAll('.nav-link').forEach(l => {
                        l.classList.remove('active');
                    });
                    link.classList.add('active');
                    
                    const targetPage = document.getElementById(pageId);
                    if (targetPage) targetPage.classList.add('active');
                    
                    // بستن منوی موبایل
                    document.getElementById('mobileMenu').classList.remove('active');
                    document.getElementById('overlay').classList.remove('active');
                    document.getElementById('hamburger').classList.remove('active');
                    
                    // بارگذاری داده‌های صفحه
                    if (pageId === 'my-trips-page') {
                        loadMyTrips();
                    } else if (pageId === 'discounts-page') {
                        loadDiscounts();
                    } else if (pageId === 'profile-page') {
                        updateProfilePage();
                    } else if (pageId === 'admin-page') {
                        loadAdminPanel();
                    }
                });
            });

            // بستن مدال‌ها
            document.querySelectorAll('.close-modal').forEach(btn => {
                btn.addEventListener('click', () => {
                    btn.closest('.modal').style.display = 'none';
                });
            });

            // مدیریت چت پشتیبانی
            document.getElementById('sendMessage').addEventListener('click', () => {
                const chatInput = document.getElementById('chatInput');
                const message = chatInput.value.trim();
                
                if (message && currentUser) {
                    const chatMessages = document.getElementById('chatMessages');
                    const messageElement = document.createElement('div');
                    messageElement.className = 'message sent';
                    messageElement.innerHTML = `
                        ${message}
                        <div class="message-time">${new Date().toLocaleTimeString('fa-IR', { hour: '2-digit', minute: '2-digit' })}</div>
                    `;
                    chatMessages.appendChild(messageElement);
                    chatInput.value = '';
                    chatMessages.scrollTop = chatMessages.scrollHeight;
                    
                    // ایجاد تیکت پشتیبانی
                    const ticket = new SupportTicket({
                        user_id: currentUser.id,
                        user_name: currentUser.name,
                        subject: 'درخواست پشتیبانی',
                        message: message
                    });
                    ticket.save();
                    
                    // شبیه‌سازی پاسخ
                    setTimeout(() => {
                        const responses = [
                            'متشکریم از پیام شما. چگونه می‌توانیم کمکتان کنیم؟',
                            'پیام شما دریافت شد. همکاران ما به زودی با شما تماس خواهند گرفت.',
                            'لطفاً شماره تماس خود را برای پیگیری بیشتر ارسال کنید.'
                        ];
                        const response = responses[Math.floor(Math.random() * responses.length)];
                        const responseElement = document.createElement('div');
                        responseElement.className = 'message received';
                        responseElement.innerHTML = `
                            ${response}
                            <div class="message-time">${new Date().toLocaleTimeString('fa-IR', { hour: '2-digit', minute: '2-digit' })}</div>
                        `;
                        chatMessages.appendChild(responseElement);
                        chatMessages.scrollTop = chatMessages.scrollHeight;
                    }, 1000);
                } else if (!currentUser) {
                    showNotification('لطفاً ابتدا وارد حساب کاربری خود شوید', 'error');
                }
            });

            // ذخیره پروفایل
            document.getElementById('saveProfile').addEventListener('click', () => {
                const name = document.getElementById('editName').value;
                const email = document.getElementById('editEmail').value;
                const phone = document.getElementById('editPhone').value;
                
                if (!name || !email || !phone) {
                    showNotification('لطفاً تمام فیلدها را پر کنید', 'error');
                    return;
                }
                
                const users = User.getAll();
                const updatedUsers = users.map(user => {
                    if (user.id === currentUser.id) {
                        user.name = name;
                        user.email = email;
                        user.phone = phone;
                    }
                    return user;
                });
                
                storage.set('snapp_users', updatedUsers);
                currentUser = User.findById(currentUser.id);
                localStorage.setItem('snapp_current_user', JSON.stringify(currentUser));
                
                updateUIAfterLogin();
                showNotification('پروفایل با موفقیت به‌روزرسانی شد', 'success');
            });

            // مدیریت تب‌های ادمین
            document.querySelectorAll('.admin-tab').forEach(tab => {
                tab.addEventListener('click', () => {
                    const tabId = tab.getAttribute('data-tab');
                    
                    // حذف کلاس active از همه تب‌ها
                    document.querySelectorAll('.admin-tab').forEach(t => {
                        t.classList.remove('active');
                    });
                    
                    // حذف کلاس active از همه محتواها
                    document.querySelectorAll('.admin-tab-content').forEach(c => {
                        c.classList.remove('active');
                    });
                    
                    // اضافه کردن کلاس active به تب انتخاب شده
                    tab.classList.add('active');
                    
                    // نمایش محتوای مربوطه
                    const tabContent = document.getElementById(`${tabId}-tab`);
                    if (tabContent) {
                        tabContent.classList.add('active');
                    }
                });
            });

            // دکمه‌های ریفرش در پنل ادمین
            document.getElementById('refreshUsersBtn')?.addEventListener('click', () => {
                loadPendingUsers();
                loadAllUsers();
                showNotification('لیست کاربران به‌روزرسانی شد', 'success');
            });

            document.getElementById('refreshDriversBtn')?.addEventListener('click', () => {
                loadDrivers();
                showNotification('لیست رانندگان به‌روزرسانی شد', 'success');
            });

            document.getElementById('refreshTripsBtn')?.addEventListener('click', () => {
                loadAdminTrips();
                showNotification('لیست سفرها به‌روزرسانی شد', 'success');
            });

            document.getElementById('refreshDiscountsBtn')?.addEventListener('click', () => {
                loadAdminDiscounts();
                showNotification('لیست تخفیف‌ها به‌روزرسانی شد', 'success');
            });

            document.getElementById('refreshSupportBtn')?.addEventListener('click', () => {
                loadAdminSupport();
                showNotification('لیست پشتیبانی به‌روزرسانی شد', 'success');
            });

            // دکمه افزودن راننده
            document.getElementById('addDriverBtn')?.addEventListener('click', () => {
                document.getElementById('addDriverModal').style.display = 'flex';
            });

            // فرم افزودن راننده
            document.getElementById('addDriverForm')?.addEventListener('submit', (e) => {
                e.preventDefault();
                
                const name = document.getElementById('driverName').value;
                const email = document.getElementById('driverEmail').value;
                const phone = document.getElementById('driverPhone').value;
                const vehicleType = document.getElementById('vehicleType').value;
                const carModel = document.getElementById('carModelInput').value;
                const carColor = document.getElementById('carColorInput').value;
                const plateNumber = document.getElementById('plateNumberInput').value;
                
                const driver = new User({
                    id: Date.now(),
                    name,
                    email,
                    phone,
                    password: '123456', // رمز عبور پیش‌فرض
                    role: 'driver',
                    status: 'approved',
                    vehicle_type: vehicleType,
                    car_model: carModel,
                    car_color: carColor,
                    plate_number: plateNumber,
                    driver_status: 'active',
                    rating: 4.5,
                    total_trips: 0,
                    current_location: [69.1800, 34.5250]
                });
                
                driver.save();
                
                document.getElementById('addDriverModal').style.display = 'none';
                document.getElementById('addDriverForm').reset();
                showNotification('راننده با موفقیت اضافه شد', 'success');
                loadDrivers();
            });

            // دکمه افزودن تخفیف
            document.getElementById('addDiscountBtn')?.addEventListener('click', () => {
                document.getElementById('addDiscountModal').style.display = 'flex';
            });

            // فرم افزودن تخفیف
            document.getElementById('addDiscountForm')?.addEventListener('submit', (e) => {
                e.preventDefault();
                
                const code = document.getElementById('discountCode').value;
                const percent = parseInt(document.getElementById('discountPercent').value);
                const expiryDate = document.getElementById('discountExpiry').value;
                const maxUses = parseInt(document.getElementById('maxUses').value);
                
                const discount = new Discount({
                    id: Date.now(),
                    code,
                    percent,
                    expiry_date: expiryDate,
                    max_uses: maxUses,
                    used_count: 0
                });
                
                discount.save();
                
                document.getElementById('addDiscountModal').style.display = 'none';
                document.getElementById('addDiscountForm').reset();
                showNotification('تخفیف با موفقیت اضافه شد', 'success');
                loadAdminDiscounts();
            });

            // دکمه لغو سفر در مدال راننده
            document.getElementById('cancelRide')?.addEventListener('click', () => {
                if (confirm('آیا از لغو این سفر مطمئن هستید؟')) {
                    document.getElementById('driverModal').style.display = 'none';
                    
                    const trip = Trip.findById(currentTripId);
                    if (trip) {
                        trip.status = 'cancelled';
                        trip.save();
                    }
                    
                    showNotification('سفر لغو شد', 'warning');
                }
            });

            // دکمه ثبت امتیاز
            document.getElementById('submitRating')?.addEventListener('click', () => {
                const stars = document.querySelectorAll('.rating-star.active');
                const rating = stars.length;
                const comment = document.getElementById('ratingComment').value;
                const tripId = document.getElementById('ratingModal').getAttribute('data-trip-id');
                
                if (rating === 0) {
                    showNotification('لطفاً به راننده امتیاز دهید', 'error');
                    return;
                }
                
                const trip = Trip.findById(parseInt(tripId));
                if (trip) {
                    trip.rated = true;
                    trip.rating = rating;
                    trip.rating_comment = comment;
                    trip.save();
                    
                    // به‌روزرسانی امتیاز راننده
                    const driver = User.findById(trip.driver_id);
                    if (driver) {
                        // محاسبه میانگین جدید
                        const driverTrips = Trip.getAll().filter(t => t.driver_id === driver.id && t.rated);
                        const totalRating = driverTrips.reduce((sum, t) => sum + t.rating, 0);
                        driver.rating = (totalRating / driverTrips.length).toFixed(1);
                        driver.save();
                    }
                }
                
                document.getElementById('ratingModal').style.display = 'none';
                document.getElementById('ratingComment').value = '';
                document.querySelectorAll('.rating-star').forEach(star => {
                    star.classList.remove('active');
                });
                
                showNotification('امتیاز شما با موفقیت ثبت شد', 'success');
                loadMyTrips();
            });

            // دکمه پرداخت
            document.getElementById('confirmPayment')?.addEventListener('click', () => {
                document.getElementById('paymentModal').style.display = 'none';
                
                const trip = Trip.findById(currentTripId);
                if (trip) {
                    trip.status = 'completed';
                    trip.save();
                    
                    // اگر پرداخت با کیف پول بود، کسر از موجودی
                    if (selectedPaymentMethod === 'wallet' && currentUser) {
                        currentUser.wallet_balance -= currentPrice;
                        currentUser.save();
                        localStorage.setItem('snapp_current_user', JSON.stringify(currentUser));
                    }
                }
                
                showNotification('پرداخت با موفقیت انجام شد. سفر تکمیل شد.', 'success');
                openRatingModal(currentTripId);
            });
        };
    </script>
</body>
</html>