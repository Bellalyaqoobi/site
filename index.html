<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ø§Ø³Ù†Ù¾ Ø§ÙØºØ§Ù†Ø³ØªØ§Ù† - ØªØ§Ú©Ø³ÛŒ Ø§ÛŒÙ†ØªØ±Ù†ØªÛŒ Ú©Ø§Ø¨Ù„</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        :root {
            --primary: #00D474;
            --primary-dark: #00B562;
            --primary-light: #80EAB9;
            --secondary: #6C63FF;
            --accent: #FF6584;
            --light: #F8F9FA;
            --dark: #1A1A2E;
            --gray: #6c757d;
            --border: #E8EAF6;
            --shadow: 0 10px 30px rgba(0, 0, 0, 0.08);
            --radius: 16px;
            --gradient-primary: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
            --gradient-dark: linear-gradient(135deg, var(--dark) 0%, #16213E 100%);
            --gradient-accent: linear-gradient(135deg, var(--accent) 0%, #FF9A9E 100%);
        }

        body {
            background-color: #F5F7FF;
            color: var(--dark);
            line-height: 1.6;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 0 20px;
            width: 100%;
        }

        /* ØµÙØ­Ù‡ Ø®ÙˆØ´Ø¢Ù…Ø¯Ú¯ÙˆÛŒÛŒ */
        .welcome-page {
            background: var(--gradient-dark);
            color: white;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            text-align: center;
            padding: 20px;
            position: relative;
            overflow: hidden;
        }

        .welcome-content {
            max-width: 900px;
            margin: 0 auto;
            position: relative;
            z-index: 1;
        }

        .welcome-logo {
            font-size: 52px;
            margin-bottom: 25px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 20px;
            animation: float 3s ease-in-out infinite;
        }

        @keyframes float {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }

        .welcome-logo i {
            color: var(--primary);
            font-size: 64px;
            filter: drop-shadow(0 4px 12px rgba(0, 212, 116, 0.3));
        }

        .welcome-title {
            font-size: 48px;
            margin-bottom: 20px;
            font-weight: 800;
            background: var(--gradient-primary);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .welcome-subtitle {
            font-size: 24px;
            margin-bottom: 40px;
            opacity: 0.9;
            font-weight: 300;
        }

        /* Ù‡Ø¯Ø± */
        header {
            background: var(--gradient-dark);
            box-shadow: 0 4px 30px rgba(0, 0, 0, 0.1);
            position: sticky;
            top: 0;
            z-index: 1000;
            backdrop-filter: blur(10px);
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .nav-container {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 0;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 12px;
            font-size: 22px;
            font-weight: 700;
            color: white;
            text-decoration: none;
        }

        .logo i {
            font-size: 28px;
            color: var(--primary);
            background: rgba(0, 212, 116, 0.1);
            width: 44px;
            height: 44px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 12px;
        }

        .nav-links {
            display: flex;
            list-style: none;
            gap: 30px;
        }

        .nav-links a {
            text-decoration: none;
            color: white;
            font-weight: 500;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 16px;
            border-radius: 12px;
        }

        .nav-links a:hover {
            background: rgba(255, 255, 255, 0.05);
        }

        .nav-links a.active {
            background: rgba(0, 212, 116, 0.1);
            color: var(--primary);
        }

        .user-actions {
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .user-profile {
            display: flex;
            align-items: center;
            gap: 12px;
            color: white;
            cursor: pointer;
            padding: 8px 16px;
            border-radius: 12px;
            transition: all 0.3s;
        }

        .user-profile:hover {
            background: rgba(255, 255, 255, 0.05);
        }

        .user-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: var(--gradient-primary);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
        }

        .btn {
            padding: 10px 24px;
            border-radius: 12px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s;
            border: none;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .btn-primary {
            background: var(--gradient-primary);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0, 212, 116, 0.3);
        }

        .btn-outline {
            background: transparent;
            border: 1px solid rgba(255, 255, 255, 0.3);
            color: white;
        }

        .btn-outline:hover {
            background: rgba(255, 255, 255, 0.05);
        }

        /* Ù†Ù‚Ø´Ù‡ */
        .map-container {
            background: white;
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            overflow: hidden;
            height: 600px;
            position: relative;
        }

        #map {
            width: 100%;
            height: 100%;
            z-index: 1;
        }

        /* Ù¾Ù†Ù„ Ø¯Ø±Ø®ÙˆØ§Ø³Øª */
        .ride-panel {
            background: white;
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            padding: 25px;
            height: fit-content;
            position: sticky;
            top: 100px;
        }

        .panel-title {
            font-size: 20px;
            margin-bottom: 25px;
            color: var(--dark);
            display: flex;
            align-items: center;
            gap: 12px;
            padding-bottom: 15px;
            border-bottom: 2px solid var(--border);
        }

        .panel-title i {
            color: var(--primary);
        }

        .form-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
            margin-bottom: 20px;
        }

        .form-input {
            padding: 15px 20px;
            border: 2px solid var(--border);
            border-radius: 12px;
            font-size: 16px;
            transition: all 0.3s;
            width: 100%;
        }

        .form-input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(0, 212, 116, 0.1);
        }

        .ride-type-selector {
            display: flex;
            flex-direction: column;
            gap: 12px;
            margin: 20px 0;
        }

        .ride-type {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 18px;
            border: 2px solid var(--border);
            border-radius: 16px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .ride-type:hover {
            border-color: var(--primary);
        }

        .ride-type.selected {
            border-color: var(--primary);
            background: linear-gradient(135deg, rgba(0, 212, 116, 0.05) 0%, rgba(108, 99, 255, 0.05) 100%);
        }

        .submit-btn {
            background: var(--gradient-primary);
            color: white;
            border: none;
            padding: 18px;
            border-radius: 16px;
            font-size: 18px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            width: 100%;
            margin-top: 20px;
        }

        .submit-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 15px 35px rgba(0, 212, 116, 0.3);
        }

        /* Ø¬Ø¯ÙˆÙ„â€ŒÙ‡Ø§ */
        .table-container {
            overflow-x: auto;
            margin-top: 25px;
            border-radius: 16px;
            border: 1px solid var(--border);
            box-shadow: 0 4px 15px rgba(0,0,0,0.05);
        }

        .data-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 15px;
            min-width: 800px;
        }

        .data-table th {
            background: linear-gradient(135deg, rgba(0, 212, 116, 0.05) 0%, rgba(108, 99, 255, 0.05) 100%);
            padding: 18px 20px;
            text-align: right;
            font-weight: 600;
            border-bottom: 1px solid var(--border);
        }

        .data-table td {
            padding: 16px 20px;
            text-align: right;
            border-bottom: 1px solid var(--border);
        }

        .action-buttons {
            display: flex;
            gap: 8px;
        }

        .action-btn {
            padding: 6px 14px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 13px;
            font-weight: 500;
            transition: all 0.3s;
        }

        .btn-approve {
            background: var(--gradient-primary);
            color: white;
        }

        .btn-reject {
            background: var(--gradient-accent);
            color: white;
        }

        /* Ù…Ø¯Ø§Ù„â€ŒÙ‡Ø§ */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            justify-content: center;
            align-items: center;
            z-index: 2000;
            padding: 20px;
        }

        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 24px;
            max-width: 500px;
            width: 100%;
            box-shadow: 0 25px 50px rgba(0, 0, 0, 0.25);
        }

        /* Ù†ÙˆØªÛŒÙÛŒÚ©ÛŒØ´Ù† */
        .notification {
            position: fixed;
            top: 30px;
            right: 30px;
            padding: 18px 24px;
            background: var(--gradient-dark);
            color: white;
            border-radius: 16px;
            box-shadow: 0 15px 40px rgba(0, 0, 0, 0.2);
            display: none;
            z-index: 3000;
            max-width: 350px;
        }

        .notification.success {
            background: var(--gradient-primary);
        }

        .notification.error {
            background: var(--gradient-accent);
        }

        /* ØµÙØ­Ø§Øª */
        .main-content {
            display: grid;
            grid-template-columns: 1fr 400px;
            gap: 30px;
            margin: 30px 0;
            flex: 1;
        }

        .page {
            display: none;
            background: white;
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            padding: 30px;
            margin: 30px 0;
            min-height: 500px;
        }

        .page.active {
            display: block;
        }

        .page-title {
            font-size: 28px;
            margin-bottom: 30px;
            color: var(--dark);
            display: flex;
            align-items: center;
            gap: 15px;
            padding-bottom: 20px;
            border-bottom: 2px solid var(--border);
        }

        /* ÙÙˆØªØ± */
        footer {
            background: var(--gradient-dark);
            color: white;
            padding: 50px 0 25px;
            margin-top: auto;
        }

        .footer-content {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 30px;
            margin-bottom: 30px;
        }

        @media (max-width: 1200px) {
            .main-content {
                grid-template-columns: 1fr;
            }
        }

        @media (max-width: 768px) {
            .footer-content {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <!-- ØµÙØ­Ù‡ Ø®ÙˆØ´Ø¢Ù…Ø¯Ú¯ÙˆÛŒÛŒ -->
    <div class="welcome-page" id="welcome-page">
        <div class="welcome-content">
            <div class="welcome-logo">
                <i class="fas fa-car-side"></i>
                <span>Ø§Ø³Ù†Ù¾ Ø§ÙØºØ§Ù†Ø³ØªØ§Ù†</span>
            </div>
            <h1 class="welcome-title">Ø³Ø±ÙˆÛŒØ³ ØªØ§Ú©Ø³ÛŒ Ø§ÛŒÙ†ØªØ±Ù†ØªÛŒ Ø¯Ø± Ø³Ø±Ø§Ø³Ø± Ú©Ø§Ø¨Ù„</h1>
            <p class="welcome-subtitle">Ø³Ø±ÛŒØ¹ØŒ Ù…Ø·Ù…Ø¦Ù† Ùˆ Ù…Ù‚Ø±ÙˆÙ† Ø¨Ù‡ ØµØ±ÙÙ‡</p>
            <button class="btn btn-primary" id="start-using-btn" style="padding: 18px 40px; font-size: 18px;">
                <i class="fas fa-play-circle"></i>
                Ø´Ø±ÙˆØ¹ Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø§Ø² Ø§Ø³Ù†Ù¾
            </button>
        </div>
    </div>

    <!-- Ù‡Ø¯Ø± -->
    <header style="display: none;" id="main-header">
        <div class="container nav-container">
            <a href="#" class="logo" data-page="home">
                <i class="fas fa-car-side"></i>
                <span>Ø§Ø³Ù†Ù¾ Ø§ÙØºØ§Ù†Ø³ØªØ§Ù†</span>
            </a>
            <ul class="nav-links">
                <li><a href="#" class="nav-link active" data-page="home"><i class="fas fa-home"></i> Ø®Ø§Ù†Ù‡</a></li>
                <li><a href="#" class="nav-link" data-page="my-trips"><i class="fas fa-history"></i> Ø³ÙØ±Ù‡Ø§ÛŒ Ù…Ù†</a></li>
                <li><a href="#" class="nav-link" data-page="drivers"><i class="fas fa-car"></i> Ø±Ø§Ù†Ù†Ø¯Ú¯Ø§Ù†</a></li>
                <li><a href="#" class="nav-link" data-page="trips"><i class="fas fa-road"></i> Ø³ÙØ±Ù‡Ø§</a></li>
                <li><a href="#" class="nav-link" data-page="discounts"><i class="fas fa-gift"></i> ØªØ®ÙÛŒÙÙ‡Ø§</a></li>
                <li><a href="#" class="nav-link" data-page="support"><i class="fas fa-question-circle"></i> Ù¾Ø´ØªÛŒØ¨Ø§Ù†ÛŒ</a></li>
                <li><a href="#" class="nav-link" data-page="profile"><i class="fas fa-user"></i> Ù¾Ø±ÙˆÙØ§ÛŒÙ„</a></li>
                <li><a href="#" class="nav-link" data-page="admin" id="adminLink" style="display: none;"><i class="fas fa-cog"></i> Ù…Ø¯ÛŒØ±ÛŒØª</a></li>
            </ul>
            <div class="user-actions">
                <div class="user-profile" id="userProfile" style="display: none;">
                    <div class="user-avatar" id="userAvatar">Ø§</div>
                </div>
                <button class="btn btn-outline" id="loginBtn"><i class="fas fa-user"></i> ÙˆØ±ÙˆØ¯</button>
                <button class="btn btn-outline" id="logoutBtn" style="display: none;">Ø®Ø±ÙˆØ¬</button>
            </div>
        </div>
    </header>

    <!-- Ù…Ø­ØªÙˆØ§ÛŒ Ø§ØµÙ„ÛŒ -->
    <div class="container" style="display: none;" id="main-container">
        <div class="page active" id="home-page">
            <div class="main-content">
                <div class="map-container">
                    <div id="map"></div>
                </div>
                
                <div class="ride-panel">
                    <h2 class="panel-title"><i class="fas fa-map-marker-alt"></i> Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ø³ÙØ±</h2>
                    <form id="rideForm">
                        <div class="form-group">
                            <label for="pickup">Ù…Ø¨Ø¯Ø§</label>
                            <input type="text" id="pickup" class="form-input" placeholder="Ø¢Ø¯Ø±Ø³ ÙØ¹Ù„ÛŒ Ø´Ù…Ø§" required>
                        </div>
                        <div class="form-group">
                            <label for="destination">Ù…Ù‚ØµØ¯</label>
                            <input type="text" id="destination" class="form-input" placeholder="Ù…Ø­Ù„ Ù…ÙˆØ±Ø¯ Ù†Ø¸Ø± Ø´Ù…Ø§" required>
                        </div>
                        <div class="form-group">
                            <label>Ù†ÙˆØ¹ Ø³ÙØ±</label>
                            <div class="ride-type-selector">
                                <div class="ride-type selected" data-type="economy">
                                    <div style="display: flex; align-items: center; gap: 15px;">
                                        <i class="fas fa-car" style="color: var(--primary);"></i>
                                        <span>Ø§Ù‚ØªØµØ§Ø¯ÛŒ</span>
                                    </div>
                                    <span id="economyPrice">-- Ø§ÙØºØ§Ù†ÛŒ</span>
                                </div>
                                <div class="ride-type" data-type="comfort">
                                    <div style="display: flex; align-items: center; gap: 15px;">
                                        <i class="fas fa-car-side" style="color: var(--secondary);"></i>
                                        <span>Ú©Ù„Ø§Ø³ÛŒÚ©</span>
                                    </div>
                                    <span id="comfortPrice">-- Ø§ÙØºØ§Ù†ÛŒ</span>
                                </div>
                                <div class="ride-type" data-type="bike">
                                    <div style="display: flex; align-items: center; gap: 15px;">
                                        <i class="fas fa-motorcycle" style="color: var(--accent);"></i>
                                        <span>Ù…ÙˆØªÙˆØ±</span>
                                    </div>
                                    <span id="bikePrice">-- Ø§ÙØºØ§Ù†ÛŒ</span>
                                </div>
                            </div>
                        </div>
                        <button type="submit" class="submit-btn" id="submitBtn">
                            <i class="fas fa-search"></i>
                            Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ø®ÙˆØ¯Ø±Ùˆ
                        </button>
                    </form>
                </div>
            </div>
        </div>

        <!-- ØµÙØ­Ù‡ Ø±Ø§Ù†Ù†Ø¯Ú¯Ø§Ù† -->
        <div class="page" id="drivers-page">
            <h2 class="page-title"><i class="fas fa-car"></i> Ù…Ø¯ÛŒØ±ÛŒØª Ø±Ø§Ù†Ù†Ø¯Ú¯Ø§Ù†</h2>
            <div class="table-container">
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>Ù†Ø§Ù…</th>
                            <th>Ø´Ù…Ø§Ø±Ù‡ ØªÙ…Ø§Ø³</th>
                            <th>Ù†ÙˆØ¹ ÙˆØ³ÛŒÙ„Ù‡</th>
                            <th>Ù…Ø¯Ù„ Ø®ÙˆØ¯Ø±Ùˆ</th>
                            <th>Ù¾Ù„Ø§Ú©</th>
                            <th>ÙˆØ¶Ø¹ÛŒØª</th>
                            <th>Ø¹Ù…Ù„ÛŒØ§Øª</th>
                        </tr>
                    </thead>
                    <tbody id="driversTable">
                        <!-- Ù„ÛŒØ³Øª Ø±Ø§Ù†Ù†Ø¯Ú¯Ø§Ù† -->
                    </tbody>
                </table>
            </div>
            <button class="btn btn-primary" id="addDriverBtn" style="margin-top: 20px;">
                <i class="fas fa-user-plus"></i>
                Ø§ÙØ²ÙˆØ¯Ù† Ø±Ø§Ù†Ù†Ø¯Ù‡ Ø¬Ø¯ÛŒØ¯
            </button>
            <button class="btn btn-outline" id="exportDriversBtn" style="margin-top: 20px; margin-right: 10px;">
                <i class="fas fa-download"></i>
                Ø®Ø±ÙˆØ¬ÛŒ Excel
            </button>
        </div>

        <!-- ØµÙØ­Ù‡ Ø³ÙØ±Ù‡Ø§ -->
        <div class="page" id="trips-page">
            <h2 class="page-title"><i class="fas fa-road"></i> Ù…Ø¯ÛŒØ±ÛŒØª Ø³ÙØ±Ù‡Ø§</h2>
            <div class="table-container">
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>ØªØ§Ø±ÛŒØ®</th>
                            <th>Ù…Ø³Ø§ÙØ±</th>
                            <th>Ù…Ø¨Ø¯Ø§</th>
                            <th>Ù…Ù‚ØµØ¯</th>
                            <th>Ø±Ø§Ù†Ù†Ø¯Ù‡</th>
                            <th>Ù‡Ø²ÛŒÙ†Ù‡</th>
                            <th>ÙˆØ¶Ø¹ÛŒØª</th>
                            <th>Ø¹Ù…Ù„ÛŒØ§Øª</th>
                        </tr>
                    </thead>
                    <tbody id="tripsTable">
                        <!-- Ù„ÛŒØ³Øª Ø³ÙØ±Ù‡Ø§ -->
                    </tbody>
                </table>
            </div>
            <button class="btn btn-outline" id="exportTripsBtn" style="margin-top: 20px;">
                <i class="fas fa-download"></i>
                Ø®Ø±ÙˆØ¬ÛŒ Excel
            </button>
        </div>

        <!-- ØµÙØ­Ù‡ ØªØ®ÙÛŒÙâ€ŒÙ‡Ø§ -->
        <div class="page" id="discounts-page">
            <h2 class="page-title"><i class="fas fa-gift"></i> Ù…Ø¯ÛŒØ±ÛŒØª ØªØ®ÙÛŒÙâ€ŒÙ‡Ø§</h2>
            <div class="table-container">
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>Ú©Ø¯ ØªØ®ÙÛŒÙ</th>
                            <th>Ø¯Ø±ØµØ¯ ØªØ®ÙÛŒÙ</th>
                            <th>ØªØ§Ø±ÛŒØ® Ø§Ù†Ù‚Ø¶Ø§</th>
                            <th>Ø­Ø¯Ø§Ú©Ø«Ø± Ø§Ø³ØªÙØ§Ø¯Ù‡</th>
                            <th>Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø´Ø¯Ù‡</th>
                            <th>Ø¹Ù…Ù„ÛŒØ§Øª</th>
                        </tr>
                    </thead>
                    <tbody id="discountsTable">
                        <!-- Ù„ÛŒØ³Øª ØªØ®ÙÛŒÙâ€ŒÙ‡Ø§ -->
                    </tbody>
                </table>
            </div>
            <button class="btn btn-primary" id="addDiscountBtn" style="margin-top: 20px;">
                <i class="fas fa-plus-circle"></i>
                Ø§ÙØ²ÙˆØ¯Ù† ØªØ®ÙÛŒÙ Ø¬Ø¯ÛŒØ¯
            </button>
        </div>

        <!-- ØµÙØ­Ù‡ Ù¾Ø´ØªÛŒØ¨Ø§Ù†ÛŒ -->
        <div class="page" id="support-page">
            <h2 class="page-title"><i class="fas fa-question-circle"></i> Ù…Ø¯ÛŒØ±ÛŒØª Ù¾Ø´ØªÛŒØ¨Ø§Ù†ÛŒ</h2>
            <div class="table-container">
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>Ú©Ø§Ø±Ø¨Ø±</th>
                            <th>Ù…ÙˆØ¶ÙˆØ¹</th>
                            <th>Ù¾ÛŒØ§Ù…</th>
                            <th>ØªØ§Ø±ÛŒØ®</th>
                            <th>ÙˆØ¶Ø¹ÛŒØª</th>
                            <th>Ø¹Ù…Ù„ÛŒØ§Øª</th>
                        </tr>
                    </thead>
                    <tbody id="supportTable">
                        <!-- Ù„ÛŒØ³Øª Ø¯Ø±Ø®ÙˆØ§Ø³Øªâ€ŒÙ‡Ø§ÛŒ Ù¾Ø´ØªÛŒØ¨Ø§Ù†ÛŒ -->
                    </tbody>
                </table>
            </div>
        </div>

        <!-- ØµÙØ­Ù‡ Ù¾Ø±ÙˆÙØ§ÛŒÙ„ -->
        <div class="page" id="profile-page">
            <h2 class="page-title"><i class="fas fa-user"></i> Ù¾Ø±ÙˆÙØ§ÛŒÙ„</h2>
            <div id="profileContent">
                <!-- Ù…Ø­ØªÙˆØ§ÛŒ Ù¾Ø±ÙˆÙØ§ÛŒÙ„ -->
            </div>
        </div>

        <!-- ØµÙØ­Ù‡ Ù…Ø¯ÛŒØ±ÛŒØª -->
        <div class="page" id="admin-page">
            <h2 class="page-title"><i class="fas fa-cog"></i> Ù¾Ù†Ù„ Ù…Ø¯ÛŒØ±ÛŒØª</h2>
            <div id="adminContent">
                <!-- Ù…Ø­ØªÙˆØ§ÛŒ Ù…Ø¯ÛŒØ±ÛŒØª -->
            </div>
        </div>
    </div>

    <!-- Ù…Ø¯Ø§Ù„ Ø±Ø§Ù†Ù†Ø¯Ù‡ -->
    <div class="modal" id="driverModal">
        <div class="modal-content">
            <h2 style="margin-bottom: 20px;">Ø±Ø§Ù†Ù†Ø¯Ù‡ Ù¾ÛŒØ¯Ø§ Ø´Ø¯!</h2>
            <div id="driverInfo">
                <!-- Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø±Ø§Ù†Ù†Ø¯Ù‡ -->
            </div>
            <button class="btn btn-primary" id="confirmRide" style="width: 100%; margin-top: 20px;">
                ØªØ£ÛŒÛŒØ¯ Ø³ÙØ±
            </button>
        </div>
    </div>

    <!-- Ù†ÙˆØªÛŒÙÛŒÚ©ÛŒØ´Ù† -->
    <div class="notification" id="notification"></div>

    <!-- ÙÙˆØªØ± -->
    <footer style="display: none;" id="main-footer">
        <div class="container">
            <div class="footer-content">
                <div>
                    <h3>Ø§Ø³Ù†Ù¾ Ø§ÙØºØ§Ù†Ø³ØªØ§Ù†</h3>
                    <p>Ø³Ø±ÙˆÛŒØ³ ØªØ§Ú©Ø³ÛŒ Ø§ÛŒÙ†ØªØ±Ù†ØªÛŒ Ø¯Ø± Ú©Ø§Ø¨Ù„</p>
                </div>
                <div>
                    <h3>ØªÙ…Ø§Ø³ Ø¨Ø§ Ù…Ø§</h3>
                    <p>Ø´Ù…Ø§Ø±Ù‡: Û°Û·Û°Û°Û±Û²Û³Û´ÛµÛ¶</p>
                </div>
            </div>
            <div style="text-align: center; padding-top: 25px; border-top: 1px solid rgba(255, 255, 255, 0.1);">
                <p>Â© Û±Û´Û°Û³ Ø§Ø³Ù†Ù¾ Ø§ÙØºØ§Ù†Ø³ØªØ§Ù†</p>
            </div>
        </div>
    </footer>

    <script>
        // ØªÙ†Ø¸ÛŒÙ…Ø§Øª Supabase
        const SUPABASE_URL = 'https://ewzgpfpllwhhrjupqyvy.supabase.co';
        const SUPABASE_KEY = 'sb_secret_muUrFpyuPZkgm2Nd8gbblA_ovzxgAbc';
        
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        // Ù…ØªØºÛŒØ±Ù‡Ø§ÛŒ Ø³ÛŒØ³ØªÙ…
        let currentUser = null;
        let isAdmin = false;
        let map = null;
        let currentTrip = null;
        let markers = [];
        let trackingInterval = null;
        let selectedRideType = 'economy';

        // ØªÙˆØ§Ø¨Ø¹ Ú©Ù…Ú©ÛŒ
        function showNotification(message, type = 'success') {
            const notification = document.getElementById('notification');
            notification.textContent = message;
            notification.className = `notification ${type}`;
            notification.style.display = 'block';
            
            setTimeout(() => {
                notification.style.display = 'none';
            }, 5000);
        }

        // Ù…Ø¯ÛŒØ±ÛŒØª Ù†Ù‚Ø´Ù‡
        function initMap() {
            map = L.map('map').setView([34.5553, 69.2075], 13); // Ù…Ø®ØªØµØ§Øª Ú©Ø§Ø¨Ù„
            
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: 'Â© OpenStreetMap contributors'
            }).addTo(map);

            // Ø§Ø¶Ø§ÙÙ‡ Ú©Ø±Ø¯Ù† Ù†Ø´Ø§Ù†Ú¯Ø±Ù‡Ø§ÛŒ Ø§ÙˆÙ„ÛŒÙ‡
            addKabulLandmarks();
            loadActiveDrivers();
        }

        function addKabulLandmarks() {
            const landmarks = [
                { name: "Ù…ÛŒØ¯Ø§Ù† Ù‡ÙˆØ§ÛŒÛŒ", lat: 34.5658, lng: 69.2124 },
                { name: "Ú©Ø§Ø±ØªÙ‡ Ø³Ø®ÛŒ", lat: 34.5311, lng: 69.1729 },
                { name: "Ø´Ù‡Ø± Ù†Ùˆ", lat: 34.5266, lng: 69.1833 },
                { name: "Ø¯Ø´Øª Ø¨Ø±Ú†ÛŒ", lat: 34.4730, lng: 69.1194 },
                { name: "ÙˆØ²Ø§Ø±Øª Ø§Ù…ÙˆØ± Ø®Ø§Ø±Ø¬Ù‡", lat: 34.5308, lng: 69.1617 }
            ];

            landmarks.forEach(landmark => {
                L.marker([landmark.lat, landmark.lng])
                    .addTo(map)
                    .bindPopup(landmark.name);
            });
        }

        async function loadActiveDrivers() {
            try {
                const { data: drivers, error } = await supabase
                    .from('drivers')
                    .select('*')
                    .eq('status', 'active');

                if (error) throw error;

                // Ø­Ø°Ù Ù†Ø´Ø§Ù†Ú¯Ø±Ù‡Ø§ÛŒ Ù‚Ø¨Ù„ÛŒ
                markers.forEach(marker => map.removeLayer(marker));
                markers = [];

                // Ø§Ø¶Ø§ÙÙ‡ Ú©Ø±Ø¯Ù† Ø±Ø§Ù†Ù†Ø¯Ú¯Ø§Ù† Ø¨Ù‡ Ù†Ù‚Ø´Ù‡
                drivers.forEach(driver => {
                    if (driver.current_location) {
                        const icon = driver.vehicle_type === 'bike' ? 
                            L.divIcon({ className: 'bike-marker', html: 'ğŸï¸' }) :
                            L.divIcon({ className: 'car-marker', html: 'ğŸš—' });
                        
                        const marker = L.marker(
                            [driver.current_location.lat, driver.current_location.lng],
                            { icon }
                        ).addTo(map);
                        
                        marker.bindPopup(`${driver.name} - ${driver.car_model || 'Ù…ÙˆØªÙˆØ±'}`);
                        markers.push(marker);
                    }
                });
            } catch (error) {
                console.error('Error loading drivers:', error);
            }
        }

        // Ù…Ø¯ÛŒØ±ÛŒØª Ú©Ø§Ø±Ø¨Ø±Ø§Ù†
        async function checkAuth() {
            const { data: { user }, error } = await supabase.auth.getUser();
            
            if (user) {
                currentUser = user;
                await loadUserProfile();
            }
            
            updateUI();
        }

        async function loadUserProfile() {
            try {
                const { data: profile, error } = await supabase
                    .from('profiles')
                    .select('*')
                    .eq('id', currentUser.id)
                    .single();

                if (!error && profile) {
                    currentUser.profile = profile;
                    isAdmin = profile.role === 'admin';
                }
            } catch (error) {
                console.error('Error loading profile:', error);
            }
        }

        function updateUI() {
            const welcomePage = document.getElementById('welcome-page');
            const mainHeader = document.getElementById('main-header');
            const mainContainer = document.getElementById('main-container');
            const mainFooter = document.getElementById('main-footer');
            const loginBtn = document.getElementById('loginBtn');
            const logoutBtn = document.getElementById('logoutBtn');
            const userProfile = document.getElementById('userProfile');
            const userAvatar = document.getElementById('userAvatar');
            const adminLink = document.getElementById('adminLink');

            if (currentUser) {
                welcomePage.style.display = 'none';
                mainHeader.style.display = 'block';
                mainContainer.style.display = 'block';
                mainFooter.style.display = 'block';
                loginBtn.style.display = 'none';
                logoutBtn.style.display = 'block';
                userProfile.style.display = 'flex';
                
                if (userAvatar && currentUser.profile) {
                    userAvatar.textContent = currentUser.profile.name.charAt(0);
                }
                
                if (isAdmin && adminLink) {
                    adminLink.style.display = 'block';
                }
                
                if (!map) initMap();
            } else {
                welcomePage.style.display = 'flex';
                mainHeader.style.display = 'none';
                mainContainer.style.display = 'none';
                mainFooter.style.display = 'none';
                loginBtn.style.display = 'block';
                logoutBtn.style.display = 'none';
                userProfile.style.display = 'none';
                
                if (adminLink) adminLink.style.display = 'none';
            }
        }

        // Ù…Ø¯ÛŒØ±ÛŒØª Ø±Ø§Ù†Ù†Ø¯Ú¯Ø§Ù†
        async function loadDrivers() {
            try {
                const { data: drivers, error } = await supabase
                    .from('drivers')
                    .select('*')
                    .order('created_at', { ascending: false });

                if (error) throw error;

                const driversTable = document.getElementById('driversTable');
                driversTable.innerHTML = '';

                drivers.forEach(driver => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${driver.name}</td>
                        <td>${driver.phone}</td>
                        <td>${driver.vehicle_type === 'car' ? 'Ø®ÙˆØ¯Ø±Ùˆ' : 'Ù…ÙˆØªÙˆØ±'}</td>
                        <td>${driver.car_model || '---'}</td>
                        <td>${driver.plate_number || '---'}</td>
                        <td>
                            <span style="padding: 4px 12px; border-radius: 20px; background: ${driver.status === 'active' ? '#4CAF50' : '#f44336'}; color: white;">
                                ${driver.status === 'active' ? 'ÙØ¹Ø§Ù„' : 'ØºÛŒØ±ÙØ¹Ø§Ù„'}
                            </span>
                        </td>
                        <td class="action-buttons">
                            <button class="action-btn btn-approve" onclick="toggleDriverStatus('${driver.id}', '${driver.status}')">
                                ${driver.status === 'active' ? 'ØºÛŒØ±ÙØ¹Ø§Ù„' : 'ÙØ¹Ø§Ù„'}
                            </button>
                            <button class="action-btn btn-reject" onclick="deleteDriver('${driver.id}')">
                                Ø­Ø°Ù
                            </button>
                        </td>
                    `;
                    driversTable.appendChild(row);
                });
            } catch (error) {
                console.error('Error loading drivers:', error);
                showNotification('Ø®Ø·Ø§ Ø¯Ø± Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ø±Ø§Ù†Ù†Ø¯Ú¯Ø§Ù†', 'error');
            }
        }

        async function toggleDriverStatus(driverId, currentStatus) {
            try {
                const newStatus = currentStatus === 'active' ? 'inactive' : 'active';
                
                const { error } = await supabase
                    .from('drivers')
                    .update({ status: newStatus })
                    .eq('id', driverId);

                if (error) throw error;

                showNotification(`ÙˆØ¶Ø¹ÛŒØª Ø±Ø§Ù†Ù†Ø¯Ù‡ ØªØºÛŒÛŒØ± Ú©Ø±Ø¯ Ø¨Ù‡: ${newStatus === 'active' ? 'ÙØ¹Ø§Ù„' : 'ØºÛŒØ±ÙØ¹Ø§Ù„'}`, 'success');
                await loadDrivers();
                await loadActiveDrivers();
            } catch (error) {
                console.error('Error toggling driver status:', error);
                showNotification('Ø®Ø·Ø§ Ø¯Ø± ØªØºÛŒÛŒØ± ÙˆØ¶Ø¹ÛŒØª Ø±Ø§Ù†Ù†Ø¯Ù‡', 'error');
            }
        }

        async function deleteDriver(driverId) {
            if (!confirm('Ø¢ÛŒØ§ Ø§Ø² Ø­Ø°Ù Ø§ÛŒÙ† Ø±Ø§Ù†Ù†Ø¯Ù‡ Ù…Ø·Ù…Ø¦Ù† Ù‡Ø³ØªÛŒØ¯ØŸ')) return;

            try {
                const { error } = await supabase
                    .from('drivers')
                    .delete()
                    .eq('id', driverId);

                if (error) throw error;

                showNotification('Ø±Ø§Ù†Ù†Ø¯Ù‡ Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø­Ø°Ù Ø´Ø¯', 'success');
                await loadDrivers();
                await loadActiveDrivers();
            } catch (error) {
                console.error('Error deleting driver:', error);
                showNotification('Ø®Ø·Ø§ Ø¯Ø± Ø­Ø°Ù Ø±Ø§Ù†Ù†Ø¯Ù‡', 'error');
            }
        }

        async function exportDriversToExcel() {
            try {
                const { data: drivers, error } = await supabase
                    .from('drivers')
                    .select('*');

                if (error) throw error;

                const ws = XLSX.utils.json_to_sheet(drivers.map(d => ({
                    Ù†Ø§Ù…: d.name,
                    'Ø´Ù…Ø§Ø±Ù‡ ØªÙ…Ø§Ø³': d.phone,
                    'Ù†ÙˆØ¹ ÙˆØ³ÛŒÙ„Ù‡': d.vehicle_type === 'car' ? 'Ø®ÙˆØ¯Ø±Ùˆ' : 'Ù…ÙˆØªÙˆØ±',
                    'Ù…Ø¯Ù„ Ø®ÙˆØ¯Ø±Ùˆ': d.car_model || '',
                    Ù¾Ù„Ø§Ú©: d.plate_number || '',
                    ÙˆØ¶Ø¹ÛŒØª: d.status === 'active' ? 'ÙØ¹Ø§Ù„' : 'ØºÛŒØ±ÙØ¹Ø§Ù„',
                    'ØªØ§Ø±ÛŒØ® Ø«Ø¨Øª': new Date(d.created_at).toLocaleDateString('fa-IR')
                })));

                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, 'Ø±Ø§Ù†Ù†Ø¯Ú¯Ø§Ù†');
                XLSX.writeFile(wb, 'Ø±Ø§Ù†Ù†Ø¯Ú¯Ø§Ù†_Ø§Ø³Ù†Ù¾.xlsx');
                
                showNotification('ÙØ§ÛŒÙ„ Excel Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø¯Ø§Ù†Ù„ÙˆØ¯ Ø´Ø¯', 'success');
            } catch (error) {
                console.error('Error exporting drivers:', error);
                showNotification('Ø®Ø·Ø§ Ø¯Ø± Ø®Ø±ÙˆØ¬ÛŒ Excel', 'error');
            }
        }

        // Ù…Ø¯ÛŒØ±ÛŒØª Ø³ÙØ±Ù‡Ø§
        async function loadTrips() {
            try {
                let query = supabase
                    .from('trips')
                    .select(`
                        *,
                        passenger:profiles!trips_passenger_id_fkey(name),
                        driver:profiles!trips_driver_id_fkey(name)
                    `)
                    .order('created_at', { ascending: false });

                // Ø§Ú¯Ø± Ú©Ø§Ø±Ø¨Ø± Ø§Ø¯Ù…ÛŒÙ† Ù†ÛŒØ³ØªØŒ ÙÙ‚Ø· Ø³ÙØ±Ù‡Ø§ÛŒ Ø®ÙˆØ¯Ø´ Ø±Ø§ Ø¨Ø¨ÛŒÙ†Ø¯
                if (!isAdmin && currentUser) {
                    query = query.eq('passenger_id', currentUser.id);
                }

                const { data: trips, error } = await query;

                if (error) throw error;

                const tripsTable = document.getElementById('tripsTable');
                tripsTable.innerHTML = '';

                trips.forEach(trip => {
                    const row = document.createElement('tr');
                    const date = new Date(trip.created_at).toLocaleDateString('fa-IR');
                    const statusText = {
                        'requested': 'Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ø´Ø¯Ù‡',
                        'accepted': 'Ù¾Ø°ÛŒØ±ÙØªÙ‡ Ø´Ø¯Ù‡',
                        'started': 'Ø´Ø±ÙˆØ¹ Ø´Ø¯Ù‡',
                        'completed': 'ØªÚ©Ù…ÛŒÙ„ Ø´Ø¯Ù‡',
                        'cancelled': 'Ù„ØºÙˆ Ø´Ø¯Ù‡'
                    }[trip.status] || trip.status;

                    row.innerHTML = `
                        <td>${date}</td>
                        <td>${trip.passenger?.name || '---'}</td>
                        <td>${trip.pickup_address}</td>
                        <td>${trip.destination_address}</td>
                        <td>${trip.driver?.name || '---'}</td>
                        <td>${trip.fee || 0} Ø§ÙØºØ§Ù†ÛŒ</td>
                        <td>
                            <span style="padding: 4px 12px; border-radius: 20px; background: ${getStatusColor(trip.status)}; color: white;">
                                ${statusText}
                            </span>
                        </td>
                        <td class="action-buttons">
                            ${trip.status === 'requested' ? 
                                `<button class="action-btn btn-approve" onclick="acceptTrip('${trip.id}')">Ù¾Ø°ÛŒØ±Ø´</button>` : ''}
                            ${trip.status === 'started' ? 
                                `<button class="action-btn btn-approve" onclick="completeTrip('${trip.id}')">ØªÚ©Ù…ÛŒÙ„</button>` : ''}
                            ${trip.status !== 'completed' && trip.status !== 'cancelled' ? 
                                `<button class="action-btn btn-reject" onclick="cancelTrip('${trip.id}')">Ù„ØºÙˆ</button>` : ''}
                        </td>
                    `;
                    tripsTable.appendChild(row);
                });
            } catch (error) {
                console.error('Error loading trips:', error);
                showNotification('Ø®Ø·Ø§ Ø¯Ø± Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ø³ÙØ±Ù‡Ø§', 'error');
            }
        }

        function getStatusColor(status) {
            const colors = {
                'requested': '#FF9800',
                'accepted': '#2196F3',
                'started': '#4CAF50',
                'completed': '#8BC34A',
                'cancelled': '#f44336'
            };
            return colors[status] || '#9E9E9E';
        }

        async function acceptTrip(tripId) {
            try {
                const { error } = await supabase
                    .from('trips')
                    .update({ 
                        status: 'accepted',
                        accepted_at: new Date().toISOString()
                    })
                    .eq('id', tripId);

                if (error) throw error;

                showNotification('Ø³ÙØ± Ù¾Ø°ÛŒØ±ÙØªÙ‡ Ø´Ø¯', 'success');
                await loadTrips();
            } catch (error) {
                console.error('Error accepting trip:', error);
                showNotification('Ø®Ø·Ø§ Ø¯Ø± Ù¾Ø°ÛŒØ±Ø´ Ø³ÙØ±', 'error');
            }
        }

        async function completeTrip(tripId) {
            try {
                const { error } = await supabase
                    .from('trips')
                    .update({ 
                        status: 'completed',
                        completed_at: new Date().toISOString()
                    })
                    .eq('id', tripId);

                if (error) throw error;

                showNotification('Ø³ÙØ± ØªÚ©Ù…ÛŒÙ„ Ø´Ø¯', 'success');
                await loadTrips();
            } catch (error) {
                console.error('Error completing trip:', error);
                showNotification('Ø®Ø·Ø§ Ø¯Ø± ØªÚ©Ù…ÛŒÙ„ Ø³ÙØ±', 'error');
            }
        }

        async function cancelTrip(tripId) {
            if (!confirm('Ø¢ÛŒØ§ Ø§Ø² Ù„ØºÙˆ Ø§ÛŒÙ† Ø³ÙØ± Ù…Ø·Ù…Ø¦Ù† Ù‡Ø³ØªÛŒØ¯ØŸ')) return;

            try {
                const { error } = await supabase
                    .from('trips')
                    .update({ 
                        status: 'cancelled',
                        cancelled_at: new Date().toISOString()
                    })
                    .eq('id', tripId);

                if (error) throw error;

                showNotification('Ø³ÙØ± Ù„ØºÙˆ Ø´Ø¯', 'success');
                await loadTrips();
            } catch (error) {
                console.error('Error cancelling trip:', error);
                showNotification('Ø®Ø·Ø§ Ø¯Ø± Ù„ØºÙˆ Ø³ÙØ±', 'error');
            }
        }

        async function exportTripsToExcel() {
            try {
                const { data: trips, error } = await supabase
                    .from('trips')
                    .select(`
                        *,
                        passenger:profiles!trips_passenger_id_fkey(name),
                        driver:profiles!trips_driver_id_fkey(name)
                    `);

                if (error) throw error;

                const ws = XLSX.utils.json_to_sheet(trips.map(t => ({
                    ØªØ§Ø±ÛŒØ®: new Date(t.created_at).toLocaleDateString('fa-IR'),
                    Ù…Ø³Ø§ÙØ±: t.passenger?.name || '',
                    Ù…Ø¨Ø¯Ø§: t.pickup_address,
                    Ù…Ù‚ØµØ¯: t.destination_address,
                    Ø±Ø§Ù†Ù†Ø¯Ù‡: t.driver?.name || '',
                    Ù‡Ø²ÛŒÙ†Ù‡: t.fee || 0,
                    ÙˆØ¶Ø¹ÛŒØª: {
                        'requested': 'Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ø´Ø¯Ù‡',
                        'accepted': 'Ù¾Ø°ÛŒØ±ÙØªÙ‡ Ø´Ø¯Ù‡',
                        'started': 'Ø´Ø±ÙˆØ¹ Ø´Ø¯Ù‡',
                        'completed': 'ØªÚ©Ù…ÛŒÙ„ Ø´Ø¯Ù‡',
                        'cancelled': 'Ù„ØºÙˆ Ø´Ø¯Ù‡'
                    }[t.status] || t.status
                })));

                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, 'Ø³ÙØ±Ù‡Ø§');
                XLSX.writeFile(wb, 'Ø³ÙØ±Ù‡Ø§ÛŒ_Ø§Ø³Ù†Ù¾.xlsx');
                
                showNotification('ÙØ§ÛŒÙ„ Excel Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø¯Ø§Ù†Ù„ÙˆØ¯ Ø´Ø¯', 'success');
            } catch (error) {
                console.error('Error exporting trips:', error);
                showNotification('Ø®Ø·Ø§ Ø¯Ø± Ø®Ø±ÙˆØ¬ÛŒ Excel', 'error');
            }
        }

        // Ù…Ø¯ÛŒØ±ÛŒØª ØªØ®ÙÛŒÙâ€ŒÙ‡Ø§
        async function loadDiscounts() {
            try {
                const { data: discounts, error } = await supabase
                    .from('discounts')
                    .select('*')
                    .order('created_at', { ascending: false });

                if (error) throw error;

                const discountsTable = document.getElementById('discountsTable');
                discountsTable.innerHTML = '';

                discounts.forEach(discount => {
                    const row = document.createElement('tr');
                    const expiryDate = new Date(discount.expiry_date).toLocaleDateString('fa-IR');
                    const isExpired = new Date(discount.expiry_date) < new Date();

                    row.innerHTML = `
                        <td>${discount.code}</td>
                        <td>${discount.percentage}%</td>
                        <td>${expiryDate}</td>
                        <td>${discount.max_uses}</td>
                        <td>${discount.used_count || 0}</td>
                        <td class="action-buttons">
                            <button class="action-btn btn-reject" onclick="deleteDiscount('${discount.id}')">
                                Ø­Ø°Ù
                            </button>
                        </td>
                    `;
                    discountsTable.appendChild(row);
                });
            } catch (error) {
                console.error('Error loading discounts:', error);
                showNotification('Ø®Ø·Ø§ Ø¯Ø± Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ ØªØ®ÙÛŒÙâ€ŒÙ‡Ø§', 'error');
            }
        }

        async function deleteDiscount(discountId) {
            if (!confirm('Ø¢ÛŒØ§ Ø§Ø² Ø­Ø°Ù Ø§ÛŒÙ† ØªØ®ÙÛŒÙ Ù…Ø·Ù…Ø¦Ù† Ù‡Ø³ØªÛŒØ¯ØŸ')) return;

            try {
                const { error } = await supabase
                    .from('discounts')
                    .delete()
                    .eq('id', discountId);

                if (error) throw error;

                showNotification('ØªØ®ÙÛŒÙ Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø­Ø°Ù Ø´Ø¯', 'success');
                await loadDiscounts();
            } catch (error) {
                console.error('Error deleting discount:', error);
                showNotification('Ø®Ø·Ø§ Ø¯Ø± Ø­Ø°Ù ØªØ®ÙÛŒÙ', 'error');
            }
        }

        // Ù…Ø¯ÛŒØ±ÛŒØª Ù¾Ø´ØªÛŒØ¨Ø§Ù†ÛŒ
        async function loadSupportTickets() {
            try {
                const { data: tickets, error } = await supabase
                    .from('support_tickets')
                    .select(`
                        *,
                        user:profiles!support_tickets_user_id_fkey(name)
                    `)
                    .order('created_at', { ascending: false });

                if (error) throw error;

                const supportTable = document.getElementById('supportTable');
                supportTable.innerHTML = '';

                tickets.forEach(ticket => {
                    const row = document.createElement('tr');
                    const date = new Date(ticket.created_at).toLocaleDateString('fa-IR');
                    const statusText = {
                        'open': 'Ø¨Ø§Ø²',
                        'in_progress': 'Ø¯Ø± Ø¯Ø³Øª Ø¨Ø±Ø±Ø³ÛŒ',
                        'closed': 'Ø¨Ø³ØªÙ‡ Ø´Ø¯Ù‡'
                    }[ticket.status] || ticket.status;

                    row.innerHTML = `
                        <td>${ticket.user?.name || '---'}</td>
                        <td>${ticket.subject}</td>
                        <td>${ticket.message.substring(0, 50)}${ticket.message.length > 50 ? '...' : ''}</td>
                        <td>${date}</td>
                        <td>
                            <span style="padding: 4px 12px; border-radius: 20px; background: ${ticket.status === 'closed' ? '#4CAF50' : '#FF9800'}; color: white;">
                                ${statusText}
                            </span>
                        </td>
                        <td class="action-buttons">
                            ${ticket.status !== 'closed' ? 
                                `<button class="action-btn btn-approve" onclick="updateTicketStatus('${ticket.id}', 'closed')">Ø¨Ø³ØªÙ†</button>` :
                                `<button class="action-btn btn-approve" onclick="updateTicketStatus('${ticket.id}', 'open')">Ø¨Ø§Ø²Ú¯Ø´Ø§ÛŒÛŒ</button>`}
                        </td>
                    `;
                    supportTable.appendChild(row);
                });
            } catch (error) {
                console.error('Error loading support tickets:', error);
                showNotification('Ø®Ø·Ø§ Ø¯Ø± Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ø¯Ø±Ø®ÙˆØ§Ø³Øªâ€ŒÙ‡Ø§ÛŒ Ù¾Ø´ØªÛŒØ¨Ø§Ù†ÛŒ', 'error');
            }
        }

        async function updateTicketStatus(ticketId, status) {
            try {
                const { error } = await supabase
                    .from('support_tickets')
                    .update({ status })
                    .eq('id', ticketId);

                if (error) throw error;

                showNotification(`ÙˆØ¶Ø¹ÛŒØª ØªÛŒÚ©Øª Ø¨Ù‡ "${status === 'closed' ? 'Ø¨Ø³ØªÙ‡ Ø´Ø¯Ù‡' : 'Ø¨Ø§Ø²'}" ØªØºÛŒÛŒØ± Ú©Ø±Ø¯`, 'success');
                await loadSupportTickets();
            } catch (error) {
                console.error('Error updating ticket status:', error);
                showNotification('Ø®Ø·Ø§ Ø¯Ø± Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ ÙˆØ¶Ø¹ÛŒØª ØªÛŒÚ©Øª', 'error');
            }
        }

        // Ù…Ø¯ÛŒØ±ÛŒØª Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ø³ÙØ±
        async function requestRide(pickup, destination, rideType) {
            if (!currentUser) {
                showNotification('Ù„Ø·ÙØ§Ù‹ Ø§Ø¨ØªØ¯Ø§ ÙˆØ§Ø±Ø¯ Ø­Ø³Ø§Ø¨ Ú©Ø§Ø±Ø¨Ø±ÛŒ Ø®ÙˆØ¯ Ø´ÙˆÛŒØ¯', 'error');
                return;
            }

            try {
                // Ù…Ø­Ø§Ø³Ø¨Ù‡ Ù‚ÛŒÙ…Øª
                const fee = calculateFee(rideType, 5); // 5km ÙØ§ØµÙ„Ù‡ ÙØ±Ø¶ÛŒ

                // Ø§ÛŒØ¬Ø§Ø¯ Ø³ÙØ±
                const { data: trip, error } = await supabase
                    .from('trips')
                    .insert([{
                        passenger_id: currentUser.id,
                        pickup_address: pickup,
                        destination_address: destination,
                        ride_type: rideType,
                        fee: fee,
                        status: 'requested'
                    }])
                    .select()
                    .single();

                if (error) throw error;

                currentTrip = trip;
                showNotification('Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ø³ÙØ± Ø«Ø¨Øª Ø´Ø¯. Ø¯Ø± Ø­Ø§Ù„ ÛŒØ§ÙØªÙ† Ø±Ø§Ù†Ù†Ø¯Ù‡...', 'success');
                
                // Ø´Ø¨ÛŒÙ‡â€ŒØ³Ø§Ø²ÛŒ ÛŒØ§ÙØªÙ† Ø±Ø§Ù†Ù†Ø¯Ù‡
                setTimeout(() => findDriverForTrip(trip.id), 2000);
                
            } catch (error) {
                console.error('Error requesting ride:', error);
                showNotification('Ø®Ø·Ø§ Ø¯Ø± Ø«Ø¨Øª Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ø³ÙØ±', 'error');
            }
        }

        function calculateFee(rideType, distance) {
            const baseFares = {
                'economy': 50,
                'comfort': 80,
                'bike': 30
            };
            
            const perKm = {
                'economy': 5,
                'comfort': 8,
                'bike': 3
            };
            
            return baseFares[rideType] + (distance * perKm[rideType]);
        }

        async function findDriverForTrip(tripId) {
            try {
                // ÛŒØ§ÙØªÙ† Ù†Ø²Ø¯ÛŒÚ©â€ŒØªØ±ÛŒÙ† Ø±Ø§Ù†Ù†Ø¯Ù‡
                const { data: drivers, error } = await supabase
                    .from('drivers')
                    .select('*')
                    .eq('status', 'active')
                    .eq('vehicle_type', selectedRideType === 'bike' ? 'bike' : 'car')
                    .limit(1);

                if (error || drivers.length === 0) {
                    showNotification('Ù‡ÛŒÚ† Ø±Ø§Ù†Ù†Ø¯Ù‡â€ŒØ§ÛŒ Ø¯Ø± Ø¯Ø³ØªØ±Ø³ Ù†ÛŒØ³Øª. Ù„Ø·ÙØ§Ù‹ Ø¨Ø¹Ø¯Ø§Ù‹ ØªÙ„Ø§Ø´ Ú©Ù†ÛŒØ¯.', 'error');
                    return;
                }

                const driver = drivers[0];
                
                // Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ø³ÙØ± Ø¨Ø§ Ø±Ø§Ù†Ù†Ø¯Ù‡
                const { error: updateError } = await supabase
                    .from('trips')
                    .update({
                        driver_id: driver.id,
                        status: 'accepted',
                        accepted_at: new Date().toISOString()
                    })
                    .eq('id', tripId);

                if (updateError) throw updateError;

                // Ù†Ù…Ø§ÛŒØ´ Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø±Ø§Ù†Ù†Ø¯Ù‡
                showDriverInfo(driver);
                
            } catch (error) {
                console.error('Error finding driver:', error);
                showNotification('Ø®Ø·Ø§ Ø¯Ø± ÛŒØ§ÙØªÙ† Ø±Ø§Ù†Ù†Ø¯Ù‡', 'error');
            }
        }

        function showDriverInfo(driver) {
            const driverModal = document.getElementById('driverModal');
            const driverInfo = document.getElementById('driverInfo');
            
            driverInfo.innerHTML = `
                <div style="display: flex; align-items: center; gap: 20px; margin-bottom: 20px;">
                    <div style="width: 60px; height: 60px; border-radius: 50%; background: var(--gradient-primary); 
                         display: flex; align-items: center; justify-content: center; color: white; font-size: 24px;">
                        ${driver.name.charAt(0)}
                    </div>
                    <div>
                        <h3 style="margin-bottom: 5px;">${driver.name}</h3>
                        <p style="color: var(--gray);">${driver.car_model || 'Ù…ÙˆØªÙˆØ±'}</p>
                        <p style="color: var(--gray);">${driver.plate_number || ''}</p>
                    </div>
                </div>
                <p style="color: var(--primary); font-weight: bold; text-align: center;">
                    Ø²Ù…Ø§Ù† Ø±Ø³ÛŒØ¯Ù†: Ûµ Ø¯Ù‚ÛŒÙ‚Ù‡
                </p>
            `;
            
            driverModal.style.display = 'flex';
        }

        // Event Listeners
        document.addEventListener('DOMContentLoaded', async () => {
            await checkAuth();
            
            // Ø¯Ú©Ù…Ù‡ Ø´Ø±ÙˆØ¹
            document.getElementById('start-using-btn').addEventListener('click', () => {
                document.getElementById('welcome-page').style.display = 'none';
                document.getElementById('main-header').style.display = 'block';
                document.getElementById('main-container').style.display = 'block';
                document.getElementById('main-footer').style.display = 'block';
            });

            // Ø§Ù†ØªØ®Ø§Ø¨ Ù†ÙˆØ¹ Ø³ÙØ±
            document.querySelectorAll('.ride-type').forEach(type => {
                type.addEventListener('click', () => {
                    document.querySelectorAll('.ride-type').forEach(t => t.classList.remove('selected'));
                    type.classList.add('selected');
                    selectedRideType = type.dataset.type;
                });
            });

            // ÙØ±Ù… Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ø³ÙØ±
            document.getElementById('rideForm').addEventListener('submit', (e) => {
                e.preventDefault();
                
                const pickup = document.getElementById('pickup').value;
                const destination = document.getElementById('destination').value;
                
                if (!pickup || !destination) {
                    showNotification('Ù„Ø·ÙØ§Ù‹ Ù…Ø¨Ø¯Ø§ Ùˆ Ù…Ù‚ØµØ¯ Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯', 'error');
                    return;
                }
                
                requestRide(pickup, destination, selectedRideType);
            });

            // Ù…Ø¯ÛŒØ±ÛŒØª ØµÙØ­Ø§Øª
            document.querySelectorAll('.nav-link').forEach(link => {
                link.addEventListener('click', async (e) => {
                    e.preventDefault();
                    const pageId = link.getAttribute('data-page') + '-page';
                    
                    // Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ù„ÛŒÙ†Ú©â€ŒÙ‡Ø§ÛŒ ÙØ¹Ø§Ù„
                    document.querySelectorAll('.nav-link').forEach(l => l.classList.remove('active'));
                    link.classList.add('active');
                    
                    // Ù†Ù…Ø§ÛŒØ´ ØµÙØ­Ù‡ Ù…ÙˆØ±Ø¯ Ù†Ø¸Ø±
                    document.querySelectorAll('.page').forEach(page => page.classList.remove('active'));
                    document.getElementById(pageId).classList.add('active');
                    
                    // Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ÛŒ ØµÙØ­Ù‡
                    switch(pageId) {
                        case 'drivers-page':
                            await loadDrivers();
                            break;
                        case 'trips-page':
                            await loadTrips();
                            break;
                        case 'discounts-page':
                            await loadDiscounts();
                            break;
                        case 'support-page':
                            await loadSupportTickets();
                            break;
                    }
                });
            });

            // Ø®Ø±ÙˆØ¬ÛŒ Excel
            document.getElementById('exportDriversBtn')?.addEventListener('click', exportDriversToExcel);
            document.getElementById('exportTripsBtn')?.addEventListener('click', exportTripsToExcel);

            // ØªØ£ÛŒÛŒØ¯ Ø³ÙØ±
            document.getElementById('confirmRide')?.addEventListener('click', () => {
                document.getElementById('driverModal').style.display = 'none';
                showNotification('Ø³ÙØ± Ø´Ù…Ø§ Ø´Ø±ÙˆØ¹ Ø´Ø¯! Ø±Ø§Ù†Ù†Ø¯Ù‡ Ø¯Ø± Ø±Ø§Ù‡ Ø§Ø³Øª.', 'success');
                
                // Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ ÙˆØ¶Ø¹ÛŒØª Ø³ÙØ±
                if (currentTrip) {
                    updateTripStatus(currentTrip.id, 'started');
                }
            });
        });

        // Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ø¯ÙˆØ±Ù‡â€ŒØ§ÛŒ Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§
        setInterval(async () => {
            if (map) {
                await loadActiveDrivers();
            }
        }, 30000); // Ù‡Ø± 30 Ø«Ø§Ù†ÛŒÙ‡
    </script>
</body>
</html>